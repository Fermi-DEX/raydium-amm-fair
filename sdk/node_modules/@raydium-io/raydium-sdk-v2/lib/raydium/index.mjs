var Hl=Object.defineProperty,jl=Object.defineProperties;var Yl=Object.getOwnPropertyDescriptors;var zo=Object.getOwnPropertySymbols;var au=Object.prototype.hasOwnProperty,uu=Object.prototype.propertyIsEnumerable;var su=(r,e,t)=>e in r?Hl(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,M=(r,e)=>{for(var t in e||(e={}))au.call(e,t)&&su(r,t,e[t]);if(zo)for(var t of zo(e))uu.call(e,t)&&su(r,t,e[t]);return r},U=(r,e)=>jl(r,Yl(e));var De=(r,e)=>{var t={};for(var n in r)au.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&zo)for(var n of zo(r))e.indexOf(n)<0&&uu.call(r,n)&&(t[n]=r[n]);return t};import{merge as dy}from"lodash";import Qu from"axios";import{PublicKey as mu}from"@solana/web3.js";import{get as cu,set as Zl}from"lodash";var ys=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},lu={},$l={};function fe(r){let e=cu(lu,r);if(!e){let t=cu($l,r);e=new ys({name:r,logLevel:t}),Zl(lu,r,e)}return e}import{MINT_SIZE as Jl,TOKEN_PROGRAM_ID as em,getTransferFeeConfig as tm,unpackMint as nm}from"@solana/spl-token";var bs=fe("Raydium_accountInfo_util");async function Gt(r,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:o=100}=M({batchRequest:!1},t),s=gs(e,o),a=new Array(s.length).fill([]);if(n){let c=s.map(m=>{let d=r._buildArgs([m.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=gs(c,10);a=(await(await Promise.all(u.map(async m=>await r._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&bs.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:y,lamports:f,owner:b,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&bs.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:y,lamports:f,owner:new mu(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>r.getMultipleAccountsInfo(c,i)))}catch(c){c instanceof Error&&bs.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Ne(r,e,t){let n=await Gt(r,e.map(i=>i.pubkey),t);return e.map((i,o)=>U(M({},i),{accountInfo:n[o]}))}async function li({connection:r,mints:e,config:t}){var o,s,a;if(e.length===0)return{};let n=await Ne(r,e.map(c=>({pubkey:mt(c)})),t),i={};for(let c of n){if(!c.accountInfo||c.accountInfo.data.length<Jl){console.log("invalid mint account",c.pubkey.toBase58());continue}let u=nm(c.pubkey,c.accountInfo,(o=c.accountInfo)==null?void 0:o.owner);i[c.pubkey.toString()]=U(M({},u),{programId:((s=c.accountInfo)==null?void 0:s.owner)||em,feeConfig:(a=tm(u))!=null?a:void 0})}return i[mu.default.toBase58()]=i[Z.toBase58()],i}import un from"bn.js";var mi=9e15,Rn=1e9,Ps="0123456789abcdef",jo="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Yo="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",As={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-mi,maxE:mi,crypto:!1},yu,bn,le=!0,$o="[DecimalError] ",Ln=$o+"Invalid argument: ",bu=$o+"Precision limit exceeded",gu=$o+"crypto unavailable",Pu="[object Decimal]",dt=Math.floor,Je=Math.pow,im=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,om=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,rm=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,Au=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Qt=1e7,re=7,sm=9007199254740991,am=jo.length-1,ws=Yo.length-1,G={toStringTag:Pu};G.absoluteValue=G.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),ne(r)};G.ceil=function(){return ne(new this.constructor(this),this.e+1,2)};G.clampedTo=G.clamp=function(r,e){var t,n=this,i=n.constructor;if(r=new i(r),e=new i(e),!r.s||!e.s)return new i(NaN);if(r.gt(e))throw Error(Ln+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new i(n)};G.comparedTo=G.cmp=function(r){var e,t,n,i,o=this,s=o.d,a=(r=new o.constructor(r)).d,c=o.s,u=r.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(o.e!==r.e)return o.e>r.e^c<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===i?0:n>i^c<0?1:-1};G.cosine=G.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+re,n.rounding=1,t=um(n,Iu(n,t)),n.precision=r,n.rounding=e,ne(bn==2||bn==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};G.cubeRoot=G.cbrt=function(){var r,e,t,n,i,o,s,a,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(le=!1,o=l.s*Je(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=at(l.d),r=l.e,(o=(r-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=Je(t,1/3),r=dt((r+1)/3)-(r%3==(r<0?-1:2)),o==1/0?t="5e"+r:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new m(t),n.s=l.s):n=new m(o.toString()),s=(r=m.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Le(u.plus(l).times(a),u.plus(c),s+2,1),at(a.d).slice(0,s)===(t=at(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(ne(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(ne(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return le=!0,ne(n,r,m.rounding,e)};G.decimalPlaces=G.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-dt(this.e/re))*re,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};G.dividedBy=G.div=function(r){return Le(this,new this.constructor(r))};G.dividedToIntegerBy=G.divToInt=function(r){var e=this,t=e.constructor;return ne(Le(e,new t(r),0,1,1),t.precision,t.rounding)};G.equals=G.eq=function(r){return this.cmp(r)===0};G.floor=function(){return ne(new this.constructor(this),this.e+1,3)};G.greaterThan=G.gt=function(r){return this.cmp(r)>0};G.greaterThanOrEqualTo=G.gte=function(r){var e=this.cmp(r);return e==1||e===0};G.hyperbolicCosine=G.cosh=function(){var r,e,t,n,i,o=this,s=o.constructor,a=new s(1);if(!o.isFinite())return new s(o.s?1/0:NaN);if(o.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(o.e,o.sd())+4,s.rounding=1,i=o.d.length,i<32?(r=Math.ceil(i/3),e=(1/er(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),o=di(s,1,o.times(e),new s(1),!0);for(var c,u=r,l=new s(8);u--;)c=o.times(o),o=a.minus(c.times(l.minus(c.times(l))));return ne(o,s.precision=t,s.rounding=n,!0)};G.hyperbolicSine=G.sinh=function(){var r,e,t,n,i=this,o=i.constructor;if(!i.isFinite()||i.isZero())return new o(i);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(i.e,i.sd())+4,o.rounding=1,n=i.d.length,n<3)i=di(o,2,i,i,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,i=i.times(1/er(5,r)),i=di(o,2,i,i,!0);for(var s,a=new o(5),c=new o(16),u=new o(20);r--;)s=i.times(i),i=i.times(a.plus(s.times(c.times(s).plus(u))))}return o.precision=e,o.rounding=t,ne(i,e,t,!0)};G.hyperbolicTangent=G.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,Le(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};G.inverseCosine=G.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?Xt(t,i,o):new t(0):new t(NaN):e.isZero()?Xt(t,i+4,o).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),r=Xt(t,i+4,o).times(.5),t.precision=i,t.rounding=o,r.minus(e))};G.inverseHyperbolicCosine=G.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,le=!1,t=t.times(t).minus(1).sqrt().plus(t),le=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};G.inverseHyperbolicSine=G.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,le=!1,t=t.times(t).plus(1).sqrt().plus(t),le=!0,n.precision=r,n.rounding=e,t.ln())};G.inverseHyperbolicTangent=G.atanh=function(){var r,e,t,n,i=this,o=i.constructor;return i.isFinite()?i.e>=0?new o(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(r=o.precision,e=o.rounding,n=i.sd(),Math.max(n,r)<2*-i.e-1?ne(new o(i),r,e,!0):(o.precision=t=n-i.e,i=Le(i.plus(1),new o(1).minus(i),t+r,1),o.precision=r+4,o.rounding=1,i=i.ln(),o.precision=r,o.rounding=e,i.times(.5))):new o(NaN)};G.inverseSine=G.asin=function(){var r,e,t,n,i=this,o=i.constructor;return i.isZero()?new o(i):(e=i.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(r=Xt(o,t+4,n).times(.5),r.s=i.s,r):new o(NaN):(o.precision=t+6,o.rounding=1,i=i.div(new o(1).minus(i.times(i)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,i.times(2)))};G.inverseTangent=G.atan=function(){var r,e,t,n,i,o,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=ws)return s=Xt(l,m+4,d).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(m+4<=ws)return s=Xt(l,m+4,d).times(.5),s.s=u.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/re+2|0),r=t;r;--r)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(le=!1,e=Math.ceil(a/re),n=1,c=u.times(u),s=new l(u),i=u;r!==-1;)if(i=i.times(c),o=s.minus(i.div(n+=2)),i=i.times(c),s=o.plus(i.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===o.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),le=!0,ne(s,l.precision=m,l.rounding=d,!0)};G.isFinite=function(){return!!this.d};G.isInteger=G.isInt=function(){return!!this.d&&dt(this.e/re)>this.d.length-2};G.isNaN=function(){return!this.s};G.isNegative=G.isNeg=function(){return this.s<0};G.isPositive=G.isPos=function(){return this.s>0};G.isZero=function(){return!!this.d&&this.d[0]===0};G.lessThan=G.lt=function(r){return this.cmp(r)<0};G.lessThanOrEqualTo=G.lte=function(r){return this.cmp(r)<1};G.logarithm=G.log=function(r){var e,t,n,i,o,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(i=t[0];i%10===0;)i/=10;o=i!==1}if(le=!1,a=m+p,s=Cn(u,a),n=e?Zo(l,a+10):Cn(r,a),c=Le(s,n,a,1),_i(c.d,i=m,d))do if(a+=10,s=Cn(u,a),n=e?Zo(l,a+10):Cn(r,a),c=Le(s,n,a,1),!o){+at(c.d).slice(i+1,i+15)+1==1e14&&(c=ne(c,m+1,0));break}while(_i(c.d,i+=10,d));return le=!0,ne(c,m,d)};G.minus=G.sub=function(r){var e,t,n,i,o,s,a,c,u,l,m,d,p=this,y=p.constructor;if(r=new y(r),!p.d||!r.d)return!p.s||!r.s?r=new y(NaN):p.d?r.s=-r.s:r=new y(r.d||p.s!==r.s?p:NaN),r;if(p.s!=r.s)return r.s=-r.s,p.plus(r);if(u=p.d,d=r.d,a=y.precision,c=y.rounding,!u[0]||!d[0]){if(d[0])r.s=-r.s;else if(u[0])r=new y(p);else return new y(c===3?-0:0);return le?ne(r,a,c):r}if(t=dt(r.e/re),l=dt(p.e/re),u=u.slice(),o=l-t,o){for(m=o<0,m?(e=u,o=-o,s=d.length):(e=d,t=l,s=u.length),n=Math.max(Math.ceil(a/re),s)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}o=0}for(m&&(e=u,u=d,d=e,r.s=-r.s),s=u.length,n=d.length-s;n>0;--n)u[s++]=0;for(n=d.length;n>o;){if(u[--n]<d[n]){for(i=n;i&&u[--i]===0;)u[i]=Qt-1;--u[i],u[n]+=Qt}u[n]-=d[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(r.d=u,r.e=Jo(u,t),le?ne(r,a,c):r):new y(c===3?-0:0)};G.modulo=G.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?ne(new n(t),n.precision,n.rounding):(le=!1,n.modulo==9?(e=Le(t,r.abs(),0,3,1),e.s*=r.s):e=Le(t,r,0,n.modulo,1),e=e.times(r),le=!0,t.minus(e))};G.naturalExponential=G.exp=function(){return ks(this)};G.naturalLogarithm=G.ln=function(){return Cn(this)};G.negated=G.neg=function(){var r=new this.constructor(this);return r.s=-r.s,ne(r)};G.plus=G.add=function(r){var e,t,n,i,o,s,a,c,u,l,m=this,d=m.constructor;if(r=new d(r),!m.d||!r.d)return!m.s||!r.s?r=new d(NaN):m.d||(r=new d(r.d||m.s===r.s?m:NaN)),r;if(m.s!=r.s)return r.s=-r.s,m.minus(r);if(u=m.d,l=r.d,a=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(r=new d(m)),le?ne(r,a,c):r;if(o=dt(m.e/re),n=dt(r.e/re),u=u.slice(),i=o-n,i){for(i<0?(t=u,i=-i,s=l.length):(t=l,n=o,s=u.length),o=Math.ceil(a/re),s=o>s?o+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=u.length,i=l.length,s-i<0&&(i=s,t=l,l=u,u=t),e=0;i;)e=(u[--i]=u[i]+l[i]+e)/Qt|0,u[i]%=Qt;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return r.d=u,r.e=Jo(u,n),le?ne(r,a,c):r};G.precision=G.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(Ln+r);return t.d?(e=wu(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};G.round=function(){var r=this,e=r.constructor;return ne(new e(r),r.e+1,e.rounding)};G.sine=G.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+re,n.rounding=1,t=lm(n,Iu(n,t)),n.precision=r,n.rounding=e,ne(bn>2?t.neg():t,r,e,!0)):new n(NaN)};G.squareRoot=G.sqrt=function(){var r,e,t,n,i,o,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(le=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=at(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=dt((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(o=n,n=o.plus(Le(s,o,t+2,1)).times(.5),at(o.d).slice(0,t)===(e=at(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(ne(o,c+1,0),o.times(o).eq(s))){n=o;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(ne(n,c+1,1),r=!n.times(n).eq(s));break}return le=!0,ne(n,c,l.rounding,r)};G.tangent=G.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=Le(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,ne(bn==2||bn==4?t.neg():t,r,e,!0)):new n(NaN)};G.times=G.mul=function(r){var e,t,n,i,o,s,a,c,u,l=this,m=l.constructor,d=l.d,p=(r=new m(r)).d;if(r.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!r.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?r.s/0:r.s*0);for(t=dt(l.e/re)+dt(r.e/re),c=d.length,u=p.length,c<u&&(o=d,d=p,p=o,s=c,c=u,u=s),o=[],s=c+u,n=s;n--;)o.push(0);for(n=u;--n>=0;){for(e=0,i=c+n;i>n;)a=o[i]+p[n]*d[i-n-1]+e,o[i--]=a%Qt|0,e=a/Qt|0;o[i]=(o[i]+e)%Qt|0}for(;!o[--s];)o.pop();return e?++t:o.shift(),r.d=o,r.e=Jo(o,t),le?ne(r,m.precision,m.rounding):r};G.toBinary=function(r,e){return Ts(this,2,r,e)};G.toDecimalPlaces=G.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(Bt(r,0,Rn),e===void 0?e=n.rounding:Bt(e,0,8),ne(t,r+t.e+1,e))};G.toExponential=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=rn(n,!0):(Bt(r,0,Rn),e===void 0?e=i.rounding:Bt(e,0,8),n=ne(new i(n),r+1,e),t=rn(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};G.toFixed=function(r,e){var t,n,i=this,o=i.constructor;return r===void 0?t=rn(i):(Bt(r,0,Rn),e===void 0?e=o.rounding:Bt(e,0,8),n=ne(new o(i),r+i.e+1,e),t=rn(n,!1,r+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};G.toFraction=function(r){var e,t,n,i,o,s,a,c,u,l,m,d,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),o=e.e=wu(y)-p.e-1,s=o%re,e.d[0]=Je(10,s<0?re+s:s),r==null)r=o>0?e:u;else{if(a=new f(r),!a.isInt()||a.lt(u))throw Error(Ln+a);r=a.gt(e)?o>0?e:u:a}for(le=!1,a=new f(at(y)),l=f.precision,f.precision=o=y.length*re*2;m=Le(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(r)!=1;)t=n,n=i,i=u,u=c.plus(m.times(i)),c=i,i=e,e=a.minus(m.times(i)),a=i;return i=Le(r.minus(t),n,0,1,1),c=c.plus(i.times(u)),t=t.plus(i.times(n)),c.s=u.s=p.s,d=Le(u,n,o,1).minus(p).abs().cmp(Le(c,t,o,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,le=!0,d};G.toHexadecimal=G.toHex=function(r,e){return Ts(this,16,r,e)};G.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:Bt(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(le=!1,t=Le(t,r,0,e,1).times(r),le=!0,ne(t)):(r.s=t.s,t=r),t};G.toNumber=function(){return+this};G.toOctal=function(r,e){return Ts(this,8,r,e)};G.toPower=G.pow=function(r){var e,t,n,i,o,s,a=this,c=a.constructor,u=+(r=new c(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new c(Je(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,o=c.rounding,r.eq(1))return ne(a,n,o);if(e=dt(r.e/re),e>=r.d.length-1&&(t=u<0?-u:u)<=sm)return i=ku(c,a,t,n),r.s<0?new c(1).div(i):ne(i,n,o);if(s=a.s,s<0){if(e<r.d.length-1)return new c(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Je(+a,u),e=t==0||!isFinite(t)?dt(u*(Math.log("0."+at(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(le=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),i=ks(r.times(Cn(a,n+t)),n),i.d&&(i=ne(i,n+5,1),_i(i.d,n,o)&&(e=n+10,i=ne(ks(r.times(Cn(a,e+t)),e),e+5,1),+at(i.d).slice(n+1,n+15)+1==1e14&&(i=ne(i,n+1,0)))),i.s=s,le=!0,c.rounding=o,ne(i,n,o))};G.toPrecision=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=rn(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(Bt(r,1,Rn),e===void 0?e=i.rounding:Bt(e,0,8),n=ne(new i(n),r,e),t=rn(n,r<=n.e||n.e<=i.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};G.toSignificantDigits=G.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(Bt(r,1,Rn),e===void 0?e=n.rounding:Bt(e,0,8)),ne(new n(t),r,e)};G.toString=function(){var r=this,e=r.constructor,t=rn(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};G.truncated=G.trunc=function(){return ne(new this.constructor(this),this.e+1,1)};G.valueOf=G.toJSON=function(){var r=this,e=r.constructor,t=rn(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function at(r){var e,t,n,i=r.length-1,o="",s=r[0];if(i>0){for(o+=s,e=1;e<i;e++)n=r[e]+"",t=re-n.length,t&&(o+=Kn(t)),o+=n;s=r[e],n=s+"",t=re-n.length,t&&(o+=Kn(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return o+s}function Bt(r,e,t){if(r!==~~r||r<e||r>t)throw Error(Ln+r)}function _i(r,e,t,n){var i,o,s,a;for(o=r[0];o>=10;o/=10)--e;return--e<0?(e+=re,i=0):(i=Math.ceil((e+1)/re),e%=re),o=Je(10,re-e),a=r[i]%o|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==o||t>3&&a+1==o/2)&&(r[i+1]/o/100|0)==Je(10,e-2)-1||(a==o/2||a==0)&&(r[i+1]/o/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==o||!n&&t>3&&a+1==o/2)&&(r[i+1]/o/1e3|0)==Je(10,e-3)-1,s}function Ho(r,e,t){for(var n,i=[0],o,s=0,a=r.length;s<a;){for(o=i.length;o--;)i[o]*=e;for(i[0]+=Ps.indexOf(r.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function um(r,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/er(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),r.precision+=t,e=di(r,1,e.times(i),new r(1));for(var o=t;o--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var Le=function(){function r(n,i,o){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*i+a,n[c]=s%o|0,a=s/o|0;return a&&n.unshift(a),n}function e(n,i,o,s){var a,c;if(o!=s)c=o>s?1:-1;else for(a=c=0;a<o;a++)if(n[a]!=i[a]){c=n[a]>i[a]?1:-1;break}return c}function t(n,i,o,s){for(var a=0;o--;)n[o]-=a,a=n[o]<i[o]?1:0,n[o]=a*s+n[o]-i[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,o,s,a,c){var u,l,m,d,p,y,f,b,g,A,k,T,I,h,S,x,C,B,K,L,R=n.constructor,V=n.s==i.s?1:-1,_=n.d,W=i.d;if(!_||!_[0]||!W||!W[0])return new R(!n.s||!i.s||(_?W&&_[0]==W[0]:!W)?NaN:_&&_[0]==0||!W?V*0:V/0);for(c?(p=1,l=n.e-i.e):(c=Qt,p=re,l=dt(n.e/p)-dt(i.e/p)),K=W.length,C=_.length,g=new R(V),A=g.d=[],m=0;W[m]==(_[m]||0);m++);if(W[m]>(_[m]||0)&&l--,o==null?(h=o=R.precision,s=R.rounding):a?h=o+(n.e-i.e)+1:h=o,h<0)A.push(1),y=!0;else{if(h=h/p+2|0,m=0,K==1){for(d=0,W=W[0],h++;(m<C||d)&&h--;m++)S=d*c+(_[m]||0),A[m]=S/W|0,d=S%W|0;y=d||m<C}else{for(d=c/(W[0]+1)|0,d>1&&(W=r(W,d,c),_=r(_,d,c),K=W.length,C=_.length),x=K,k=_.slice(0,K),T=k.length;T<K;)k[T++]=0;L=W.slice(),L.unshift(0),B=W[0],W[1]>=c/2&&++B;do d=0,u=e(W,k,K,T),u<0?(I=k[0],K!=T&&(I=I*c+(k[1]||0)),d=I/B|0,d>1?(d>=c&&(d=c-1),f=r(W,d,c),b=f.length,T=k.length,u=e(f,k,b,T),u==1&&(d--,t(f,K<b?L:W,b,c))):(d==0&&(u=d=1),f=W.slice()),b=f.length,b<T&&f.unshift(0),t(k,f,T,c),u==-1&&(T=k.length,u=e(W,k,K,T),u<1&&(d++,t(k,K<T?L:W,T,c))),T=k.length):u===0&&(d++,k=[0]),A[m++]=d,u&&k[0]?k[T++]=_[x]||0:(k=[_[x]],T=1);while((x++<C||k[0]!==void 0)&&h--);y=k[0]!==void 0}A[0]||A.shift()}if(p==1)g.e=l,yu=y;else{for(m=1,d=A[0];d>=10;d/=10)m++;g.e=m+l*p-1,ne(g,a?o+g.e+1:o,s,y)}return g}}();function ne(r,e,t,n){var i,o,s,a,c,u,l,m,d,p=r.constructor;e:if(e!=null){if(m=r.d,!m)return r;for(i=1,a=m[0];a>=10;a/=10)i++;if(o=e-i,o<0)o+=re,s=e,l=m[d=0],c=l/Je(10,i-s-1)%10|0;else if(d=Math.ceil((o+1)/re),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=c=0,i=1,o%=re,s=o-re+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;o%=re,s=o-re+i,c=s<0?0:l/Je(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Je(10,i-s-1)),u=t<4?(c||n)&&(t==0||t==(r.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(o>0?s>0?l/Je(10,i-s):0:m[d-1])%10&1||t==(r.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=r.e+1,m[0]=Je(10,(re-e%re)%re),r.e=-e||0):m[0]=r.e=0,r;if(o==0?(m.length=d,a=1,d--):(m.length=d+1,a=Je(10,re-o),m[d]=s>0?(l/Je(10,i-s)%Je(10,s)|0)*a:0),u)for(;;)if(d==0){for(o=1,s=m[0];s>=10;s/=10)o++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;o!=a&&(r.e++,m[0]==Qt&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Qt)break;m[d--]=0,a=1}for(o=m.length;m[--o]===0;)m.pop()}return le&&(r.e>p.maxE?(r.d=null,r.e=NaN):r.e<p.minE&&(r.e=0,r.d=[0])),r}function rn(r,e,t){if(!r.isFinite())return Tu(r);var n,i=r.e,o=at(r.d),s=o.length;return e?(t&&(n=t-s)>0?o=o.charAt(0)+"."+o.slice(1)+Kn(n):s>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(r.e<0?"e":"e+")+r.e):i<0?(o="0."+Kn(-i-1)+o,t&&(n=t-s)>0&&(o+=Kn(n))):i>=s?(o+=Kn(i+1-s),t&&(n=t-i-1)>0&&(o=o+"."+Kn(n))):((n=i+1)<s&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(o+="."),o+=Kn(n))),o}function Jo(r,e){var t=r[0];for(e*=re;t>=10;t/=10)e++;return e}function Zo(r,e,t){if(e>am)throw le=!0,t&&(r.precision=t),Error(bu);return ne(new r(jo),e,1,!0)}function Xt(r,e,t){if(e>ws)throw Error(bu);return ne(new r(Yo),e,t,!0)}function wu(r){var e=r.length-1,t=e*re+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function Kn(r){for(var e="";r--;)e+="0";return e}function ku(r,e,t,n){var i,o=new r(1),s=Math.ceil(n/re+4);for(le=!1;;){if(t%2&&(o=o.times(e),pu(o.d,s)&&(i=!0)),t=dt(t/2),t===0){t=o.d.length-1,i&&o.d[t]===0&&++o.d[t];break}e=e.times(e),pu(e.d,s)}return le=!0,o}function du(r){return r.d[r.d.length-1]&1}function hu(r,e,t){for(var n,i=new r(e[0]),o=0;++o<e.length;)if(n=new r(e[o]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function ks(r,e){var t,n,i,o,s,a,c,u=0,l=0,m=0,d=r.constructor,p=d.rounding,y=d.precision;if(!r.d||!r.d[0]||r.e>17)return new d(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(le=!1,c=y):c=e,a=new d(.03125);r.e>-2;)r=r.times(a),m+=5;for(n=Math.log(Je(2,m))/Math.LN10*2+5|0,c+=n,t=o=s=new d(1),d.precision=c;;){if(o=ne(o.times(r),c,1),t=t.times(++l),a=s.plus(Le(o,t,c,1)),at(a.d).slice(0,c)===at(s.d).slice(0,c)){for(i=m;i--;)s=ne(s.times(s),c,1);if(e==null)if(u<3&&_i(s.d,c-n,p,u))d.precision=c+=10,t=o=a=new d(1),l=0,u++;else return ne(s,d.precision=y,p,le=!0);else return d.precision=y,s}s=a}}function Cn(r,e){var t,n,i,o,s,a,c,u,l,m,d,p=1,y=10,f=r,b=f.d,g=f.constructor,A=g.rounding,k=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(le=!1,l=k):l=e,g.precision=l+=y,t=at(b),n=t.charAt(0),Math.abs(o=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(r),t=at(f.d),n=t.charAt(0),p++;o=f.e,n>1?(f=new g("0."+t),o++):f=new g(n+"."+t.slice(1))}else return u=Zo(g,l+2,k).times(o+""),f=Cn(new g(n+"."+t.slice(1)),l-y).plus(u),g.precision=k,e==null?ne(f,k,A,le=!0):f;for(m=f,c=s=f=Le(f.minus(1),f.plus(1),l,1),d=ne(f.times(f),l,1),i=3;;){if(s=ne(s.times(d),l,1),u=c.plus(Le(s,new g(i),l,1)),at(u.d).slice(0,l)===at(c.d).slice(0,l))if(c=c.times(2),o!==0&&(c=c.plus(Zo(g,l+2,k).times(o+""))),c=Le(c,new g(p),l,1),e==null)if(_i(c.d,l-y,A,a))g.precision=l+=y,u=s=f=Le(m.minus(1),m.plus(1),l,1),d=ne(f.times(f),l,1),i=a=1;else return ne(c,g.precision=k,A,le=!0);else return g.precision=k,c;c=u,i+=2}}function Tu(r){return String(r.s*r.s/0)}function hs(r,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%re,t<0&&(n+=re),n<i){for(n&&r.d.push(+e.slice(0,n)),i-=re;n<i;)r.d.push(+e.slice(n,n+=re));e=e.slice(n),n=re-e.length}else n-=i;for(;n--;)e+="0";r.d.push(+e),le&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function cm(r,e){var t,n,i,o,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),Au.test(e))return hs(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(om.test(e))t=16,e=e.toLowerCase();else if(im.test(e))t=2;else if(rm.test(e))t=8;else throw Error(Ln+e);for(o=e.search(/p/i),o>0?(c=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),s=o>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,o=a-o,i=ku(n,new n(t),o,o*2)),u=Ho(e,t,Qt),l=u.length-1,o=l;u[o]===0;--o)u.pop();return o<0?new n(r.s*0):(r.e=Jo(u,l),r.d=u,le=!1,s&&(r=Le(r,i,a*4)),c&&(r=r.times(Math.abs(c)<54?Je(2,c):Vi.pow(2,c))),le=!0,r)}function lm(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:di(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/er(5,t)),e=di(r,2,e,e);for(var i,o=new r(5),s=new r(16),a=new r(20);t--;)i=e.times(e),e=e.times(o.plus(i.times(s.times(i).minus(a))));return e}function di(r,e,t,n,i){var o,s,a,c,u=1,l=r.precision,m=Math.ceil(l/re);for(le=!1,c=t.times(t),a=new r(n);;){if(s=Le(a.times(c),new r(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=Le(s.times(c),new r(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(o=m;s.d[o]===a.d[o]&&o--;);if(o==-1)break}o=a,a=n,n=s,s=o,u++}return le=!0,s.d.length=m+1,s}function er(r,e){for(var t=r;--e;)t*=r;return t}function Iu(r,e){var t,n=e.s<0,i=Xt(r,r.precision,1),o=i.times(.5);if(e=e.abs(),e.lte(o))return bn=n?4:1,e;if(t=e.divToInt(i),t.isZero())bn=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(o))return bn=du(t)?n?2:3:n?4:1,e;bn=du(t)?n?1:4:n?3:2}return e.minus(i).abs()}function Ts(r,e,t,n){var i,o,s,a,c,u,l,m,d,p=r.constructor,y=t!==void 0;if(y?(Bt(t,1,Rn),n===void 0?n=p.rounding:Bt(n,0,8)):(t=p.precision,n=p.rounding),!r.isFinite())l=Tu(r);else{for(l=rn(r),s=l.indexOf("."),y?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Ho(rn(d),10,i),d.e=d.d.length),m=Ho(l,10,i),o=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=y?"0p+0":"0";else{if(s<0?o--:(r=new p(r),r.d=m,r.e=o,r=Le(r,d,t,n,0,i),m=r.d,o=r.e,u=yu),s=m[t],a=i/2,u=u||m[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&m[t-1]&1||n===(r.s<0?8:7)),m.length=t,u)for(;++m[--t]>i-1;)m[t]=0,t||(++o,m.unshift(1));for(c=m.length;!m[c-1];--c);for(s=0,l="";s<c;s++)l+=Ps.charAt(m[s]);if(y){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(m=Ho(l,i,e),c=m.length;!m[c-1];--c);for(s=1,l="1.";s<c;s++)l+=Ps.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>c)for(o-=c;o--;)l+="0";else o<c&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function pu(r,e){if(r.length>e)return r.length=e,!0}function mm(r){return new this(r).abs()}function dm(r){return new this(r).acos()}function pm(r){return new this(r).acosh()}function fm(r,e){return new this(r).plus(e)}function ym(r){return new this(r).asin()}function bm(r){return new this(r).asinh()}function gm(r){return new this(r).atan()}function Pm(r){return new this(r).atanh()}function Am(r,e){r=new this(r),e=new this(e);var t,n=this.precision,i=this.rounding,o=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=Xt(this,o,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?Xt(this,n,i):new this(0),t.s=r.s):!r.d||e.isZero()?(t=Xt(this,o,1).times(.5),t.s=r.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(Le(r,e,o,1)),e=Xt(this,o,1),this.precision=n,this.rounding=i,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(Le(r,e,o,1)),t}function wm(r){return new this(r).cbrt()}function km(r){return ne(r=new this(r),r.e+1,2)}function hm(r,e,t){return new this(r).clamp(e,t)}function Tm(r){if(!r||typeof r!="object")throw Error($o+"Object expected");var e,t,n,i=r.defaults===!0,o=["precision",1,Rn,"rounding",0,8,"toExpNeg",-mi,0,"toExpPos",0,mi,"maxE",0,mi,"minE",-mi,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],i&&(this[t]=As[t]),(n=r[t])!==void 0)if(dt(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(Ln+t+": "+n);if(t="crypto",i&&(this[t]=As[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(gu);else this[t]=!1;else throw Error(Ln+t+": "+n);return this}function Im(r){return new this(r).cos()}function Bm(r){return new this(r).cosh()}function Bu(r){var e,t,n;function i(o){var s,a,c,u=this;if(!(u instanceof i))return new i(o);if(u.constructor=i,fu(o)){u.s=o.s,le?!o.d||o.e>i.maxE?(u.e=NaN,u.d=null):o.e<i.minE?(u.e=0,u.d=[0]):(u.e=o.e,u.d=o.d.slice()):(u.e=o.e,u.d=o.d?o.d.slice():o.d);return}if(c=typeof o,c==="number"){if(o===0){u.s=1/o<0?-1:1,u.e=0,u.d=[0];return}if(o<0?(o=-o,u.s=-1):u.s=1,o===~~o&&o<1e7){for(s=0,a=o;a>=10;a/=10)s++;le?s>i.maxE?(u.e=NaN,u.d=null):s<i.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[o]):(u.e=s,u.d=[o]);return}else if(o*0!==0){o||(u.s=NaN),u.e=NaN,u.d=null;return}return hs(u,o.toString())}else if(c!=="string")throw Error(Ln+o);return(a=o.charCodeAt(0))===45?(o=o.slice(1),u.s=-1):(a===43&&(o=o.slice(1)),u.s=1),Au.test(o)?hs(u,o):cm(u,o)}if(i.prototype=G,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Tm,i.clone=Bu,i.isDecimal=fu,i.abs=mm,i.acos=dm,i.acosh=pm,i.add=fm,i.asin=ym,i.asinh=bm,i.atan=gm,i.atanh=Pm,i.atan2=Am,i.cbrt=wm,i.ceil=km,i.clamp=hm,i.cos=Im,i.cosh=Bm,i.div=xm,i.exp=Sm,i.floor=Km,i.hypot=Cm,i.ln=Lm,i.log=Rm,i.log10=Om,i.log2=Nm,i.max=Mm,i.min=vm,i.mod=Em,i.mul=_m,i.pow=Vm,i.random=Fm,i.round=Dm,i.sign=Wm,i.sin=qm,i.sinh=Um,i.sqrt=Gm,i.sub=Xm,i.sum=Qm,i.tan=zm,i.tanh=Hm,i.trunc=jm,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return i.config(r),i}function xm(r,e){return new this(r).div(e)}function Sm(r){return new this(r).exp()}function Km(r){return ne(r=new this(r),r.e+1,3)}function Cm(){var r,e,t=new this(0);for(le=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return le=!0,new this(1/0);t=e}return le=!0,t.sqrt()}function fu(r){return r instanceof Vi||r&&r.toStringTag===Pu||!1}function Lm(r){return new this(r).ln()}function Rm(r,e){return new this(r).log(e)}function Nm(r){return new this(r).log(2)}function Om(r){return new this(r).log(10)}function Mm(){return hu(this,arguments,"lt")}function vm(){return hu(this,arguments,"gt")}function Em(r,e){return new this(r).mod(e)}function _m(r,e){return new this(r).mul(e)}function Vm(r,e){return new this(r).pow(e)}function Fm(r){var e,t,n,i,o=0,s=new this(1),a=[];if(r===void 0?r=this.precision:Bt(r,1,Rn),n=Math.ceil(r/re),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)i=e[o],i>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:a[o++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)i=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,o):(a.push(i%1e7),o+=4);o=n/4}else throw Error(gu);else for(;o<n;)a[o++]=Math.random()*1e7|0;for(n=a[--o],r%=re,n&&r&&(i=Je(10,re-r),a[o]=(n/i|0)*i);a[o]===0;o--)a.pop();if(o<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=re)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<re&&(t-=re-n)}return s.e=t,s.d=a,s}function Dm(r){return ne(r=new this(r),r.e+1,this.rounding)}function Wm(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function qm(r){return new this(r).sin()}function Um(r){return new this(r).sinh()}function Gm(r){return new this(r).sqrt()}function Xm(r,e){return new this(r).sub(e)}function Qm(){var r=0,e=arguments,t=new this(e[r]);for(le=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return le=!0,ne(t,this.precision,this.rounding)}function zm(r){return new this(r).tan()}function Hm(r){return new this(r).tanh()}function jm(r){return ne(r=new this(r),r.e+1,1)}G[Symbol.for("nodejs.util.inspect.custom")]=G.toString;G[Symbol.toStringTag]="Decimal";var Vi=G.constructor=Bu(As);jo=new Vi(jo);Yo=new Vi(Yo);var O=Vi;import id from"big.js";import ir from"bn.js";import Ym from"toformat";var Zm=Ym,Fi=Zm;import nr from"big.js";import Jm from"bn.js";import ed from"decimal.js-light";import Di from"bn.js";var xu=9007199254740991;function ee(r){let e=fe("Raydium_parseBigNumberish");if(r instanceof Di)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new Di(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=xu||r<=-xu)&&e.logWithError(`BigNumberish number overflow: ${r}`),new Di(String(r))):typeof r=="bigint"?new Di(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new Di(0))}var tr=fe("module/fraction"),Is=Fi(nr),Wi=Fi(ed),td={[0]:Wi.ROUND_DOWN,[1]:Wi.ROUND_HALF_UP,[2]:Wi.ROUND_UP},nd={[0]:nr.roundDown,[1]:nr.roundHalfUp,[2]:nr.roundUp},ke=class{constructor(e,t=new Jm(1)){this.numerator=ee(e),this.denominator=ee(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new ke(this.denominator,this.numerator)}add(e){let t=e instanceof ke?e:new ke(ee(e));return this.denominator.eq(t.denominator)?new ke(this.numerator.add(t.numerator),this.denominator):new ke(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof ke?e:new ke(ee(e));return this.denominator.eq(t.denominator)?new ke(this.numerator.sub(t.numerator),this.denominator):new ke(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof ke?e:new ke(ee(e));return new ke(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof ke?e:new ke(ee(e));return new ke(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||tr.logWithError(`${e} is not an integer.`),e<=0&&tr.logWithError(`${e} is not positive.`),Wi.set({precision:e+1,rounding:td[n]});let i=new Wi(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||tr.logWithError(`${e} is not an integer.`),e<0&&tr.logWithError(`${e} is negative.`),Is.DP=e,Is.RM=nd[n]||1,new Is(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var od=fe("Raydium_amount"),Su=Fi(id);function rd(r,e){let t="0",n="0";if(r.includes(".")){let i=r.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):od.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var Be=class extends ke{constructor(t,n,i=!0,o){let s=new ir(0),a=Bs.pow(new ir(t.decimals));if(i)s=ee(n);else{let c=new ir(0),u=new ir(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=rd(n.toString(),t.decimals);c=ee(l),u=ee(m)}c=c.mul(a),s=c.add(u)}super(s,a);this.logger=fe(o||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new Be(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new Be(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return Su.DP=this.token.decimals,new Su(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as sd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ku}from"@solana/spl-token";var sn={chainId:101,address:sd.default.toBase58(),programId:Ku.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},nt={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Ku.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as Ls}from"@solana/web3.js";import{PublicKey as _e,SystemProgram as Cu,SYSVAR_RENT_PUBKEY as ad}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ud}from"@solana/spl-token";function P({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var xs=[P({pubkey:ud,isWritable:!1}),P({pubkey:Cu.programId,isWritable:!1}),P({pubkey:ad,isWritable:!1})];function Ss({publicKey:r,transformSol:e}){let t=Ks(r.toString());if(t instanceof _e)return e&&t.equals(it)?Z:t;if(e&&t.toString()===it.toBase58())return Z;if(typeof t=="string"){if(t===_e.default.toBase58())return _e.default;try{return new _e(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Ks(r){try{return new _e(r)}catch{return r}}var or=new _e("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),an=new _e("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),je=new _e("SysvarRent111111111111111111111111111111111"),Cs=new _e("SysvarC1ock11111111111111111111111111111111"),zt=new _e("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),rr=new _e("Sysvar1nstructions1111111111111111111111111"),sr=Cu.programId,tb=new _e("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),nb=new _e("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),ib=new _e("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),ob=new _e("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),rb=new _e("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),sb=new _e("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ab=new _e("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),ub=new _e("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),cb=new _e("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),lb=new _e("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),mb=new _e("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),Z=new _e("So11111111111111111111111111111111111111112"),it=_e.default;function mt(r){return Ss({publicKey:r,transformSol:!0})}var Rs=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:o=!1,isToken2022:s=!1}){if(e===it.toBase58()||e instanceof Ls&&it.equals(e)){this.decimals=nt.decimals,this.symbol=nt.symbol,this.name=nt.name,this.mint=new Ls(nt.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=o?Ls.default:Ss({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Ve=Rs;Ve.WSOL=new Rs(U(M({},nt),{mint:nt.address}));var Ns=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},ar=Ns;ar.SOL=new Ns(sn);import cd from"bn.js";var Lu=new ke(new cd(100)),ot=class extends ke{toSignificant(e=5,t,n){return this.mul(Lu).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Lu).toFixed(e,t,n)}};var ld=fe("Raydium_price"),xt=class extends ke{constructor(t){let{baseToken:n,quoteToken:i,numerator:o,denominator:s}=t;super(o,s);this.baseToken=n,this.quoteToken=i,this.scalar=new ke(Os(n.decimals),Os(i.decimals))}get raw(){return new ke(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new xt({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&ld.logWithError("mul token not equals");let n=super.mul(t);return new xt({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};import{PublicKey as md}from"@solana/web3.js";import dd from"bn.js";function Ru(r){return typeof r=="object"&&r!==null&&![Ve,Be,md,ke,dd,xt,ot].some(e=>typeof e=="object"&&r instanceof e)}function Oe(r){return typeof r=="string"?Ks(r):Array.isArray(r)?r.map(e=>Oe(e)):Ru(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>[e,Oe(t)])):r}var St=new un(0),Nu=new un(1),sg=new un(2),ag=new un(3),ug=new un(5),Bs=new un(10),cg=new un(100),lg=new un(1e3),mg=new un(1e4);function Os(r){return Bs.pow(ee(r))}function ur(r,e){let t=r.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function cr(r,e,t){return r.mul(e).add(t).sub(new un(1)).div(t)}function Ms(r,e,t){return r.mul(e).div(t)}var Ou=r=>typeof r=="number";function Mu(r,e,t){let n=Ou(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(r).getTime()<=n}function vu(r,e,t){let n=Ou(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(r).getTime()>n}function gs(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Ht=class{constructor(e){this._owner=e}get publicKey(){return Ht.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Ht.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Ht.isKeyPair(this._owner)}get isPublicKey(){return Ht.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Ht.isKeyPair(e)}};import{PublicKey as Pd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ad}from"@solana/spl-token";import{ComputeBudgetProgram as Eu,Keypair as _u,PublicKey as Vu,Transaction as lr,TransactionMessage as pd,VersionedTransaction as Fu}from"@solana/web3.js";var X={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip"};import{TOKEN_PROGRAM_ID as fd}from"@solana/spl-token";var gn=fe("Raydium_txUtil"),Du=1644;function mr(r){let e=[],t=[];return r.microLamports&&(e.push(Eu.setComputeUnitPrice({microLamports:r.microLamports})),t.push(X.SetComputeUnitPrice)),r.units&&(e.push(Eu.setComputeUnitLimit({units:r.units})),t.push(X.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function pi(r,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=r.getLatestBlockhash)==null?void 0:n.call(r,{commitment:t})))==null?void 0:i.blockhash}async function dr(r,e){return r.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);r.onSignature(e,o=>{if(clearTimeout(i),!o.err){t("");return}n(Object.assign(o.err,{txId:e}))},"confirmed")})}function pr(r,e){r.length<1&&gn.logWithError(`no instructions provided: ${r.toString()}`),e.length<1&&gn.logWithError(`no signers provided:, ${e.toString()}`);let t=new lr;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...r);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Du}catch{return!1}}async function Wu(r,e,t,n=!0){let i=new Vu("RaydiumSimuLateTransaction11111111111111111"),o=[],s=new lr;s.feePayer=i;for(let u of e)pr([...s.instructions,u],[i])||(o.push(s),s=new lr,s.feePayer=i),s.add(u);s.instructions.length>0&&o.push(s);let a=[];try{if(a=await yd(r,o,n),a.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&gn.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of a)if(gn.debug("simulate result:",u),u.logs){let l=u.logs.filter(m=>m&&m.includes(t));gn.debug("filteredLog:",c),l.length||gn.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function qu(r,e){let t=r.match(/{["\w:,]+}/g);return!t||t.length!==1?gn.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function Pn(r,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(r);return!n||n.length!==2?gn.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function ie(r,e){let[t,n]=Vu.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}async function yd(r,e,t){let n=[];if(t){let i=await r.getLatestBlockhash(),o=[];for(let u of e){u.recentBlockhash=i.blockhash,u.lastValidBlockHeight=i.lastValidBlockHeight;let m=u._compile().serialize(),p=u._serialize(m).toString("base64");o.push(p)}let s=o.map(u=>{let l=r._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],c=20;for(let u=0;u<Math.ceil(s.length/c);u++)a.push(s.slice(u*c,(u+1)*c));n=await(await Promise.all(a.map(async u=>(await r._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async i=>await(await r.simulateTransaction(i)).value))}catch(i){i instanceof Error&&gn.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:i.message})}return n}function qi({instructions:r,payer:e,signers:t}){return pr(r,[e,...t])}function Ui({instructions:r,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=_u.generate().publicKey.toString()}){let o=new pd({payerKey:e,recentBlockhash:n,instructions:r}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Fu(o).serialize()).toString("base64").length<Du}catch{return!1}}var bd=r=>Buffer.isBuffer(r)?r:r instanceof Uint8Array?Buffer.from(r.buffer,r.byteOffset,r.byteLength):Buffer.from(r),gd=r=>{let e=r.serialize({requireAllSignatures:!1,verifySignatures:!1});r instanceof Fu&&(e=bd(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Xn(r){let e=[];return r.forEach(t=>{t instanceof lr&&(t.recentBlockhash||(t.recentBlockhash=fd.toBase58()),t.feePayer||(t.feePayer=_u.generate().publicKey)),e.push(gd(t))}),console.log("simulate tx string:",e),e}function J(r,e,t){return ie([r.toBuffer(),(t!=null?t:Ad).toBuffer(),e.toBuffer()],new Pd("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as me}from"@solana/web3.js";var vs=new me("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Uu=new me("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Es=new me("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),fi=new me("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),wd=new me("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),_s=new me("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),fr=new me("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Gi=new me("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),kd=new me("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),yr=new me("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),An=new me("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Qn=new me("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Xi=new me("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),hd=new me("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Vs=new me("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Td=new me("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Id=new me("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Bd=new me("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),xd=new me("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Qi=new me("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Fs=new me("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),Sd=new me("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Kd=new me("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Cd=new me("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Ld=new me("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),zi=new me("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Rd=new me("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),Hi=new me("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),Nd=new me("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),Nt=new me("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),Od=new me("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Md=new me("LanD8FpTBBvzZFXjTxsAoipkFsxPUCDB4qAqKxYDiNP"),vd=new me("HYNHiyKJ3gGVFvyxJAurK7qr7P2o5J9THmvCGMdULtpW"),ji={IDO_PROGRAM_ID_V1:Td,IDO_PROGRAM_ID_V2:Id,IDO_PROGRAM_ID_V3:Bd,IDO_PROGRAM_ID_V4:xd},At={AMM_V4:Gi,AMM_STABLE:kd,CLMM_PROGRAM_ID:An,CLMM_LOCK_PROGRAM_ID:Qn,CLMM_LOCK_AUTH_ID:Xi,FARM_PROGRAM_ID_V3:vs,FARM_PROGRAM_ID_V5:Es,FARM_PROGRAM_ID_V6:fi,OPEN_BOOK_PROGRAM:_s,SERUM_PROGRAM_ID_V3:fr,UTIL1216:wd,Router:hd,CREATE_CPMM_POOL_PROGRAM:Qi,CREATE_CPMM_POOL_AUTH:Fs,CREATE_CPMM_POOL_FEE_ACC:Sd,LOCK_CPMM_PROGRAM:zi,LOCK_CPMM_AUTH:Hi,LAUNCHPAD_PROGRAM:Nt,LAUNCHPAD_AUTH:Od,FEE_DESTINATION_ID:Vs},Ng={AMM_V4:new me("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AMM_STABLE:new me("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM_PROGRAM_ID:new me("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new me("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new me("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),FARM_PROGRAM_ID_V3:new me("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FARM_PROGRAM_ID_V5:new me("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FARM_PROGRAM_ID_V6:new me("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),OPEN_BOOK_PROGRAM:new me("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),SERUM_PROGRAM_ID_V3:me.default,UTIL1216:me.default,Router:new me("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Kd,CREATE_CPMM_POOL_AUTH:Cd,CREATE_CPMM_POOL_FEE_ACC:Ld,LOCK_CPMM_PROGRAM:Rd,LOCK_CPMM_AUTH:Nd,LAUNCHPAD_PROGRAM:Md,LAUNCHPAD_AUTH:vd,FEE_DESTINATION_ID:new me("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR")};import wt from"bn.js";var Yi=1e4;function he(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let i=U(M({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),o=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new wt(o.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===Yi){let c=new wt(o.maximumFee.toString());return{amount:r.add(c),fee:c,expirationTime:a}}else{let c=Nn(r.mul(new wt(Yi)),new wt(Yi-o.transferFeeBasisPoints)),u=new wt(o.maximumFee.toString()),l=c.sub(r).gt(u)?r.add(u):c,m=Nn(l.mul(new wt(o.transferFeeBasisPoints)),new wt(Yi)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let c=Nn(r.mul(new wt(o.transferFeeBasisPoints)),new wt(Yi)),u=c.gt(s)?s:c;return{amount:r,fee:u,expirationTime:a}}}function jt(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function Nn(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new wt(0))?t.add(new wt(1)):t}function br(r,e){if(r.isZero())return new wt(0);let t=r.div(e);return t.isZero()?new wt(1):r.mod(e).gt(new wt(0))?t.add(new wt(1)):t}import{PublicKey as Gu,AddressLookupTableAccount as gr}from"@solana/web3.js";async function Ds({connection:r,address:e}){let t=await Gt(r,[...new Set(e.map(i=>i.toString()))].map(i=>new Gu(i))),n={};for(let i=0;i<e.length;i++){let o=t[i],s=e[i];if(!o)continue;let a=new gr({key:s,state:gr.deserialize(o.data)});n[s.toString()]=a,Pr[s.toString()]=a}return n}var Pr={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new gr({key:new Gu("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:gr.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as yi,sendAndConfirmTransaction as Ws,SystemProgram as Ed,Transaction as Zi,TransactionMessage as $i,VersionedTransaction as Ji}from"@solana/web3.js";import _d from"axios";var Ar=2e3,wr=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await _d.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=mr(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){var t;return e?(this.endInstructions.push(Ed.transfer({fromPubkey:(t=e.feePayer)!=null?t:this.feePayer,toPubkey:new yi(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(X.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:o=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...o),this.lookupTableAddress.push(...s.filter(a=>a!==yi.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(M({},t||{})):this.build(t)}build(e){var n;let t=new Zi;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var l;let{recentBlockHash:o,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=i||{},u=o!=null?o:await pi(this.connection,this.blockhashCommitment);if(t.recentBlockhash=u,this.signers.length&&t.sign(...this.signers),Xn([t]),(l=this.owner)!=null&&l.isKeyPair)return{txId:a?await Ws(this.connection,t,this.signers.find(d=>d.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let m=await this.signAllTransactions([t]);if(this.signers.length)for(let d of m)try{d.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(m[0].serialize(),{skipPreflight:s}),signedTx:m[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var u;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),o=t.filter(l=>l.transaction.instructions.length>0),s=[i,...o.map(l=>l.transaction)],a=[this.signers,...o.map(l=>l.signers)],c=[...this.instructionTypes,...o.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async l=>{var g;let{sequentially:m,onTxUpdate:d,skipTxCount:p=0,recentBlockHash:y,skipPreflight:f=!0}=l||{},b=y!=null?y:await pi(this.connection,this.blockhashCommitment);if((g=this.owner)!=null&&g.isKeyPair){if(m){let A=[],k=0;for(let T of s){if(++k,k<=p)continue;let I=await Ws(this.connection,T,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});A.push(I)}return{txIds:A,signedTxs:s}}return{txIds:await await Promise.all(s.map(async A=>(A.recentBlockhash=b,await this.connection.sendRawTransaction(A.serialize(),{skipPreflight:f})))),signedTxs:s}}if(this.signAllTransactions){let A=s.map((T,I)=>(T.recentBlockhash=b,a[I].length&&T.sign(...a[I]),T));Xn(A);let k=await this.signAllTransactions(A);if(m){let T=0,I=[],h=async()=>{if(!k[T])return;let S=await this.connection.sendRawTransaction(k[T].serialize(),{skipPreflight:f});I.push({txId:S,status:"sent",signedTx:k[T]}),d==null||d([...I]),T++;let x=!1,C=null,B=null,K=L=>{C!==null&&clearInterval(C),B!==null&&this.connection.removeSignatureListener(B);let R=I.findIndex(V=>V.txId===S);if(R>-1){if(I[R].status==="error"||I[R].status==="success")return;I[R].status=L.err?"error":"success"}d==null||d([...I]),L.err||h()};this.loopMultiTxStatus&&(C=setInterval(async()=>{var L;if(x){clearInterval(C);return}try{let R=await this.connection.getTransaction(S,{commitment:"confirmed",maxSupportedTransactionVersion:0});R&&(x=!0,clearInterval(C),K({err:((L=R.meta)==null?void 0:L.err)||null}),console.log("tx status from getTransaction:",S))}catch(R){x=!0,clearInterval(C),console.error("getTransaction timeout:",R,S)}},Ar)),B=this.connection.onSignature(S,L=>{if(x){this.connection.removeSignatureListener(B);return}x=!0,K(L)},"confirmed"),this.connection.getSignatureStatus(S)};return await h(),{txIds:I.map(S=>S.txId),signedTxs:k}}else{let T=[];for(let I=0;I<k.length;I+=1){let h=await this.connection.sendRawTransaction(k[I].serialize(),{skipPreflight:f});T.push(h)}return{txIds:T,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var f;let y=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:o}=y,s=De(y,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=M(M({},this.cluster==="devnet"?{}:Pr),t),c=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let b of c)a[b]===void 0&&u.push(new yi(b));let l=await Ds({connection:this.connection,address:u});for(let[b,g]of Object.entries(l))a[b]=g;let m=i?yi.default.toBase58():o!=null?o:await pi(this.connection,this.blockhashCommitment),d=new $i({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((f=this.owner)==null?void 0:f.signer)&&!this.signers.some(b=>b.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new Ji(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async b=>{var T;let{skipPreflight:g=!0,sendAndConfirm:A,notSendToRpc:k}=b||{};if(Xn([p]),(T=this.owner)!=null&&T.isKeyPair){let I=await this.connection.sendTransaction(p,{skipPreflight:g});return A&&await dr(this.connection,I),{txId:I,signedTx:p}}if(this.signAllTransactions){let I=await this.signAllTransactions([p]);if(this.signers.length)for(let h of I)try{h.sign(this.signers)}catch{}return{txId:k?"":await this.connection.sendTransaction(I[0],{skipPreflight:g}),signedTx:I[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var u;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),o=t.filter(l=>l.builder.instructions.length>0),s=[i,...o.map(l=>l.transaction)],a=[this.signers,...o.map(l=>l.signers)],c=[...this.instructionTypes,...o.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async l=>{var f;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:y=!0}=l||{};if(p&&s.forEach(b=>b.message.recentBlockhash=p),Xn(s),(f=this.owner)!=null&&f.isKeyPair){if(m){let b=[];for(let g of s){let A=await this.connection.sendTransaction(g,{skipPreflight:y});await dr(this.connection,A),b.push(A)}return{txIds:b,signedTxs:s}}return{txIds:await Promise.all(s.map(async b=>await this.connection.sendTransaction(b,{skipPreflight:y}))),signedTxs:s}}if(this.signAllTransactions){let b=await this.signAllTransactions(s);if(m){let g=0,A=[],k=async()=>{if(!b[g])return;let T=await this.connection.sendTransaction(b[g],{skipPreflight:y});A.push({txId:T,status:"sent",signedTx:b[g]}),d==null||d([...A]),g++;let I=!1,h=null,S=null,x=C=>{h!==null&&clearInterval(h),S!==null&&this.connection.removeSignatureListener(S);let B=A.findIndex(K=>K.txId===T);if(B>-1){if(A[B].status==="error"||A[B].status==="success")return;A[B].status=C.err?"error":"success"}d==null||d([...A]),C.err||k()};this.loopMultiTxStatus&&(h=setInterval(async()=>{var C;if(I){clearInterval(h);return}try{let B=await this.connection.getTransaction(T,{commitment:"confirmed",maxSupportedTransactionVersion:0});B&&(I=!0,clearInterval(h),x({err:((C=B.meta)==null?void 0:C.err)||null}),console.log("tx status from getTransaction:",T))}catch(B){I=!0,clearInterval(h),console.error("getTransaction timeout:",B,T)}},Ar)),S=this.connection.onSignature(T,C=>{if(I){this.connection.removeSignatureListener(S);return}I=!0,x(C)},"confirmed"),this.connection.getSignatureStatus(T)};return k(),{txIds:[],signedTxs:b}}else{let g=[];for(let A=0;A<b.length;A+=1){let k=await this.connection.sendTransaction(b[A],{skipPreflight:y});g.push(k)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var d;let m=e||{},{splitIns:t=[],computeBudgetConfig:n}=m,i=De(m,["splitIns","computeBudgetConfig"]),o=n?mr(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((p,y)=>U(M({},p),{[y.publicKey.toBase58()]:y}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(p=>{let y=[...u,p],f=n?[...o.instructions,...y]:y,g=[...new Set(y.map(A=>A.keys.filter(k=>k.isSigner).map(k=>k.pubkey.toString())).flat()).values()].map(A=>new yi(A));if(p!==t[l]&&u.length<12&&(qi({instructions:f,payer:this.feePayer,signers:g})||qi({instructions:y,payer:this.feePayer,signers:g})))u.push(p);else{if(u.length===0)throw Error("item ins too big");l+=p===t[l]?1:0,qi({instructions:n?[...o.instructions,...u]:[...u],payer:this.feePayer,signers:g})?a.push(new Zi().add(...o.instructions,...u)):a.push(new Zi().add(...u)),c.push(Array.from(new Set(u.map(A=>A.keys.filter(k=>k.isSigner).map(k=>k.pubkey.toString())).flat())).map(A=>s[A]).filter(A=>A!==void 0)),u=[p]}}),u.length>0){let y=[...new Set(u.map(f=>f.keys.filter(b=>b.isSigner).map(b=>b.pubkey.toString())).flat()).values()].map(f=>s[f]).filter(f=>f!==void 0);qi({instructions:n?[...o.instructions,...u]:[...u],payer:this.feePayer,signers:y.map(f=>f.publicKey)})?a.push(new Zi().add(...o.instructions,...u)):a.push(new Zi().add(...u)),c.push(y)}return a.forEach(p=>p.feePayer=this.feePayer),(d=this.owner)!=null&&d.signer&&c.forEach(p=>{p.some(y=>y.publicKey.equals(this.owner.publicKey))||p.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async p=>{var T;let{sequentially:y,onTxUpdate:f,skipTxCount:b=0,recentBlockHash:g,skipPreflight:A=!0}=p||{},k=g!=null?g:await pi(this.connection,this.blockhashCommitment);if(a.forEach(async(I,h)=>{I.recentBlockhash=k,c[h].length&&I.sign(...c[h])}),Xn(a),(T=this.owner)!=null&&T.isKeyPair){if(y){let I=0,h=[];for(let S of a){if(++I,I<=b){h.push("tx skipped");continue}let x=await Ws(this.connection,S,this.signers.find(C=>C.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:A});h.push(x)}return{txIds:h,signedTxs:a}}return{txIds:await Promise.all(a.map(async I=>await this.connection.sendRawTransaction(I.serialize(),{skipPreflight:A}))),signedTxs:a}}if(this.signAllTransactions){let I=await this.signAllTransactions(a.slice(b,a.length)),h=[...a.slice(0,b),...I];if(y){let S=0,x=[],C=async()=>{if(!h[S])return;S<b&&(x.push({txId:"",status:"success",signedTx:h[S]}),f==null||f([...x]),S++,C());let B=await this.connection.sendRawTransaction(h[S].serialize(),{skipPreflight:A});x.push({txId:B,status:"sent",signedTx:h[S]}),f==null||f([...x]),S++;let K=!1,L=null,R=null,V=_=>{L!==null&&clearInterval(L),R!==null&&this.connection.removeSignatureListener(R);let W=x.findIndex(Y=>Y.txId===B);if(W>-1){if(x[W].status==="error"||x[W].status==="success")return;x[W].status=_.err?"error":"success"}f==null||f([...x]),_.err||C()};this.loopMultiTxStatus&&(L=setInterval(async()=>{var _;if(K){clearInterval(L);return}try{let W=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});W&&(K=!0,clearInterval(L),V({err:((_=W.meta)==null?void 0:_.err)||null}),console.log("tx status from getTransaction:",B))}catch(W){K=!0,clearInterval(L),console.error("getTransaction timeout:",W,B)}},Ar)),R=this.connection.onSignature(B,_=>{if(K){this.connection.removeSignatureListener(R);return}K=!0,V(_)},"confirmed"),this.connection.getSignatureStatus(B)};return await C(),{txIds:x.map(B=>B.txId),signedTxs:h}}else{let S=[];for(let x=0;x<h.length;x+=1){let C=await this.connection.sendRawTransaction(h[x].serialize(),{skipPreflight:A});S.push(C)}return{txIds:S,signedTxs:h}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async sizeCheckBuildV0(e){var k;let A=e||{},{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:o=[]}=A,s=De(A,["computeBudgetConfig","splitIns","lookupTableCache","lookupTableAddress"]),a=M(M({},this.cluster==="devnet"?{}:Pr),i),c=Array.from(new Set([...this.lookupTableAddress,...o])),u=[];for(let T of c)a[T]===void 0&&u.push(new yi(T));let l=await Ds({connection:this.connection,address:u});for(let[T,I]of Object.entries(l))a[T]=I;let m=t?mr(t):{instructions:[],instructionTypes:[]},d=await pi(this.connection,this.blockhashCommitment),p=this.signers.reduce((T,I)=>U(M({},T),{[I.publicKey.toBase58()]:I}),{}),y=[],f=[],b=[],g=0;if(this.allInstructions.forEach(T=>{let I=[...b,T],h=t?[...m.instructions,...I]:I;if(T!==n[g]&&b.length<12&&(Ui({instructions:h,payer:this.feePayer,lookupTableAddressAccount:a})||Ui({instructions:I,payer:this.feePayer,lookupTableAddressAccount:a})))b.push(T);else{if(b.length===0)throw Error("item ins too big");g+=T===n[g]?1:0;let S={};for(let x of[...new Set(c)])a[x]!==void 0&&(S[x]=a[x]);if(t&&Ui({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let x=new $i({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new Ji(x))}else{let x=new $i({payerKey:this.feePayer,recentBlockhash:d,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new Ji(x))}f.push(Array.from(new Set(b.map(x=>x.keys.filter(C=>C.isSigner).map(C=>C.pubkey.toString())).flat())).map(x=>p[x]).filter(x=>x!==void 0)),b=[T]}}),b.length>0){let I=[...new Set(b.map(h=>h.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat()).values()].map(h=>p[h]).filter(h=>h!==void 0);if(t&&Ui({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let h=new $i({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new Ji(h))}else{let h=new $i({payerKey:this.feePayer,recentBlockhash:d,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new Ji(h))}f.push(I)}return(k=this.owner)!=null&&k.signer&&f.forEach(T=>{T.some(I=>I.publicKey.equals(this.owner.publicKey))||T.push(this.owner.signer)}),y.forEach((T,I)=>{T.sign(f[I])}),{builder:this,transactions:y,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async T=>{var B;let{sequentially:I,onTxUpdate:h,skipTxCount:S=0,recentBlockHash:x,skipPreflight:C=!0}=T||{};if(y.map(async(K,L)=>{f[L].length&&K.sign(f[L]),x&&(K.message.recentBlockhash=x)}),Xn(y),(B=this.owner)!=null&&B.isKeyPair){if(I){let K=0,L=[];for(let R of y){if(++K,K<=S){console.log("skip tx: ",K),L.push("tx skipped");continue}let V=await this.connection.sendTransaction(R,{skipPreflight:C});await dr(this.connection,V),L.push(V)}return{txIds:L,signedTxs:y}}return{txIds:await Promise.all(y.map(async K=>await this.connection.sendTransaction(K,{skipPreflight:C}))),signedTxs:y}}if(this.signAllTransactions){let K=await this.signAllTransactions(y.slice(S,y.length)),L=[...y.slice(0,S),...K];if(I){let R=0,V=[],_=async()=>{if(!L[R])return;if(R<S){V.push({txId:"",status:"success",signedTx:L[R]}),h==null||h([...V]),R++,_();return}let W=await this.connection.sendTransaction(L[R],{skipPreflight:C});V.push({txId:W,status:"sent",signedTx:L[R]}),h==null||h([...V]),R++;let Y=!1,se=null,Ae=null,ce=de=>{se!==null&&clearInterval(se),Ae!==null&&this.connection.removeSignatureListener(Ae);let Ke=V.findIndex(Ze=>Ze.txId===W);if(Ke>-1){if(V[Ke].status==="error"||V[Ke].status==="success")return;V[Ke].status=de.err?"error":"success"}h==null||h([...V]),de.err||_()};this.loopMultiTxStatus&&(se=setInterval(async()=>{var de;if(Y){clearInterval(se);return}try{let Ke=await this.connection.getTransaction(W,{commitment:"confirmed",maxSupportedTransactionVersion:0});Ke&&(Y=!0,clearInterval(se),ce({err:((de=Ke.meta)==null?void 0:de.err)||null}),console.log("tx status from getTransaction:",W))}catch(Ke){Y=!0,clearInterval(se),console.error("getTransaction timeout:",Ke,W)}},Ar)),Ae=this.connection.onSignature(W,de=>{if(Y){this.connection.removeSignatureListener(Ae);return}Y=!0,ce(de)},"confirmed"),this.connection.getSignatureStatus(W)};return _(),{txIds:[],signedTxs:L}}else{let R=[];for(let V=0;V<L.length;V+=1){let _=await this.connection.sendTransaction(L[V],{skipPreflight:C});R.push(_)}return{txIds:R,signedTxs:L}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import Vd from"bn.js";var Yt=new Vd(1e6);var rt={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://lite-api.jup.ag/tokens/v1/tagged/verified",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},wP=M({},rt);var Xu="ray_tab_hash",qs="ray_req_hash",Fd=()=>{if(typeof window===void 0)return"";let r=sessionStorage.getItem(Xu);return r||(r=`ray-${Date.now()}`,sessionStorage.setItem(Xu,r)),r},kr=async n=>{var i=n,{logCount:r=1e3,removeLastLog:e}=i,t=De(i,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let o=JSON.parse(localStorage.getItem(qs)||"[]").slice(0,r-1);e&&o.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),o.unshift(U(M({},t),{time:Date.now(),session:Fd()}));try{localStorage.setItem(qs,JSON.stringify(o))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(o[0].data=a+(a.length>100?"...":"");!s;){o.pop();let c=JSON.stringify(t.data).substring(0,100);o[0].data=c+(c.length>100?"...":"");try{localStorage.setItem(qs,JSON.stringify(o)),s=!0}catch{s=!1}}return new Promise(c=>c())}return kr(U(M({},t),{logCount:r,removeLastLog:!0}))}};import{TOKEN_2022_PROGRAM_ID as Dd,TOKEN_PROGRAM_ID as Wd}from"@solana/spl-token";var hr=fe("Raydium_Api"),Us=new Map;var Tr=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:i,urlConfigs:o}){this.cluster=e,this.urlConfigs=o||{},this.logCount=i||1e3,this.api=Qu.create({baseURL:this.urlConfigs.BASE_HOST||rt.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return hr.debug(`${a==null?void 0:a.toUpperCase()} ${c}${u}`),s},s=>(hr.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:m,url:d}=a;return n&&kr({status:u,url:`${m}${d}`,params:a.params,data:c,logCount:this.logCount}),hr.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:m,url:d}=a;return n&&kr({status:u,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),hr.error(`${l.toUpperCase()} ${m}${d} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||rt.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||rt.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||rt.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await Qu.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(i=>i.numSlots);return n.reduce((i,o)=>i+o,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||rt.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||rt.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||rt.TOKEN_LIST)).data}async getJupTokenList(){return(await this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||rt.JUP_TOKEN_LIST})).map(t=>U(M({},t),{chainId:101,programId:t.tags.includes("token-2022")?Dd.toBase58():Wd.toBase58()}))}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||rt.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:i="desc",page:o=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||rt.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${i}&page=${o}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||rt.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],i=t.filter(s=>Us.has(s)?(n.push(Us.get(s)),!1):!0),o=[];return i.length&&(o=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||rt.POOL_KEY_BY_ID)+`?ids=${i.join(",")}`)).data.filter(Boolean),o.forEach(a=>{Us.set(a.id,a)})),n.concat(o)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:i="all",sort:o="default",order:s="desc",page:a=1}=e,[c,u]=[t&&mt(t).toBase58(),n&&n!=="undefined"?mt(n).toBase58():""],[l,m]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||rt.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${i}&poolSortField=${o}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||rt.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||rt.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||rt.CHECK_AVAILABILITY)).data}};var Ir="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",zu="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as Rr,SystemProgram as Pp}from"@solana/web3.js";import{AccountLayout as Ai,createAssociatedTokenAccountIdempotentInstruction as Js,TOKEN_PROGRAM_ID as En,TOKEN_2022_PROGRAM_ID as Ap}from"@solana/spl-token";var Gs=(...r)=>r.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Me=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=fe(t)}createTxBuilder(e){return this.scope.checkOwner(),new wr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Gs(e))}logInfo(...e){this.logger.info(Gs(e))}logAndCreateError(...e){let t=Gs(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as dp,SystemProgram as pp}from"@solana/web3.js";import fp from"bn.js";import{createCloseAccountInstruction as yp,createInitializeAccountInstruction as bp,createTransferInstruction as gp,TOKEN_PROGRAM_ID as Pi}from"@solana/spl-token";import{Keypair as up,PublicKey as uc}from"@solana/web3.js";import cp from"bn.js";import{TOKEN_PROGRAM_ID as lp}from"@solana/spl-token";function qd(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function Xs(r,...e){if(!qd(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function Qs(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Hu(r,e){Xs(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var xr=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),Zt=(r,e)=>r<<32-e|r>>>e;var rA=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Ud(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function zs(r){return typeof r=="string"&&(r=Ud(r)),Xs(r),r}var Br=class{clone(){return this._cloneInto()}},sA={}.toString;function ju(r){let e=n=>r().update(zs(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Gd(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let i=BigInt(32),o=BigInt(4294967295),s=Number(t>>i&o),a=Number(t&o),c=n?4:0,u=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+u,a,n)}var Yu=(r,e,t)=>r&e^~r&t,Zu=(r,e,t)=>r&e^r&t^e&t,Sr=class extends Br{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=xr(this.buffer)}update(e){Qs(this);let{view:t,buffer:n,blockLen:i}=this;e=zs(e);let o=e.length;for(let s=0;s<o;){let a=Math.min(i-this.pos,o-s);if(a===i){let c=xr(e);for(;i<=o-s;s+=i)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Qs(this),Hu(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:o}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(n,0),s=0);for(let m=s;m<i;m++)t[m]=0;Gd(n,i-8,BigInt(this.length*8),o),this.process(n,0);let a=xr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)a.setUint32(4*m,l[m],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:o,destroyed:s,pos:a}=this;return e.length=i,e.pos=a,e.finished=o,e.destroyed=s,i%t&&e.buffer.set(n),e}};var Xd=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),On=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Mn=new Uint32Array(64),Hs=class extends Sr{constructor(){super(64,32,8,!1),this.A=On[0]|0,this.B=On[1]|0,this.C=On[2]|0,this.D=On[3]|0,this.E=On[4]|0,this.F=On[5]|0,this.G=On[6]|0,this.H=On[7]|0}get(){let{A:e,B:t,C:n,D:i,E:o,F:s,G:a,H:c}=this;return[e,t,n,i,o,s,a,c]}set(e,t,n,i,o,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=o|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)Mn[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=Mn[m-15],p=Mn[m-2],y=Zt(d,7)^Zt(d,18)^d>>>3,f=Zt(p,17)^Zt(p,19)^p>>>10;Mn[m]=f+Mn[m-7]+y+Mn[m-16]|0}let{A:n,B:i,C:o,D:s,E:a,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let d=Zt(a,6)^Zt(a,11)^Zt(a,25),p=l+d+Yu(a,c,u)+Xd[m]+Mn[m]|0,f=(Zt(n,2)^Zt(n,13)^Zt(n,22))+Zu(n,i,o)|0;l=u,u=c,c=a,a=s+p|0,s=o,o=i,i=n,n=p+f|0}n=n+this.A|0,i=i+this.B|0,o=o+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,i,o,s,a,c,u,l)}roundClean(){Mn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var $u=ju(()=>new Hs);import{PublicKey as op}from"@solana/web3.js";import oc,{isBN as rc}from"bn.js";import{bits as Qd,BitStructure as yA,blob as zd,Blob as bA,cstr as gA,f32 as PA,f32be as AA,f64 as wA,f64be as kA,greedy as hA,Layout as Hd,ns64 as TA,ns64be as IA,nu64 as jd,nu64be as BA,offset as Yd,s16 as xA,s16be as SA,s24 as KA,s24be as CA,s32 as Zd,s32be as LA,s40 as RA,s40be as NA,s48 as OA,s48be as MA,s8 as vA,seq as $d,struct as EA,Structure as Jd,u16 as ep,u16be as _A,u24 as VA,u24be as FA,u32 as tp,u32be as DA,u40 as WA,u40be as qA,u48 as UA,u48be as GA,u8 as np,UInt as ip,union as XA,Union as QA,unionLayoutDiscriminator as zA,utf8 as HA}from"@solana/buffer-layout";var Kr=Hd,Ju=Jd;var js=ip;var ec=np,$t=ep;var Cr=tp;var tc=jd;var ve=Zd;var nc=$d;var Te=zd;var Ys=Qd,ic=Yd;var Hn=class extends Kr{constructor(t,n,i){super(t,i);this.blob=Te(t),this.signed=n}decode(t,n=0){let i=new oc(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new oc(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}},Lr=class extends Kr{constructor(t){super(8,t);this._lower=Ys(Cr(),!1),this._upper=Ys(Cr(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let i=this._lower.decode(t,n),o=this._upper.decode(t,n+this._lower.span);return M(M({},i),o)}encode(t,n,i=0){return this._lower.encode(t,n,i)+this._upper.encode(t,n,i+this._lower.span)}};function q(r){return new js(1,r)}function ut(r){return new js(4,r)}function w(r){return new Hn(8,!1,r)}function te(r){return new Hn(16,!1,r)}function sc(r){return new Hn(1,!0,r)}function gi(r){return new Hn(8,!0,r)}function ac(r){return new Hn(16,!0,r)}var bi=class extends Kr{constructor(t,n,i,o){super(t.span,o);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function N(r){return new bi(Te(32),e=>new op(e),e=>e.toBuffer(),r)}function Fe(r){return new bi(ec(),rp,sp,r)}function rp(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function sp(r){return r?1:0}function ap(r){let e=Cr("length"),t=E([e,Te(ic(e,-e.span),"data")]);return new bi(t,({data:n})=>n,n=>({data:n}),r)}function Jt(r){return new bi(ap(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),r)}var Zs=class extends Ju{decode(e,t){return super.decode(e,t)}};function E(r,e,t){return new Zs(r,e,t)}function H(r,e,t){let n,i=typeof e=="number"?e:rc(e)?e.toNumber():new Proxy(e,{get(o,s){if(!n){let a=Reflect.get(o,"count");n=rc(a)?a.toNumber():a,Reflect.set(o,"count",n)}return Reflect.get(o,s)},set(o,s,a){return s==="count"&&(n=a),Reflect.set(o,s,a)}});return nc(r,i,t)}var en=E([N("mint"),N("owner"),w("amount"),ut("delegateOption"),N("delegate"),q("state"),ut("isNativeOption"),w("isNative"),w("delegatedAmount"),ut("closeAuthorityOption"),N("closeAuthority")]);var yw=fe("Raydium_Util");function cc({owner:r,solAccountResp:e,tokenAccountResp:t}){let n=[],i=[];for(let{pubkey:o,account:s}of t.value){let a=en.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:o,mint:c,amount:u,isAssociated:J(r,c,s.owner).publicKey.equals(o),isNative:!1,programId:s.owner}),i.push({pubkey:o,accountInfo:a,programId:s.owner})}return e&&n.push({mint:uc.default,amount:new cp(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:i}}function Ge({fromPublicKey:r,programId:e=lp,assignSeed:t}){let n=t?btoa(t).slice(0,32):up.generate().publicKey.toBase58().slice(0,32);return{publicKey:mp(r,n,e),seed:n}}function mp(r,e,t){let n=Buffer.concat([r.toBuffer(),Buffer.from(e),t.toBuffer()]),i=$u(n);return new uc(i)}function $s(r){let{mint:e,tokenAccount:t,owner:n,programId:i=Pi}=r;return bp(t,e,n,i)}function wn(r){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:o=Pi}=r;return yp(e,t,i,n,o)}async function vn(r){let{connection:e,amount:t,commitment:n,payer:i,owner:o,skipCloseAccount:s}=r,a=await e.getMinimumBalanceForRentExemption(en.span,n),c=ee(t).add(new fp(a)),u=Ge({fromPublicKey:i,programId:Pi});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[pp.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:en.span,programId:Pi}),$s({mint:new dp(nt.address),tokenAccount:u.publicKey,owner:o,programId:Pi})],instructionTypes:[X.CreateAccount,X.InitAccount],endInstructionTypes:s?[]:[X.CloseAccount],endInstructions:s?[]:[wn({tokenAccount:u.publicKey,payer:i,owner:o})]}}function lc({source:r,destination:e,owner:t,amount:n,multiSigners:i=[],tokenProgram:o=Pi}){return gp(r,e,t,BigInt(String(n)),i,o)}var eo=class extends Me{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._notSubscribeAccountChange=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:i,notSubscribeAccountChange:o}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=i||[],this._notSubscribeAccountChange=o!=null?o:!0,this._clientOwnedToken=!!(n||i)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(t){this._notSubscribeAccountChange=t}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return J(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let i=M(M({},{}),t),[o,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:En},i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Ap},i.commitment)]),{tokenAccounts:c,tokenAccountRawInfos:u}=cc({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=c,this._tokenAccountRawInfos=u,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(l=>l({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:t==null?void 0:t.commitment})),{tokenAccounts:c,tokenAccountRawInfos:u}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:t,programId:n=En,associatedOnly:i=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,c)=>a.amount.lt(c.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of o){let{publicKey:c}=a;if(c&&(!i||i&&s.equals(c)))return c}}async getOrCreateTokenAccount(t){var f,b,g,A;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:i,associatedOnly:o,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:c=!1,checkCreateATAOwner:u=!1,assignSeed:l}=t,m=new Rr(t.tokenProgram||En),d=this.getAssociatedTokenAccount(n,new Rr(m)),p=(a?[]:this.tokenAccountRawInfos).filter(k=>k.accountInfo.mint.equals(n)&&(!o||k.pubkey.equals(d))).sort((k,T)=>k.accountInfo.amount.lt(T.accountInfo.amount)?1:-1);if(i===void 0||p.length>0)return p.length>0?{account:p[0].pubkey}:{};let y={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let k=Js(s,d,s,n,m),T=this.tokenAccountRawInfos.find(I=>I.pubkey.equals(d));if(u){let I=await this.scope.connection.getAccountInfo(d);if(I===null)(f=y.instructions)==null||f.push(k),y.instructionTypes.push(X.CreateATA);else if(!(I.owner.equals(m)&&Ai.decode(I.data).mint.equals(n)&&Ai.decode(I.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${d.toString()}`)}else T===void 0&&(y.instructions.push(k),y.instructionTypes.push(X.CreateATA));if(n.equals(Z)&&i.amount){let I=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(b=i.amount)!=null?b:0,skipCloseAccount:c});y.instructions.push(...I.instructions||[]),y.endInstructions.push(...I.endInstructions||[]),y.instructionTypes.push(...I.instructionTypes||[]),y.endInstructionTypes.push(...I.endInstructionTypes||[]),i.amount&&(y.instructions.push(lc({source:I.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:i.amount,tokenProgram:En})),y.instructionTypes.push(X.TransferAmount))}return!c&&T===void 0&&(y.endInstructions.push(wn({owner:s,payer:i.payer||s,tokenAccount:d,programId:m})),y.endInstructionTypes.push(X.CloseAccount)),{account:d,instructionParams:y}}else{let k=Ge({fromPublicKey:s,programId:m,assignSeed:l}),T=await this.scope.connection.getMinimumBalanceForRentExemption(Ai.span),I=Pp.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:k.seed,newAccountPubkey:k.publicKey,lamports:T+Number((A=(g=i.amount)==null?void 0:g.toString())!=null?A:0),space:Ai.span,programId:m});return y.instructions.push(I,$s({mint:n,tokenAccount:k.publicKey,owner:this.scope.ownerPubKey,programId:m})),y.instructionTypes.push(X.CreateAccount),y.instructionTypes.push(X.InitAccount),c||(y.endInstructions.push(wn({owner:s,payer:i.payer||s,tokenAccount:k.publicKey,programId:m})),y.endInstructionTypes.push(X.CloseAccount)),{account:k.publicKey,instructionParams:y}}}async checkOrCreateAta({mint:t,programId:n=En,autoUnwrapWSOLToSOL:i}){var c;await this.fetchWalletTokenAccounts();let o=(c=this.scope.account.tokenAccounts.find(({mint:u})=>(u==null?void 0:u.toBase58())===t.toBase58()))==null?void 0:c.publicKey,s=this.scope.ownerPubKey,a={};if(!o){let u=this.getAssociatedTokenAccount(t,n),l=await Js(s,u,s,t,n);a.instructions=[l],a.instructionTypes=[X.CreateATA],o=u}return i&&Z.toBase58()===t.toBase58()&&(a.endInstructions=[wn({owner:s,payer:s,tokenAccount:o,programId:n})],a.endInstructionTypes=[X.CloseAccount]),{pubKey:o,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:i,mint:o,programId:s=En,tokenAccount:a,payer:c=this.scope.ownerPubKey,bypassAssociatedCheck:u,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(o,s);if(new Rr(Z).equals(o)){let p=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:c,amount:i,skipCloseAccount:l});return M({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!u){let p=[],y=Js(this.scope.ownerPubKey,d,this.scope.ownerPubKey,o,s);if(m){let f=await this.scope.connection.getAccountInfo(d);if(f===null)p.push(y);else if(!(f.owner.equals(En)&&Ai.decode(f.data).mint.equals(o)&&Ai.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${d.toString()}`)}else p.push(y);return{tokenAccount:d,instructions:p,instructionTypes:[X.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:i=En,amount:o,useSOLBalance:s,handleTokenAccount:a,feePayer:c}=t,u,l=this.createTxBuilder(c);if(n.equals(new Rr(Z))&&s){let m=await this.handleTokenAccount({side:"in",amount:o||0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=m,y=De(m,["tokenAccount"]);u=p,l.addInstruction(y)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:i}),!u&&a){let d=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:p}=d,y=De(d,["tokenAccount"]);u=p,l.addInstruction(y)}return M({tokenAccount:u},l.AllTxData)}};import{PublicKey as Ie,SystemProgram as Dp}from"@solana/web3.js";import{createAssociatedTokenAccountIdempotentInstruction as Lc}from"@solana/spl-token";import{PublicKey as gc}from"@solana/web3.js";var ea=E([q("instruction")]),ta=E([q("instruction")]),wp=E([w("rewardState"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardLastUpdateTime"),w("totalReward"),w("totalRewardEmissioned"),w("rewardClaimed"),w("rewardPerSecond"),te("accRewardPerShare"),N("rewardVault"),N("rewardMint"),N("rewardSender"),w("rewardType"),H(w(),15,"padding")]),kp=E([w("state"),w("nonce"),N("lpVault"),N("rewardVault"),N(),N(),w(),w(),w("totalReward"),te("perShareReward"),w("lastSlot"),w("perSlotReward")]),hp=E([w("state"),w("nonce"),N("lpVault"),N("rewardVaultA"),w("totalRewardA"),te("perShareRewardA"),w("perSlotRewardA"),q("option"),N("rewardVaultB"),Te(7),w("totalRewardB"),te("perShareRewardB"),w("perSlotRewardB"),w("lastSlot"),N()]),Tp=E([w(),w("state"),w("nonce"),w("validRewardTokenNum"),te("rewardMultiplier"),w("rewardPeriodMax"),w("rewardPeriodMin"),w("rewardPeriodExtend"),N("lpMint"),N("lpVault"),H(wp,5,"rewardInfos"),N("creator"),N(),H(w(),32,"padding")]),mc=new Proxy(kp,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return U(M({},i),{version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]})}:Reflect.get(r,e,t)}}),dc=new Proxy(hp,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return U(M({},i),{version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]})}:Reflect.get(r,e,t)}}),to=new Proxy(Tp,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return U(M({},i),{version:6,rewardInfos:i.rewardInfos.map(o=>{var s;return U(M({},o),{rewardType:((s=Object.entries(_n).find(a=>String(a[1])===o.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(r,e,t)}}),Ip=E([w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),na=E([q("instruction"),w("nonce"),H(Ip,5,"rewardTimeInfo")]),ia=E([q("instruction"),w("rewardReopenTime"),w("rewardEndTime"),w("rewardPerSecond")]),oa=E([q("instruction"),w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),zw=E([w("state"),N("id"),N("owner"),w("deposited"),H(w(),1,"rewardDebts")]),no=E([w("state"),N("id"),N("owner"),w("deposited"),H(te(),1,"rewardDebts"),w(""),w("voteLockedBalance"),H(w(),15)]),Hw=E([w("state"),N("id"),N("owner"),w("deposited"),H(w(),2,"rewardDebts")]),pc=E([w("state"),N("id"),N("owner"),w("deposited"),H(te(),2,"rewardDebts"),H(w(),17)]),fc=E([w(),w("state"),N("id"),N("owner"),w("deposited"),H(te(),5,"rewardDebts"),H(w(),16)]),kt=E([q("instruction"),w("amount")]),Bp=E([N("mint"),N("grantAuthority"),w("baselineVoteWeightScaledFactor"),w("maxExtraLockupVoteWeightScaledFactor"),w("lockupSaturationSecs"),sc("digitShift"),H(q(),7,"reserved1"),H(w(),7,"reserved2")]),yc=E([Te(8),N("governanceProgramId"),N("realm"),N("realmGoverningTokenMint"),N("realmAuthority"),H(q(),32,"reserved1"),H(Bp,4,"votingMints"),gi("timeOffset"),q("bump"),H(q(),7,"reserved2"),H(w(),11,"reserved3")]),xp=E([gi("startTime"),gi("endTime"),q("kind"),H(q(),15,"reserved")]),Sp=E([H(xp,1,"lockup"),w("amountDeposited_native"),w("amountInitiallyLockedNative"),Fe("isUsed"),Fe("allowClawback"),q("votingMintConfigIdx"),H(q(),29,"reserved")]),bc=E([Te(8),N("voterAuthority"),N("registrar"),H(Sp,32,"deposits"),q("voterBump"),q("voterWweightRecordBump"),H(q(),94,"reserved")]);var nk=fe("Raydium_farm_config"),Pc=new gc("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Ac=new gc("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),wc={3:mc,5:dc,6:to},kc={3:no,5:pc,6:fc},ra=r=>[3,4,5,6].indexOf(r)!==-1,sa=r=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=r,i=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,o={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${i}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${i}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${i}`}};return(s=o[e])==null?void 0:s.call(o)},_n={"Standard SPL":0,"Option tokens":1},_t={[vs.toString()]:3,[Uu.toString()]:4,[Es.toString()]:5,[fi.toString()]:6};import{PublicKey as ae,SystemProgram as jn,SYSVAR_CLOCK_PUBKEY as ki,SYSVAR_RENT_PUBKEY as Lp,TransactionInstruction as et}from"@solana/web3.js";import Nr from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Rp,createAssociatedTokenAccountIdempotentInstruction as Np,TOKEN_PROGRAM_ID as Ct}from"@solana/spl-token";function aa(r,e,t){return ie([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],r)}function ua(r,e){return ie([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],r)}function ca(r,e){return ie([e.toBuffer()],r)}function la(r,e,t){return ie([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],r)}function ma(r,e,t){return ie([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],r)}function da(r,e,t,n){return ie([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}import Kt from"bn.js";var io=fe("Raydium.farm.util");function oo({programId:r,poolId:e,mint:t,type:n}){let{publicKey:i}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],r);return i}function pt({programId:r,poolId:e,owner:t,version:n}){let{publicKey:i}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],r);return i}var hc=({programId:r,poolId:e})=>ie([e.toBuffer()],r);function Tc(r){return{isSet:new Kt(1),rewardPerSecond:ee(r.perSecond),rewardOpenTime:ee(r.openTime),rewardEndTime:ee(r.endTime),rewardType:ee(_n[r.rewardType])}}function pa(r){return ee(r.endTime).sub(ee(r.openTime)).mul(ee(r.perSecond))}function wi(r){let e=kc[r];return e||io.logWithError("invalid version",r),e}function Kp(r){let e=wc[r];return e||io.logWithError("invalid version",r),e}function Cp(r,e,t,n){if(r.version===3||r.version===5){if(r.lastSlot.gte(new Kt(t)))return r;let i=new Kt(t).sub(r.lastSlot);r.lastSlot=new Kt(t);for(let o of r.rewardInfos){if(e.amount.eq(new Kt(0)))continue;let s=o.perSlotReward.mul(i);o.perShareReward=o.perShareReward.add(s.mul(new Kt(10).pow(new Kt(r.version===3?9:15))).div(e.amount)),o.totalReward=o.totalReward.add(s)}}else if(r.version===6)for(let i of r.rewardInfos){if(i.rewardState.eq(new Kt(0)))continue;let o=Kt.min(new Kt(n),i.rewardEndTime);if(i.rewardOpenTime.gte(o))continue;let a=o.sub(i.rewardLastUpdateTime).mul(i.rewardPerSecond),c=i.totalReward.sub(i.totalRewardEmissioned);c.lt(a)?(a=c,i.rewardLastUpdateTime=i.rewardLastUpdateTime.add(c.div(i.rewardPerSecond))):i.rewardLastUpdateTime=o,!e.amount.eq(new Kt(0))&&(i.accRewardPerShare=i.accRewardPerShare.add(a.mul(r.rewardMultiplier).div(e.amount)),i.totalRewardEmissioned=i.totalRewardEmissioned.add(a))}return r}async function Ak({connection:r,farmPools:e,owner:t,config:n,chainTime:i}){let o=!1,s=!1,a=new Kt(10),c=[];for(let d of e){let p=Oe(d);p.version===6?s=!0:o=!0,c.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&c.push({pubkey:pt({programId:p.programId,poolId:p.id,owner:t,version:d.version}),version:p.version,key:"ledger",poolId:p.id})}let u={},l=await Ne(r,c,n);for(let{pubkey:d,version:p,key:y,poolId:f,accountInfo:b}of l){let g=f.toBase58();if(u[g]=M({},u[g]),y==="state"){let A=Kp(p);(!b||!b.data||b.data.length!==A.span)&&io.logWithError(`invalid farm state account info, pools.id, ${d}`),u[g].state=A.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==en.span)&&io.logWithError(`invalid farm lp vault account info, pools.lpVault, ${d}`),u[g].lpVault=en.decode(b.data);else if(y==="ledger"){let A=wi(p);b&&b.data&&(b.data.length!==A.span&&io.logWithError(`invalid farm ledger account info, ledger, ${d}`),u[g].ledger=A.decode(b.data))}}let m=s||o?await r.getSlot():0;for(let d of Object.keys(u))u[d]!==void 0&&(u[d].state=Cp(u[d].state,u[d].lpVault,m,i));for(let[d,{state:p,ledger:y}]of Object.entries(u))if(y){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new Kt(9)):a.pow(new Kt(15)),b=p.rewardInfos.map((g,A)=>{let k=y.rewardDebts[A];return y.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(k)});u[d].wrapped=U(M({},u[d].wrapped),{pendingRewards:b})}return u}function wk(r,e=Date.now()){if(r.version===6){let t=r.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>Mu(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>vu(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=r.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function fa(r,e,t,n){let i=await r.getAccountInfo(e);if(i===null)throw Error("registrar info check error");let s=yc.decode(i.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await r.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let u=bc.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return u===-1?{index:s,isInit:!1}:{index:u,isInit:!0}}var Op=fe("Raydium_farm_instruction"),ro={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function so(r){let{version:e,id:t,ledger:n,programId:i,owner:o}=r,s={3:9,5:10}[e];s||Op.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(ea.span);ea.encode({instruction:s},a);let c=[P({pubkey:t}),P({pubkey:n}),P({pubkey:o,isWritable:!1}),P({pubkey:jn.programId,isWritable:!1}),P({pubkey:Lp,isWritable:!1})];return{instruction:new et({programId:i,keys:c,data:a}),instructionType:X.FarmV3CreateLedger}}function Ic(r){var n;let e=Buffer.alloc(na.span);na.encode({instruction:0,nonce:new Nr(r.nonce),rewardTimeInfo:r.rewardInfoConfig},e);let t=[...xs,P({pubkey:r.farmId}),P({pubkey:r.farmAuthority,isWritable:!1}),P({pubkey:r.lpVault}),P({pubkey:r.lpMint,isWritable:!1}),P({pubkey:r.lockVault}),P({pubkey:r.lockMint,isWritable:!1}),P({pubkey:(n=r.lockUserAccount)!=null?n:it}),P({pubkey:r.owner,isWritable:!1,isSigner:!0})];for(let i of r.rewardInfo)t.push(P({pubkey:i.rewardMint,isWritable:!1}),P({pubkey:i.rewardVault}),P({pubkey:i.userRewardToken}));return{instruction:new et({programId:r.programId,keys:t,data:e}),instructionType:X.FarmV6Create}}function Bc(r){let e=Buffer.alloc(ta.span);ta.encode({instruction:5},e);let t=[P({pubkey:Ct,isWritable:!1}),P({pubkey:r.id}),P({pubkey:r.authority,isWritable:!1}),P({pubkey:r.lpVault,isWritable:!1}),P({pubkey:r.rewardVault}),P({pubkey:r.userRewardToken}),P({pubkey:r.owner,isWritable:!1,isSigner:!0})];return{instruction:new et({programId:r.programId,keys:t,data:e}),instructionType:X.FarmV6CreatorWithdraw}}function Mp(r,e,t,n,i,o,s,a,c,u,l,m,d){let p=E([q("depositEntryIndex"),w("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:Ct,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:m,amount:d},f);let b=Buffer.from([...ro.voterStakeRegistryDeposit,...f]);return new et({keys:y,programId:r,data:b})}function vp(r,e,t,n){let i=E([]),o=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:jn.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([...ro.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new et({keys:o,programId:r,data:a})}function Ep(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y){let f=E([q("depositEntryIndex"),w("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:Ct,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:y},g);let A=Buffer.from([...ro.voterStakeRegistryWithdraw,...g]);return new et({keys:b,programId:r,data:A})}function _p(r,e,t,n,i,o){let s=E([q("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:jn.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({ins:23},c),new et({keys:a,programId:r,data:c})}function Vp(r,e,t,n,i,o,s,a){let c=E([q("voterBump"),q("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:jn.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:s,voterWeightRecordBump:a},l);let m=Buffer.from([...ro.voterStakeRegistryCreateVoter,...l]);return new et({keys:u,programId:r,data:m})}function Fp(r,e,t,n,i,o,s,a,c,u,l,m){let d=E([q("depositEntryIndex"),q("kind"),q("option"),w("startTs"),ut("periods"),Fe("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:jn.programId,isSigner:!1,isWritable:!1},{pubkey:Ct,isSigner:!1,isWritable:!1},{pubkey:Rp,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],y=Buffer.alloc(d.span);d.encode({depositEntryIndex:a,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:m},y);let f=Buffer.from([...ro.voterStakeRegistryCreateDepositEntry,...y]);return new et({keys:p,programId:r,data:f})}async function Ek({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:i,communityTokenMint:o,owner:s,poolId:a,tokenProgram:c}){let u=aa(n,i,o).publicKey,l=pt({programId:e,poolId:a,owner:s,version:3}),m=await r.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=no.decode(m.data),p=d.deposited.sub(d.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new Nr(0)))throw Error("user do not has new stake amount");let y=ua(e,a).publicKey,f=ca(e,a).publicKey,{publicKey:b,nonce:g}=la(n,u,s),A=J(b,y,c).publicKey,{publicKey:k,nonce:T}=ma(n,u,s),I=da(t,i,o,s).publicKey,h=[],S=J(s,y,c).publicKey;if(await r.getAccountInfo(S)===null&&h.push(Np(s,S,s,y)),await r.getAccountInfo(b)===null){let L=_p(t,i,s,o,s,I);h.push(L,Vp(n,u,b,k,s,s,g,T))}let{index:B,isInit:K}=await fa(r,u,b,y);return K||h.push(Fp(n,u,b,A,s,s,y,B,0,void 0,0,!1)),h.push(Mp(n,u,b,A,S,s,l,a,y,f,e,B,p),vp(n,u,b,k)),h}async function _k({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:i,communityTokenMint:o,owner:s,poolId:a,tokenProgram:c}){let u=aa(n,i,o).publicKey,l=pt({programId:e,poolId:a,owner:s,version:3}),m=await r.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=no.decode(m.data);if(d.voteLockedBalance.eq(new Nr(0)))throw Error("user has vote locked balance = 0");let p=ua(e,a).publicKey,y=ca(e,a).publicKey,{publicKey:f}=la(n,u,s),b=J(f,p,c).publicKey,{publicKey:g}=ma(n,u,s),A=da(t,i,o,s).publicKey,k=[],{index:T,isInit:I}=await fa(r,u,f,p);if(!I)throw Error("deposit entry index check error");return k.push(Ep(n,u,f,s,A,g,b,J(s,p,c).publicKey,l,a,p,y,e,T,d.voteLockedBalance)),k}function ya({payer:r,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:i}){let o=Buffer.alloc(ia.span);ia.encode({instruction:3,rewardReopenTime:ee(i.openTime),rewardEndTime:ee(i.endTime),rewardPerSecond:ee(i.perSecond)},o);let s=[P({pubkey:Ct,isWritable:!1}),P({pubkey:n.id}),P({pubkey:n.lpVault,isWritable:!1}),P({pubkey:e}),P({pubkey:t}),P({pubkey:r,isWritable:!1,isSigner:!0})];return new et({programId:n.programId,keys:s,data:o})}function ba({payer:r,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:i}){let o=Buffer.alloc(oa.span);oa.encode({instruction:4,isSet:new Nr(1),rewardPerSecond:ee(i.perSecond),rewardOpenTime:ee(i.openTime),rewardEndTime:ee(i.endTime),rewardType:ee(_n[i.rewardType])},o);let s=[...xs,P({pubkey:t.id}),P({pubkey:t.authority,isWritable:!1}),P({pubkey:i.mint,isWritable:!1}),P({pubkey:n}),P({pubkey:e}),P({pubkey:r,isWritable:!1,isSigner:!0})];return new et({programId:t.programId,keys:s,data:o})}function Vk(r){let{farmInfo:e,farmKeys:t,version:n,lpAccount:i,rewardAccounts:o,owner:s,instruction:a,amount:c,deposit:u}=r,[l,m]=[new ae(e.programId),new ae(e.id)],d=pt({programId:l,poolId:m,owner:s,version:n}),p=Buffer.alloc(kt.span);kt.encode({instruction:a,amount:c},p);let y=n===6?[P({pubkey:Ct,isWritable:!1}),...u?[P({pubkey:jn.programId,isWritable:!1})]:[],P({pubkey:m}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:new ae(t.lpVault)}),P({pubkey:d}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:i})]:[P({pubkey:m}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:d}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:i}),P({pubkey:new ae(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:ki,isWritable:!1}),P({pubkey:Ct,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(P({pubkey:o[f]})),y.push(P({pubkey:new ae(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(P({pubkey:new ae(t.rewardInfos[f].vault)})),y.push(P({pubkey:o[f]}));return new et({programId:l,keys:y,data:p})}function ao(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s}=r,[a,c]=[new ae(e.programId),new ae(e.id)],u=pt({programId:a,poolId:c,owner:o,version:6}),l=Buffer.alloc(kt.span);kt.encode({instruction:2,amount:ee(s)},l);let m=[P({pubkey:Ct,isWritable:!1}),P({pubkey:c}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:new ae(t.lpVault)}),P({pubkey:u}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(P({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(P({pubkey:i[d]}));return new et({programId:a,keys:m,data:l})}function uo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=pt({programId:c,poolId:u,owner:o,version:5}),m=Buffer.alloc(kt.span);kt.encode({instruction:12,amount:ee(s)},m);let d=[P({pubkey:u}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:i[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:ki,isWritable:!1}),P({pubkey:Ct,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(P({pubkey:i[p]})),d.push(P({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(P({pubkey:p}));return new et({programId:c,keys:d,data:m})}function xc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=E([q("instruction"),w("amount")]),m=[P({pubkey:u}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:a[0]}),P({pubkey:o,isSigner:!0,isWritable:!1}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:i[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:ki,isWritable:!1}),P({pubkey:Ct,isWritable:!1}),P({pubkey:i[1]}),P({pubkey:new ae(t.rewardInfos[1].vault)})],d=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},d),new et({keys:m,programId:c,data:d})}function co(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=pt({programId:c,poolId:u,owner:o,version:3}),m=Buffer.alloc(kt.span);kt.encode({instruction:11,amount:ee(s)},m);let d=[P({pubkey:u}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:i[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:ki,isWritable:!1}),P({pubkey:Ct,isWritable:!1})];if(a)for(let p of a)d.push(P({pubkey:p}));return new et({programId:c,keys:d,data:m})}function Sc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=pt({programId:c,poolId:u,owner:o,version:3}),m=Buffer.alloc(kt.span);kt.encode({instruction:10,amount:ee(s)},m);let d=[P({pubkey:u}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:i[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:ki,isWritable:!1}),P({pubkey:Ct,isWritable:!1})];if(a)for(let p of a)d.push(P({pubkey:p}));return new et({programId:c,keys:d,data:m})}function Kc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=pt({programId:c,poolId:u,owner:o,version:5}),m=Buffer.alloc(kt.span);kt.encode({instruction:11,amount:ee(s)},m);let d=[P({pubkey:u}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new ae(t.lpVault)}),P({pubkey:i[0]}),P({pubkey:new ae(t.rewardInfos[0].vault)}),P({pubkey:ki,isWritable:!1}),P({pubkey:Ct,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(P({pubkey:i[p]})),d.push(P({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(P({pubkey:p}));return new et({programId:c,keys:d,data:m})}function Cc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:s}=r,[a,c]=[new ae(e.programId),new ae(e.id)],u=pt({programId:a,poolId:c,owner:o,version:6}),l=Buffer.alloc(kt.span);kt.encode({instruction:1,amount:ee(s)},l);let m=[P({pubkey:Ct,isWritable:!1}),P({pubkey:jn.programId,isWritable:!1}),P({pubkey:c}),P({pubkey:new ae(t.authority),isWritable:!1}),P({pubkey:new ae(t.lpVault)}),P({pubkey:u}),P({pubkey:o,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(P({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(P({pubkey:i[d]}));return new et({programId:a,keys:m,data:l})}var lo=class extends Me{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(it)){let n=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:pa(U(M({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:i=fi,txVersion:o,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new Ie(e.lpMint.address),lockInfo:{lockMint:Pc,lockVault:Ac},version:6,rewardInfos:t,programId:i},u=this.createTxBuilder(s),l=n!=null?n:this.scope.ownerPubKey,m=Ge({fromPublicKey:l,programId:c.programId}),d=await this.scope.connection.getMinimumBalanceForRentExemption(to.span);u.addInstruction({instructions:[Dp.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:m.seed,newAccountPubkey:m.publicKey,lamports:d,space:to.span,programId:c.programId})]});let{publicKey:p,nonce:y}=hc({programId:new Ie(c.programId),poolId:m.publicKey}),f=oo({programId:c.programId,poolId:m.publicKey,mint:c.lpMint,type:"lpVault"}),b=[],g=[];for(let h of c.rewardInfos){h.openTime>=h.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",h.openTime.toString()),isNaN(_n[h.rewardType])&&this.logAndCreateError("rewardType error",h.rewardType),Number(h.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",h.perSecond),b.push(Tc(h));let{rewardPubKey:S,newInstruction:x}=await this._getUserRewardInfo({rewardInfo:h,payer:l});x&&u.addInstruction(x),S||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let C=h.mint.equals(it)?new Ie(nt.address):h.mint;g.push({rewardMint:C,rewardVault:oo({programId:c.programId,poolId:m.publicKey,mint:C,type:"rewardVault"}),userRewardToken:S})}let{account:A,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({mint:new Ie(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});k&&u.addInstruction(k),A||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:T,instructionType:I}=Ic({farmId:m.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:f,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:A,programId:c.programId,rewardInfo:g,rewardInfoConfig:b,nonce:y});return u.addInstruction({instructions:[T],instructionTypes:[I]}).versionBuild({txVersion:o,extInfo:{farmId:m.publicKey,farmAuthority:p,lpVault:f,lockUserAccount:A,nonce:y}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:i,feePayer:o}){var g;let s=_t[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Oe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(it)?new Ie(nt.address):n.mint,m=c.rewardInfos.findIndex(A=>new Ie(A.mint.address).equals(l)),d=a.rewardInfos[m];d||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=(g=d.vault)!=null?g:it,y=this.createTxBuilder(o),{rewardPubKey:f,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return b&&y.addInstruction(b),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),y.addInstruction({instructions:[ya({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:f,farmKeys:c,rewardInfo:n})],instructionTypes:[X.FarmV6Restart]}).versionBuild({txVersion:i})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:i,feePayer:o}){var m;let s=_t[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Oe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(o);for(let d of n){let p=d.mint.equals(it)?new Ie(nt.address):d.mint,y=c.rewardInfos.findIndex(T=>new Ie(T.mint.address).equals(p)),f=a.rewardInfos[y];f||this.logAndCreateError("configuration does not exist","rewardMint",p);let b=(m=f.vault)!=null?m:it,{rewardPubKey:g,newInstruction:A}=await this._getUserRewardInfo({rewardInfo:d,payer:u});A&&l.addInstruction(A),g||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let k=ya({payer:this.scope.ownerPubKey,rewardVault:b,userRewardTokenPub:g,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[k],instructionTypes:[X.FarmV6Restart]})}return l.versionBuild({txVersion:i})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:i,payer:o,feePayer:s}=e,a=_t[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Oe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,l=this.createTxBuilder(s),m=i.mint.equals(it)?new Ie(nt.address):i.mint,d=oo({programId:new Ie(n.programId),poolId:new Ie(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:i,payer:u});return y&&l.addInstruction(y),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),i.mint=m,l.addInstruction({instructions:[ba({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:d,rewardInfo:i})],instructionTypes:[X.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:i,payer:o,feePayer:s}=e,a=_t[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Oe((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=o!=null?o:this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let m of i){let d=m.mint.equals(it)?new Ie(nt.address):m.mint,p=oo({programId:new Ie(n.programId),poolId:new Ie(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:m,payer:u});f&&l.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=ba({payer:this.scope.ownerPubKey,userRewardTokenPub:y,farmKeys:c,rewardVault:p,rewardInfo:U(M({},m),{mint:d})});l.addInstruction({instructions:[b],instructionTypes:[X.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:i,feePayer:o,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:m}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:d,programId:p}=n,y=_t[p];y===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),ra(y)||this.logAndCreateError("invalid farm program:",n.programId);let[f,b]=[new Ie(n.programId),new Ie(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],A=pt({programId:f,poolId:b,owner:this.scope.ownerPubKey,version:y}),k=this.createTxBuilder(o);k.addCustomComputeBudget(l),k.addTipInstruction(m);let T={};for(let V of this.scope.account.tokenAccounts)if(a){let _=J(this.scope.ownerPubKey,V.mint,V.programId).publicKey;V.publicKey&&_.equals(V.publicKey)&&(T[V.mint.toString()]=V.publicKey)}else T[V.mint.toString()]=V.publicKey;let I=g.lpMint,h=T[I.address];h||this.logAndCreateError("you don't have any lp","lp zero",T);let S=[];for(let V of d){let _=s&&V.mint.address===Z.toString(),W=T[V.mint.address];if(!W){let{account:Y,instructionParams:se}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:V.mint.programId,mint:new Ie(V.mint.address),notUseTokenAccount:_,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!_,associatedOnly:_?!1:a,checkCreateATAOwner:c});W=Y,se&&k.addInstruction(se)}T[V.mint.address]=W,S.push(W)}let x,C=await this.scope.connection.getAccountInfo(A);if(C&&(x=wi(y).decode(C.data)),n.programId!==fi.toString()&&!x){let{instruction:V,instructionType:_}=so({id:b,programId:f,version:y,ledger:A,owner:this.scope.ownerPubKey});k.addInstruction({instructions:[V],instructionTypes:[_]})}let B=sa({version:y,rewardInfos:d,rewardTokenAccountsPublicKeys:S});B&&this.logAndCreateError(B);let K={amount:ee(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:h,rewardAccounts:S,userAuxiliaryLedgers:u==null?void 0:u.map(V=>new Ie(V))},L=y===6?Cc(K):y===5?Kc(K):Sc(K),R={3:X.FarmV3Deposit,5:X.FarmV5Deposit,6:X.FarmV6Deposit};return k.addInstruction({instructions:[L],instructionTypes:[R[y]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:i,deposited:o,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m,txTipConfig:d}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let y=_t[n.programId];ra(y)||this.logAndCreateError("invalid farm program:",n.programId);let f=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],b=this.createTxBuilder(a);b.addCustomComputeBudget(m),b.addTipInstruction(d);let g={};for(let B of this.scope.account.tokenAccounts)if(c){let K=J(this.scope.ownerPubKey,B.mint).publicKey;B.publicKey&&K.equals(B.publicKey)&&(g[B.mint.toString()]=B.publicKey)}else g[B.mint.toString()]=B.publicKey;if(y!==4){let B=pt({programId:new Ie(n.programId),poolId:new Ie(n.id),owner:this.scope.ownerPubKey,version:y}),K=await this.scope.connection.getAccountInfo(B);if(K)wi(y).decode(K.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(y!==6){let{instruction:L,instructionType:R}=so({id:new Ie(f.id),programId:new Ie(f.programId),version:y,ledger:B,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[L],instructionTypes:[R]})}}o&&o.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let A=f.lpMint.address,k=s&&A===Z.toString(),T=g[A.toString()];if(!T){let{account:B,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.lpMint.programId,mint:new Ie(A),notUseTokenAccount:k,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:k?!1:c,checkCreateATAOwner:u});T=B,K&&b.addInstruction(K)}g[A.toString()]=T;let I=[];for(let B of p){let K=s&&B.mint.address===Z.toString(),L=g[B.mint.address];if(!L){let{account:R,instructionParams:V}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:B.mint.programId,mint:new Ie(B.mint.address),notUseTokenAccount:K,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!K,associatedOnly:K?!1:c,checkCreateATAOwner:u});L=R,V&&b.addInstruction(V)}g[B.mint.address]=L,I.push(L)}let h=sa({version:y,rewardInfos:p,rewardTokenAccountsPublicKeys:I});h&&this.logAndCreateError(h);let S={amount:ee(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:f,lpAccount:T,rewardAccounts:I,userAuxiliaryLedgers:l==null?void 0:l.map(B=>new Ie(B))},x=y===6?ao(S):y===5?uo(S):y===4?xc(S):co(S),C={3:X.FarmV3Withdraw,4:X.FarmV4Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};return b.addInstruction({instructions:[x],instructionTypes:[C[y]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:i,txTipConfig:o,feePayer:s}){var f;this.scope.checkOwner();let a=Oe((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=_t[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(b=>mt(b.mint.address).equals(mt(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=(f=u==null?void 0:u.vault)!=null?f:it,m=this.createTxBuilder(s),d;if(t.equals(it)||t.equals(Ie.default)){let b=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:pa(U(M({},u),{openTime:u.openTime,endTime:u.endTime,perSecond:new O(u.perSecond).mul(10**u.mint.decimals).toString()}))});d=b.addresses.newAccount,m.addInstruction(b)}else{let b=await this.scope.account.getCreatedTokenAccount({mint:t});b===null?(d=await this.scope.account.getAssociatedTokenAccount(t),m.addInstruction({instructions:[Lc(this.scope.ownerPubKey,d,this.scope.ownerPubKey,t)],instructionTypes:[X.CreateATA]})):d=b}let{instruction:p,instructionType:y}=Bc({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:d,owner:this.scope.ownerPubKey});return m.addCustomComputeBudget(i),m.addTipInstruction(o),m.addInstruction({instructions:[p],instructionTypes:[y]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(i),m={};for(let y of this.scope.account.tokenAccounts)if(o){let f=J(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(m[y.mint.toString()]=y.publicKey)}else m[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>U(M({},y),{[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:A}=y,k=_t[f],T=b.address,I=n&&T===Z.toString(),h=m[T];if(!h){let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new Ie(T),notUseTokenAccount:I,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:I?!1:o,checkCreateATAOwner:s});h=L,R&&l.addInstruction(R)}m[T.toString()]=h;let S=[];for(let L of g){let R=n&&L.mint.address===Z.toString(),V=m[L.mint.address];if(!V)if(R){let{account:_,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:L.mint.programId,mint:new Ie(L.mint.address),notUseTokenAccount:R,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!R,associatedOnly:R?!1:o,checkCreateATAOwner:s});V=_,W&&l.addInstruction(W)}else{let _=new Ie(L.mint.address);V=this.scope.account.getAssociatedTokenAccount(_),l.addInstruction({instructions:[Lc(this.scope.ownerPubKey,V,this.scope.ownerPubKey,_)]})}m[L.mint.address]=V,S.push(V)}let x=p[A],C={amount:St,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:x,lpAccount:h,rewardAccounts:S,userAuxiliaryLedgers:a==null?void 0:a.map(L=>new Ie(L))},B=k===6?ao(C):k===5?uo(C):co(C),K={3:X.FarmV3Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};l.addInstruction({instructions:[B],instructionTypes:[K[k]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as He}from"@solana/web3.js";import{AccountLayout as Of,NATIVE_MINT as Qr,TOKEN_PROGRAM_ID as Fn}from"@solana/spl-token";import{Keypair as Fr,PublicKey as Q,SystemProgram as In,TransactionInstruction as ct}from"@solana/web3.js";import Ba from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ao,TOKEN_2022_PROGRAM_ID as We,TOKEN_PROGRAM_ID as xe}from"@solana/spl-token";import Jp from"bn.js";import Vt from"bn.js";var be=new Vt(0),Ot=new Vt(1),kn=new Vt(-1),Ye=new Vt(1).shln(64),Or=new Vt(1).shln(128),mo=Ye.sub(Ot),po=64,Rc=Or.subn(1),ft=-443636,ht=-ft,Ft=new Vt("4295048016"),Dt=new Vt("79226673521066979257578248091"),Mr=new Vt("4295048017"),vr=new Vt("79226673521066979257578248090"),Nc=16,Oc="59543866431248",Mc="184467440737095516",vc="15793534762490258745",Er=new Vt(10).pow(new Vt(6)),Wp=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Wp||{}),yh={[500]:10,[3e3]:60,[1e4]:200},bh={version:6,liquidity:be,tickCurrent:0,feeGrowthGlobalX64A:be,feeGrowthGlobalX64B:be,protocolFeesTokenA:be,protocolFeesTokenB:be,swapInAmountTokenA:be,swapOutAmountTokenB:be,swapInAmountTokenB:be,swapOutAmountTokenA:be,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Ec={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},gh=new Vt("18446744073700000000");import pe from"bn.js";function _r(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function Ah(r){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,r,!1),new Uint8Array(e)}function wh(r){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,r,!1),new Uint8Array(e)}function Vr(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function ga(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function Pa(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function fo(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function _c(r,e){return fo(r,e)?null:ga(r,e)}function Vc(r,e){return fo(r,e)?null:Pa(r,e)}var qp=Buffer.from("amm_config","utf8"),Up=Buffer.from("pool","utf8"),Gp=Buffer.from("pool_vault","utf8"),Xp=Buffer.from("pool_reward_vault","utf8"),Fc=Buffer.from("position","utf8"),Qp=Buffer.from("tick_array","utf8"),zp=Buffer.from("operation","utf8"),Hp=Buffer.from("pool_tick_array_bitmap_extension","utf8"),jp=Buffer.from("observation","utf8");function Ih(r,e){return ie([qp,_r(e)],r)}function Dc(r,e,t,n){return ie([Up,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Aa(r,e,t){return ie([Gp,e.toBuffer(),t.toBuffer()],r)}function Wc(r,e,t){return ie([Xp,e.toBuffer(),t.toBuffer()],r)}function ge(r,e,t){return ie([Qp,e.toBuffer(),Vr(t)],r)}function tn(r,e,t,n){return ie([Fc,e.toBuffer(),Vr(t),Vr(n)],r)}function Tt(r,e){return ie([Fc,e.toBuffer()],r)}function hn(r){return ie([Buffer.from("metadata","utf8"),zt.toBuffer(),r.toBuffer()],zt)}function yo(r){return ie([zp],r)}function Xe(r,e){return ie([Hp,e.toBuffer()],r)}function qc(r,e){return ie([jp,e.toBuffer()],r)}var Uc=Buffer.from("locked_position","utf8");function wa(r,e){return ie([Uc,e.toBuffer()],r)}function hi(r,e){return ie([Uc,e.toBuffer()],r)}var Yp=Buffer.from("support_mint","utf8");function ka(r,e){return ie([Yp,e.toBuffer()],r)}import{PublicKey as Mt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Gc}from"@solana/spl-token";import Ee from"bn.js";import cn from"bn.js";var bo=class{static getfeeGrowthInside(e,t,n){let i=new cn(0),o=new cn(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new cn(0),a=new cn(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ue.wrappingSubU128(ue.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),u=ue.wrappingSubU128(ue.wrappingSubU128(e.feeGrowthGlobalX64B,o),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ue.mulDivFloor(ue.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,Ye),c=t.tokenFeesOwedA.add(a),u=ue.mulDivFloor(ue.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ye),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ue.mulDivFloor(ue.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,Ye),c=t.tokenFeesOwedA.add(a),u=ue.mulDivFloor(ue.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ye),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let o=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ue.wrappingSubU128(c,u.growthInsideLastX64),m=ue.mulDivFloor(l,t.liquidity,Ye),d=u.rewardAmountOwed.add(m);o.push(d)}return o}static GetPositionRewards(e,t,n,i){let o=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ue.wrappingSubU128(c,u.growthInsideLastX64),m=ue.mulDivFloor(l,t.liquidity,Ye),d=u.rewardAmountOwed.add(m);o.push(d)}return o}static getRewardGrowthInside(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new cn(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new cn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(ue.wrappingSubU128(ue.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return o}static getRewardGrowthInsideV2(e,t,n,i){let o=[];for(let s=0;s<i.length;s++){let a=new cn(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new cn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),o.push(ue.wrappingSubU128(ue.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),c))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:o,epochInfo:s}){var b,g,A,k;let a=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),c=oe.getSqrtPriceX64FromTick(t.tickLower),u=oe.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+i:1-i,m=Pe.getAmountsFromLiquidity(a,c,u,n,o),[d,p]=[he(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),he(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[y,f]=[he(new cn(new O(m.amountA.toString()).mul(l).toFixed(0)),(A=e.mintA.extensions)==null?void 0:A.feeConfig,s,!0),he(new cn(new O(m.amountB.toString()).mul(l).toFixed(0)),(k=e.mintB.extensions)==null?void 0:k.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:jt(d.expirationTime,p.expirationTime)}}};var Zp=15,we=class{static async getTickArrays(e,t,n,i,o,s,a){let c=[],u=$.getTickArrayStartIndexByTick(i,o),l=$.getInitializedTickArrayInRange(s,a,o,u,Math.floor(Zp/2));for(let p=0;p<l.length;p++){let{publicKey:y}=ge(t,n,l[p]);c.push(y)}let m=(await Gt(e,c)).map(p=>p!==null?go.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let y=m[p];y!==null&&(d[y.startTickIndex]=U(M({},y),{address:c[p]}))}return d}static nextInitializedTick(e,t,n,i,o,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,i,o,s);for(;a==null||a.liquidityGross.lten(0);){if(u=$.getNextTickArrayStartIndex(u,o,s),this.checkIsValidStartIndex(u,o))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,i,o){let s=Math.floor(e/we.tickCount(t)),a=n?$.searchLowBitFromStart(i,o,s-1,1,t):$.searchHightBitFromStart(i,o,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let o;if(i){let a=tt-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){o=c;break}a=a-1}}else{let a=0;for(;a<tt;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){o=c;break}a=a+1}}let{publicKey:s}=ge(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,o,s){let a=$.getTickArrayStartIndexByTick(i,o),c=Math.floor((i-a)/o),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<tt;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=ge(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if($.checkIsOutOfBoundary(e)){if(e>ht)return!1;let n=$.getTickArrayStartIndexByTick(ft,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return tt*e}};var ha=14,Tn=class{static maxTickInTickarrayBitmap(e){return e*tt*Yn}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let o=n*i;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!we.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),s=i?t-we.tickCount(n):t+we.tickCount(n);if(s<-o||s>=o)return{isInit:!1,tickIndex:t};let a=n*tt,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(i){let l=e.shln(1024-u-1),m=_c(1024,l);if(m!==null){let d=(u-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(u),m=Vc(1024,l);if(m!==null){let d=(u+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:o-we.tickCount(n)}}}},Po=class{static getBitmapOffset(e,t){if(!we.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Tn.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Tn.maxTickInTickarrayBitmap(e),n=-t;if(ht<=t)throw Error(`extensionTickBoundary check error: ${ht}, ${t}`);if(n<=ft)throw Error(`extensionTickBoundary check error: ${n}, ${ft}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:$.mergeTickArrayBitmap(i).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let o=we.tickCount(t),s=n?e-o:e+o,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:o,maxValue:s}=Tn.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let c=$.mergeTickArrayBitmap(e).shln(Yn-1-a),u=fo(512,c)?null:ga(512,c);if(u!==null){let l=t-u*we.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let c=$.mergeTickArrayBitmap(e).shrn(a),u=fo(512,c)?null:Pa(512,c);if(u!==null){let l=t+u*we.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-we.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Tn.maxTickInTickarrayBitmap(t),i=Math.floor(n/we.tickCount(t));return e<0&&n!=0&&(i=Yn-i),i}};var Re=class{static getOutputAmountAndRemainAccounts(e,t,n,i,o,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:y,sqrtPriceX64:f,feeAmount:b}=Zn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,l,o,s);return c.push(...y),{allTrade:d,expectedAmountOut:p.mul(kn),remainingAccounts:c,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,i,o){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=ge(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:y}=Zn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(kn),u,o);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=Re.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Po.checkTickArrayIsInit(we.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):$.checkTickArrayIsInitialized($.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=ge(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:o,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,we.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:a}=ge(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/we.tickCount(e.tickSpacing)),i=t?$.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):$.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=we.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:o}=Tn.nextInitializedTickArrayStartIndex($.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:s,tickIndex:a}=Po.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<ft||t>ht)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:o}){var a,c,u;let s=[];for(let l=0;l<o.length;l++){let m=o[l],d=(u=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?u:(c=await e.getAccountInfo(m.tokenMint))==null?void 0:c.owner;if(d===void 0)throw Error("get new reward mint info error");let p=U(M({},m),{perSecond:ue.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Mt(d)});if(p.tokenMint.equals(Mt.default))continue;if(n<=p.openTime.toNumber()||i.eq(be)){s.push(p);continue}let y=new Ee(Math.min(p.endTime.toNumber(),n)),f=y.sub(p.lastUpdateTime),b=ue.mulDivFloor(f,p.emissionsPerSecondX64,i),g=p.rewardGrowthGlobalX64.add(b),A=ue.mulDivFloor(f,p.emissionsPerSecondX64,Ye),k=p.rewardTotalEmissioned.add(A);s.push(U(M({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:k,lastUpdateTime:y}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let o of t){let s=$.getTickArrayStartIndexByTick(o,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=Tn.maxTickInTickarrayBitmap(e),n=-t;return t>ht&&(t=we.getArrayStartIndex(ht,e)+we.tickCount(e)),n<ft&&(n=we.getArrayStartIndex(ft,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!we.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/we.tickCount(t)*Yn}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Ne(e,t.map(s=>({pubkey:s})),{batchRequest:n}),o={};for(let s of i)s.accountInfo!==null&&(o[s.pubkey.toString()]=Qc.decode(s.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},o=[];for(let c of t){let u=$.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=$.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=ge(c.programId,c.id,m);o.push({pubkey:d}),i[d.toString()]=c.id}}let s=await Ne(e,o,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=i[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=go.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]=U(M({},l),{address:c.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:o=!0}){var a;let s=[];for(let c=0;c<e.length;c++){let u=e[c];u!==null&&(s.find(l=>l.equals(u.state.programId))||s.push(u.state.programId))}if(n){let c=n.tokenAccounts.map(d=>d.accountInfo.mint),u=[];for(let d of c)for(let p of s)u.push(Tt(p,d).publicKey);let l=await Gt(t,u,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let p=Ti.decode(d.data),y=p.poolId.toString(),f=e.find(x=>x.state.id.toBase58()===y);if(f===void 0)continue;let b=f.state,g=$._getTickPriceLegacy({poolInfo:b,tick:p.tickLower,baseIn:!0}),A=$._getTickPriceLegacy({poolInfo:b,tick:p.tickUpper,baseIn:!0}),{amountA:k,amountB:T}=Pe.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,A.tickSqrtPriceX64,p.liquidity,!1),I=1/(1-Math.sqrt(Math.sqrt(g.price.div(A.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:A.price,amountA:k,amountB:T,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(x=>U(M({},x),{pendingReward:new Ee(0)})),leverage:I,tokenFeeAmountA:new Ee(0),tokenFeeAmountB:new Ee(0)}];let h=await $.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickLower,f.state.tickSpacing),S=await $.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=h,m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=S}if(o){let d=Object.values(m),p=await Gt(t,d,{batchRequest:i}),y={};for(let f=0;f<d.length;f++){let b=p[f];if(b===null)continue;let g=d[f].toString();y[g]=go.decode(b.data)}for(let{state:f,positionAccount:b}of e)if(!!b)for(let g of b){let A=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,k=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,T=y[m[A].toString()],I=y[m[k].toString()],h=T.ticks[$.getTickOffsetInArray(g.tickLower,f.tickSpacing)],S=I.ticks[$.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:x,tokenFeeAmountB:C}=await bo.GetPositionFees(f,g,h,S),B=await bo.GetPositionRewards(f,g,h,S);g.tokenFeeAmountA=x.gte(new Ee(0))?x:new Ee(0),g.tokenFeeAmountB=C.gte(new Ee(0))?C:new Ee(0);for(let K=0;K<B.length;K++)g.rewardInfos[K].pendingReward=B[K].gte(new Ee(0))?B[K]:new Ee(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:o,slippage:s,priceLimit:a=new O(0),catchLiquidityInsufficient:c=!1}){var L;let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new O(0))?u=l?Ft.add(new Ee(1)):Dt.sub(new Ee(1)):u=oe.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=he(o,m,i,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:A}=Re.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((L=p.fee)!=null?L:be),u,c),k=he(f,d,i,!1),T=oe.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),I=l?T:new O(1).div(T),h=f.mul(new Ee(Math.floor((1-s)*1e10))).div(new Ee(1e10)),S=he(h,d,i,!1),x=l?e.currentPrice:new O(1).div(e.currentPrice),C=new O(I).sub(x).abs(),B=x,K=new ot(new O(C).mul(10**15).toFixed(0),new O(B).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:p,amountOut:k,minAmountOut:S,expirationTime:jt(p.expirationTime,k.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:K,fee:A,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:o,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=i.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Ve(U(M({},u),{mint:u.address,isToken2022:u.programId===Gc.toBase58()})),new Ve(U(M({},l),{mint:l.address,isToken2022:l.programId===Gc.toBase58()}))],{allTrade:p,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:A,executionPrice:k,priceImpact:T,fee:I,remainingAccounts:h,executionPriceX64:S}=Re.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Mt(u.address),amountIn:n,slippage:o,epochInfo:s,catchLiquidityInsufficient:a}),x=U(M({},y),{amount:new Be(m,y.amount),fee:y.fee===void 0?void 0:new Be(m,y.fee)}),C=U(M({},f),{amount:new Be(d,f.amount),fee:f.fee===void 0?void 0:new Be(d,f.fee)}),B=U(M({},b),{amount:new Be(d,b.amount),fee:b.fee===void 0?void 0:new Be(d,b.fee)}),K=new xt({baseToken:m,denominator:new Ee(10).pow(new Ee(20+m.decimals)),quoteToken:d,numerator:A.mul(new O(10**(20+d.decimals))).toFixed(0)}),L=new xt({baseToken:m,denominator:new Ee(10).pow(new Ee(20+m.decimals)),quoteToken:d,numerator:k.mul(new O(10**(20+d.decimals))).toFixed(0)}),R=new Be(m,I);return{allTrade:p,realAmountIn:x,amountOut:C,minAmountOut:B,expirationTime:g,currentPrice:K,executionPrice:L,priceImpact:T,fee:R,remainingAccounts:h,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:o,slippage:s,priceLimit:a=new O(0)}){var B;let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new O(0))?l=c?Dt.sub(new Ee(1)):Ft.add(new Ee(1)):l=oe.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=he(o,u[n.toString()],i,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:y,feeAmount:f}=Re.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((B=m.fee)!=null?B:be),l),b=c?e.mintB.address:e.mintA.address,g=he(d,u[b],i,!1),A=oe.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),k=c?A:new O(1).div(A),T=d.mul(new Ee(Math.floor((1+s)*1e10))).div(new Ee(1e10)),I=he(T,u[b],i,!0),h=c?e.currentPrice:new O(1).div(e.currentPrice),S=new O(k).sub(h).abs(),x=h,C=new ot(new O(S).mul(10**15).toFixed(0),new O(x).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:I,realAmountOut:m,expirationTime:jt(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:C,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var y,f,b;let o=e[t],s=$.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=$.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),c=Math.max(s,o.priceMin),l=Math.min(a,o.priceMax)-c,m=a-s,d=o.priceMax-o.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:o.feeApr*p,rewardsApr:[((y=o.rewardApr[0])!=null?y:0)*p,((f=o.rewardApr[1])!=null?f:0)*p,((b=o.rewardApr[2])!=null?b:0)*p],apr:o.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:o,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[mt(e.mintA.address).toString()],d=i[mt(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),b=oe.getSqrtPriceX64FromTick(s),g=oe.getSqrtPriceX64FromTick(a),{amountSlippageA:A,amountSlippageB:k}=Pe.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:T,amountSlippageB:I}=Pe.getAmountsFromLiquidityWithSlippage(f,b,g,o,!1,!1,0),h=new O(A.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(k.toString()).div(new O(10).pow(y)).mul(d.value)),S=new O(T.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(I.toString()).div(new O(10).pow(y)).mul(d.value)),x=new O(1).div(h.add(S)),B=new O(l.volumeFee).mul(365).div(u).mul(x).mul(100).toNumber(),K=3600*24*365,L=e.rewardDefaultInfos.map(R=>{var W,Y;let V=R.mint.decimals,_=i[R.mint.address];return c<((W=R.startTime)!=null?W:0)||c>((Y=R.endTime)!=null?Y:0)||!R.perSecond||!_||V===void 0?0:new O(_.value).mul(new O(R.perSecond).mul(K)).div(new O(10).pow(V)).mul(x).mul(100).toNumber()});return{feeApr:B,rewardsApr:L,apr:B+L.reduce((R,V)=>R+V,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:o,slippage:s,add:a,epochInfo:c,amountHasFee:u}){var g,A;let l=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),m=oe.getSqrtPriceX64FromTick(n),d=oe.getSqrtPriceX64FromTick(i),p=he(o,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,c,!u),y=new Ee(new O(p.amount.sub((A=p.fee)!=null?A:be).toString()).toFixed(0)),f;if(l.lte(m))f=t?Pe.getLiquidityFromTokenAmountA(m,d,y,!a):new Ee(0);else if(l.lte(d)){let k=Pe.getLiquidityFromTokenAmountA(l,d,y,!a),T=Pe.getLiquidityFromTokenAmountB(m,l,y);f=t?k:T}else f=t?new Ee(0):Pe.getLiquidityFromTokenAmountB(m,d,y);let b=await Re.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:i,liquidity:f,slippage:s,add:a});return{liquidity:f,amountA:t?p:b.amountA,amountB:t?b.amountB:p,amountSlippageA:t?p:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:p,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:o,slippage:s,add:a}){var b,g,A,k;let c=oe.getSqrtPriceX64FromTick(n),u=oe.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=Pe.getAmountsFromLiquidity(oe.priceToSqrtPriceX64(new O(t.price),t.mintA.decimals,t.mintB.decimals),c,u,o,a),[d,p]=[he(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),he(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[y,f]=[he(m.amountA.muln(l),(A=t.mintA.extensions)==null?void 0:A.feeConfig,e,!0),he(m.amountB.muln(l),(k=t.mintB.extensions)==null?void 0:k.feeConfig,e,!0)];return{liquidity:o,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:jt(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(c=>!n[c.id]).map(c=>new Mt(c.id));(await Gt(e,i)).forEach((c,u)=>{!c||(n[i[u].toBase58()]=$n.decode(c.data))});let s=t.map(c=>Xe(new Mt(c.programId),new Mt(c.id)).publicKey),a=await Re.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>U(M({},c),{[u.id]:U(M({},n[u.id]),{id:new Mt(u.id),version:6,programId:new Mt(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:U(M({},u.config),{id:new Mt(u.config.id),fundOwner:""}),currentPrice:new O(u.price),exBitmapAccount:Xe(new Mt(u.programId),new Mt(u.id)).publicKey,exBitmapInfo:a[Xe(new Mt(u.programId),new Mt(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function cT({poolInfo:r,tickLower:e,tickUpper:t,amountA:n,amountB:i,slippage:o,add:s,epochInfo:a,amountHasFee:c}){var k,T,I,h;let[u,l,m,d]=e<t?[e,t,n,i]:[t,e,i,n],p=oe.priceToSqrtPriceX64(new O(r.price),r.mintA.decimals,r.mintB.decimals),y=oe.getSqrtPriceX64FromTick(u),f=oe.getSqrtPriceX64FromTick(l),[b,g]=[he(m,(k=r.mintA.extensions)==null?void 0:k.feeConfig,a,!c),he(d,(T=r.mintB.extensions)==null?void 0:T.feeConfig,a,!c)],A=Pe.getLiquidityFromTokenAmounts(p,y,f,b.amount.sub((I=b.fee)!=null?I:be),g.amount.sub((h=g.fee)!=null?h:be));return Pe.getAmountsOutFromLiquidity({poolInfo:r,tickLower:e,tickUpper:t,liquidity:A,slippage:o,add:s,epochInfo:a,amountAddFee:!c})}var Ta={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function Xc(r){return U(M({},r),{type:"Concentrated",programId:r.programId.toString(),id:r.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:r.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:r.ammConfig.tradeFeeRate,openTime:r.startTime.toString(),tvl:0,day:Ta,week:Ta,month:Ta,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:U(M({},r.ammConfig),{id:r.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var ue=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),o=i.div(n);return i.mod(n).eq(be)||(o=o.add(Ot)),o}static mulDivFloor(e,t,n){if(n.eq(be))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(be))throw new Error("division by 0");return e.mul(t).add(n.sub(Ot)).div(n)}static x64ToDecimal(e,t){return new O(e.toString()).div(O.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new pe(e.mul(O.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Or).sub(t).mod(Or)}};function st(r,e){return Ia(r.mul(e),64,256)}function $p(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Ia(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var oe=class{static sqrtPriceX64ToPrice(e,t,n){return ue.x64ToDecimal(e).pow(2).mul(O.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ue.decimalToX64(e.mul(O.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(be))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(be))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(be))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(be))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(be))return e;let o=t.shln(po);if(i){let s=o,a=o.add(n.mul(e));return a.gte(s)?ue.mulDivCeil(s,e,a):ue.mulDivRoundingUp(s,Ot,s.div(e).add(n))}else{let s=n.mul(e);if(!o.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=o.sub(s);return ue.mulDivCeil(o,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let o=n.shln(po);if(i)return e.add(o.div(t));{let s=ue.mulDivRoundingUp(o,Ot,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<ft||e>ht)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new pe("18445821805675395072"):new pe("18446744073709551616");return(t&2)!=0&&(n=st(n,new pe("18444899583751176192"))),(t&4)!=0&&(n=st(n,new pe("18443055278223355904"))),(t&8)!=0&&(n=st(n,new pe("18439367220385607680"))),(t&16)!=0&&(n=st(n,new pe("18431993317065453568"))),(t&32)!=0&&(n=st(n,new pe("18417254355718170624"))),(t&64)!=0&&(n=st(n,new pe("18387811781193609216"))),(t&128)!=0&&(n=st(n,new pe("18329067761203558400"))),(t&256)!=0&&(n=st(n,new pe("18212142134806163456"))),(t&512)!=0&&(n=st(n,new pe("17980523815641700352"))),(t&1024)!=0&&(n=st(n,new pe("17526086738831433728"))),(t&2048)!=0&&(n=st(n,new pe("16651378430235570176"))),(t&4096)!=0&&(n=st(n,new pe("15030750278694412288"))),(t&8192)!=0&&(n=st(n,new pe("12247334978884435968"))),(t&16384)!=0&&(n=st(n,new pe("8131365268886854656"))),(t&32768)!=0&&(n=st(n,new pe("3584323654725218816"))),(t&65536)!=0&&(n=st(n,new pe("696457651848324352"))),(t&131072)!=0&&(n=st(n,new pe("26294789957507116"))),(t&262144)!=0&&(n=st(n,new pe("37481735321082"))),e>0&&(n=Rc.div(n)),n}static getTickFromPrice(e,t,n){return oe.getTickFromSqrtPriceX64(oe.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Dt)||e.lt(Ft))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new pe(t-64),i=$p(n,32,128),o=new pe("8000000000000000","hex"),s=0,a=new pe(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new pe(0))&&s<Nc;){c=c.mul(c);let y=c.shrn(127);c=c.shrn(63+y.toNumber()),a=a.add(o.mul(y)),o=o.shrn(1),s+=1}let u=a.shrn(32),m=i.add(u).mul(new pe(Oc)),d=Ia(m.sub(new pe(Mc)),64,128).toNumber(),p=Ia(m.add(new pe(vc)),64,128).toNumber();return d==p?d:oe.getSqrtPriceX64FromTick(p).lte(e)?p:d}},Jn=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=oe.getTickFromSqrtPriceX64(oe.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let o=Jn.getTickWithPriceAndTickspacing(e,t,n,i),s=oe.getSqrtPriceX64FromTick(o);return oe.sqrtPriceX64ToPrice(s,n,i)}},Pe=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(be))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln(po),s=t.sub(e);return i?ue.mulDivRoundingUp(ue.mulDivCeil(o,s,t),Ot,e):ue.mulDivFloor(o,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(be))throw new Error("sqrtPriceX64A must greater than 0");return i?ue.mulDivCeil(n,t.sub(e),Ye):ue.mulDivFloor(n,t.sub(e),Ye)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),s=t.sub(e),a=o.div(s);return i?ue.mulDivRoundingUp(a,Ot,mo):a.shrn(po)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ue.mulDivFloor(n,mo,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return Pe.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=Pe.getLiquidityFromTokenAmountA(e,n,i,!1),a=Pe.getLiquidityFromTokenAmountB(t,e,o);return s.lt(a)?s:a}else return Pe.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:Pe.getTokenAmountAFromLiquidity(t,n,i,o),amountB:new pe(0)};if(e.lt(n)){let s=Pe.getTokenAmountAFromLiquidity(e,n,i,o),a=Pe.getTokenAmountBFromLiquidity(t,e,i,o);return{amountA:s,amountB:a}}else return{amountA:new pe(0),amountB:Pe.getTokenAmountBFromLiquidity(t,n,i,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,o,s,a){let{amountA:c,amountB:u}=Pe.getAmountsFromLiquidity(e,t,n,i,s),l=o?1+a:1-a,m=new pe(new O(c.toString()).mul(l).toFixed(0)),d=new pe(new O(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:o,add:s,epochInfo:a,amountAddFee:c}){var A,k,T,I;let u=oe.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),l=oe.getSqrtPriceX64FromTick(t),m=oe.getSqrtPriceX64FromTick(n),d=s?1+o:1-o,p=Pe.getAmountsFromLiquidity(u,l,m,i,s),[y,f]=[he(p.amountA,(A=e.mintA.extensions)==null?void 0:A.feeConfig,a,c),he(p.amountB,(k=e.mintB.extensions)==null?void 0:k.feeConfig,a,c)],[b,g]=[he(new pe(new O(p.amountA.toString()).mul(d).toFixed(0)),(T=e.mintA.extensions)==null?void 0:T.feeConfig,a,c),he(new pe(new O(p.amountB.toString()).mul(d).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,a,c)];return{liquidity:i,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:jt(y.expirationTime,f.expirationTime)}}},Zn=class{static swapCompute(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f=!1){if(d.eq(be))throw new Error("amountSpecified must not be 0");if(y||(y=s?Ft.add(Ot):Dt.sub(Ot)),s){if(y.lt(Ft))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(Dt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let b=d.gt(be),g={amountSpecifiedRemaining:d,amountCalculated:be,sqrtPriceX64:m,tick:u>p?Math.min(p+we.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new pe(0)},A=p,k=n[p],T=0,I=!s&&k.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(be)&&!g.sqrtPriceX64.eq(y);){T>10;let h={};h.sqrtPriceStartX64=g.sqrtPriceX64;let S=$.nextInitTick(k,g.tick,l,s,I),x=S||null,C=null;if(!(x!=null&&x.liquidityGross.gtn(0))){let K=Re.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:o},A,s);if(!K.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}A=K.nextStartIndex;let{publicKey:L}=ge(e,t,A);C=L,k=n[A];try{x=$.firstInitializedTick(k,s)}catch{throw Error("not found next tick info")}}h.tickNext=x.tick,h.initialized=x.liquidityGross.gtn(0),p!==A&&C&&(g.accounts.push(C),p=A),h.tickNext<ft?h.tickNext=ft:h.tickNext>ht&&(h.tickNext=ht),h.sqrtPriceNextX64=oe.getSqrtPriceX64FromTick(h.tickNext);let B;if(s&&h.sqrtPriceNextX64.lt(y)||!s&&h.sqrtPriceNextX64.gt(y)?B=y:B=h.sqrtPriceNextX64,[g.sqrtPriceX64,h.amountIn,h.amountOut,h.feeAmount]=Zn.swapStepCompute(g.sqrtPriceX64,B,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(h.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(h.amountIn.add(h.feeAmount)),g.amountCalculated=g.amountCalculated.sub(h.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(h.amountOut),g.amountCalculated=g.amountCalculated.add(h.amountIn.add(h.feeAmount))),g.sqrtPriceX64.eq(h.sqrtPriceNextX64)){if(h.initialized){let K=x.liquidityNet;s&&(K=K.mul(kn)),g.liquidity=Pe.addDelta(g.liquidity,K)}I=h.tickNext!=g.tick&&!s&&k.startTickIndex===h.tickNext,g.tick=s?h.tickNext-1:h.tickNext}else if(g.sqrtPriceX64!=h.sqrtPriceStartX64){let K=oe.getTickFromSqrtPriceX64(g.sqrtPriceX64);I=K!=g.tick&&!s&&k.startTickIndex===K,g.tick=K}++T}try{let{nextStartIndex:h,isExist:S}=we.nextInitializedTickArray(g.tick,l,s,i,o);S&&p!==h&&(g.accounts.push(ge(e,t,h).publicKey),p=h)}catch{}return{allTrade:!0,amountSpecifiedRemaining:be,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,o,s){let a={sqrtPriceX64Next:new pe(0),amountIn:new pe(0),amountOut:new pe(0),feeAmount:new pe(0)},c=i.gte(be);if(c){let l=ue.mulDivFloor(i,Er.sub(new pe(o.toString())),Er);a.amountIn=s?Pe.getTokenAmountAFromLiquidity(t,e,n,!0):Pe.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=oe.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?Pe.getTokenAmountBFromLiquidity(t,e,n,!1):Pe.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(kn).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=oe.getNextSqrtPriceX64FromOutput(e,n,i.mul(kn),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=Pe.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=Pe.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:Pe.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:Pe.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(i.mul(kn))&&(a.amountOut=i.mul(kn)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=i.sub(a.amountIn):a.feeAmount=ue.mulDivCeil(a.amountIn,new pe(o),Er.sub(new pe(o))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var tt=60,Yn=512,$=class{static getTickArrayAddressByTick(e,t,n,i){let o=$.getTickArrayStartIndexByTick(n,i),{publicKey:s}=ge(e,t,o);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=$.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=tt)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=we.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*we.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*tt,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*tt,o=Math.floor(t/i)+512,s=Math.abs(o);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*tt:e+t*tt}static mergeTickArrayBitmap(e){let t=new Jp(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,o){let s=Math.floor(i/(n*tt));return[...$.searchLowBitFromStart(e,t,s-1,o,n),...$.searchHightBitFromStart(e,t,s,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return $.searchHightBitFromStart(e,t,-7680,Yn,n)}static getAllInitializedTickArrayInfo(e,t,n,i,o){let s=[],a=$.getAllInitializedTickArrayStartIndex(n,i,o);for(let c of a){let{publicKey:u}=ge(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>$.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===i)break}let c=we.tickCount(o);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,i,o){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>$.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===i)break}let c=we.tickCount(o);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<ft||e>ht}static nextInitTick(e,t,n,i,o){if(we.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(o||(a=a+1);a<tt;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=tt-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<tt;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=oe.getSqrtPriceX64FromTick(t),o=oe.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(o),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),o=Jn.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=oe.getSqrtPriceX64FromTick(o),a=oe.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new O(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=oe.getSqrtPriceX64FromTick(t),o=oe.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(o),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),o=Jn.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=oe.getSqrtPriceX64FromTick(o),a=oe.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:a}:{tick:o,price:new O(1).div(a)}}};var zc=E([Te(8),q("bump"),$t("index"),N(""),ut("protocolFeeRate"),ut("tradeFeeRate"),$t("tickSpacing"),H(w(),8,"")]),ef=E([ut("blockTimestamp"),gi("tickCumulative"),H(w(),4)]),Hc=E([Te(8),Fe("initialized"),w("recentEpoch"),$t("observationIndex"),N("poolId"),H(ef,100,"observations"),H(w(),4)]),tf=E([q("rewardState"),w("openTime"),w("endTime"),w("lastUpdateTime"),te("emissionsPerSecondX64"),w("rewardTotalEmissioned"),w("rewardClaimed"),N("tokenMint"),N("tokenVault"),N("creator"),te("rewardGrowthGlobalX64")]),$n=E([Te(8),q("bump"),N("ammConfig"),N("creator"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("observationId"),q("mintDecimalsA"),q("mintDecimalsB"),$t("tickSpacing"),te("liquidity"),te("sqrtPriceX64"),ve("tickCurrent"),ut(),te("feeGrowthGlobalX64A"),te("feeGrowthGlobalX64B"),w("protocolFeesTokenA"),w("protocolFeesTokenB"),te("swapInAmountTokenA"),te("swapOutAmountTokenB"),te("swapInAmountTokenB"),te("swapOutAmountTokenA"),q("status"),H(q(),7,""),H(tf,3,"rewardInfos"),H(w(),16,"tickArrayBitmap"),w("totalFeesTokenA"),w("totalFeesClaimedTokenA"),w("totalFeesTokenB"),w("totalFeesClaimedTokenB"),w("fundFeesTokenA"),w("fundFeesTokenB"),w("startTime"),H(w(),15*4-3,"padding")]),nf=E([te("growthInsideLastX64"),w("rewardAmountOwed")]),Ti=E([Te(8),q("bump"),N("nftMint"),N("poolId"),ve("tickLower"),ve("tickUpper"),te("liquidity"),te("feeGrowthInsideLastX64A"),te("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),H(nf,3,"rewardInfos"),H(w(),8,"")]),OT=E([Te(8),q("bump"),N("poolId"),ve("tickLowerIndex"),ve("tickUpperIndex"),te("liquidity"),te("feeGrowthInsideLastX64A"),te("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),H(te(),3,"rewardGrowthInside"),H(w(),8,"")]),of=E([ve("tick"),ac("liquidityNet"),te("liquidityGross"),te("feeGrowthOutsideX64A"),te("feeGrowthOutsideX64B"),H(te(),3,"rewardGrowthsOutsideX64"),H(ut(),13,"")]),go=E([Te(8),N("poolId"),ve("startTickIndex"),H(of,tt,"ticks"),q("initializedTickCount"),H(q(),115,"")]),jc=E([Te(329),H(N(),100,"whitelistMints")]),Qc=E([Te(8),N("poolId"),H(H(w(),8),ha,"positiveTickArrayBitmap"),H(H(w(),8),ha,"negativeTickArrayBitmap")]),MT=E([w(),q("bump"),N("owner"),N("poolId"),N("positionId"),N("nftAccount"),H(w(),8)]),Yc=E([Te(8),q("bump"),N("lockOwner"),N("poolId"),N("positionId"),N("nftAccount"),N("lockNftMint"),w("recentEpoch"),H(w(),8)]);Hc.span;var Zc=fe("Raydium_Clmm"),vt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},$c=[188,37,179,131,82,150,84,73],Jc=[16,72,250,198,14,162,212,19],Se=class{static createPoolInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,y){let f=E([te("sqrtPriceX64"),w("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},...(y==null?void 0:y.map(k=>({pubkey:k,isSigner:!1,isWritable:!1})))||[]],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,zero:be},g);let A=Buffer.from([...vt.createPool,...g]);return new ct({keys:b,programId:e,data:A})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:o,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new Q(i.address),new Q(o.address)],{publicKey:m}=Dc(t,s,u,l),{publicKey:d}=qc(t,m),{publicKey:p}=Aa(t,m,u),{publicKey:y}=Aa(t,m,l),f=Xe(t,m).publicKey,b=[this.createPoolInstruction(t,m,n,s,d,u,p,new Q(i.programId||xe),l,y,new Q(o.programId||xe),f,a,c)];return{signers:[],instructions:b,instructionTypes:[X.CreateAccount,X.ClmmCreatePool],address:{poolId:m,observationId:d,exBitmapAccount:f,mintAVault:p,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A,k,T,I,h,S,x,C,B){let K=E([ve("tickLowerIndex"),ve("tickUpperIndex"),ve("tickArrayLowerStartIndex"),ve("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),Fe("withMetadata"),q("optionBaseFlag"),Fe("baseFlag")]),L=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:Ao,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],V=Buffer.alloc(K.span);K.encode({tickLowerIndex:A,tickUpperIndex:k,tickArrayLowerStartIndex:T,tickArrayUpperStartIndex:I,liquidity:h,amountMaxA:S,amountMaxB:x,withMetadata:C==="create",baseFlag:!1,optionBaseFlag:0},V);let _=Buffer.from([...vt.openPosition,...V]);return new ct({keys:R,programId:e,data:_})}static openPositionFromLiquidityInstruction22(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A,k,T,I,h,S,x,C){let B=E([ve("tickLowerIndex"),ve("tickUpperIndex"),ve("tickArrayLowerStartIndex"),ve("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),Fe("withMetadata"),q("optionBaseFlag"),Fe("baseFlag")]),K=[...C?[{pubkey:C,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:Ao,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...K],R=Buffer.alloc(B.span);B.encode({tickLowerIndex:g,tickUpperIndex:A,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:T,liquidity:I,amountMaxA:h,amountMaxB:S,withMetadata:x==="create",baseFlag:!1,optionBaseFlag:0},R);let V=Buffer.from([...vt.openPositionWithTokenEx,...R]);return new ct({keys:L,programId:e,data:V})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,y]=[new Q(e.programId),new Q(e.id)],f;if(l)f=new Q((await l(1))[0]);else{let C=Fr.generate();d.push(C),f=C.publicKey}let b=$.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=$.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:A}=ge(p,y,b),{publicKey:k}=ge(p,y,g),{publicKey:T}=m?J(n.wallet,f,We):J(n.wallet,f,xe),{publicKey:I}=hn(f),{publicKey:h}=Tt(p,f),{publicKey:S}=tn(p,y,i,o),x=m?this.openPositionFromLiquidityInstruction22(p,n.feePayer,y,n.wallet,f,T,S,A,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,o,b,g,s,a,c,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Xe(p,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,y,n.wallet,f,T,I,S,A,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,o,b,g,s,a,c,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Xe(p,y).publicKey:void 0);return{signers:d,instructions:[x],instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:A,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,y]=[new Q(e.programId),new Q(e.id)],f;if(l)f=new Q((await l(1))[0]);else{let C=Fr.generate();d.push(C),f=C.publicKey}let b=$.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=$.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:A}=ge(p,y,b),{publicKey:k}=ge(p,y,g),{publicKey:T}=m?J(n.wallet,f,We):J(n.wallet,f,xe),{publicKey:I}=hn(f),{publicKey:h}=Tt(p,f),{publicKey:S}=tn(p,y,i,o),x=m?this.openPositionFromBaseInstruction22(p,n.feePayer,y,n.wallet,f,T,S,A,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,o,b,g,u,s,a,c,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Xe(p,y).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,y,n.wallet,f,T,I,S,A,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),i,o,b,g,u,s,a,c,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Xe(p,y).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:A,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S},instructions:[x],signers:d,instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A,k,T,I,h,S,x,C,B){let K=E([ve("tickLowerIndex"),ve("tickUpperIndex"),ve("tickArrayLowerStartIndex"),ve("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),Fe("withMetadata"),q("optionBaseFlag"),Fe("baseFlag")]),L=[...B?[{pubkey:B,isSigner:!1,isWritable:!0}]:[]],R=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:Ao,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...L],V=Buffer.alloc(K.span);K.encode({tickLowerIndex:A,tickUpperIndex:k,tickArrayLowerStartIndex:T,tickArrayUpperStartIndex:I,liquidity:new Ba(0),amountMaxA:S==="MintA"?x:C,amountMaxB:S==="MintA"?C:x,withMetadata:h==="create",baseFlag:S==="MintA",optionBaseFlag:1},V);let _=Buffer.from([...vt.openPosition,...V]);return new ct({keys:R,programId:e,data:_})}static openPositionFromBaseInstruction22(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A,k,T,I,h,S,x,C){let B=E([ve("tickLowerIndex"),ve("tickUpperIndex"),ve("tickArrayLowerStartIndex"),ve("tickArrayUpperStartIndex"),te("liquidity"),w("amountMaxA"),w("amountMaxB"),Fe("withMetadata"),q("optionBaseFlag"),Fe("baseFlag")]),K=[...C?[{pubkey:C,isSigner:!1,isWritable:!0}]:[]],L=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:Ao,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...K],R=Buffer.alloc(B.span);B.encode({tickLowerIndex:g,tickUpperIndex:A,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:T,liquidity:new Ba(0),amountMaxA:h==="MintA"?S:x,amountMaxB:h==="MintA"?x:S,withMetadata:I==="create",baseFlag:h==="MintA",optionBaseFlag:1},R);let V=Buffer.from([...vt.openPositionWithTokenEx,...R]);return new ct({keys:L,programId:e,data:V})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d,p=[];if(l)d=new Q((await l(1))[0]);else{let C=Fr.generate();p.push(C),d=C.publicKey}let[y,f]=[new Q(e.programId),new Q(e.id)],b=$.getTickArrayStartIndexByTick(i,e.config.tickSpacing),g=$.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:A}=ge(y,f,b),{publicKey:k}=ge(y,f,g),{publicKey:T}=m?J(n.wallet,d,We):J(n.wallet,d,xe),{publicKey:I}=hn(d),{publicKey:h}=Tt(y,d),{publicKey:S}=tn(y,f,i,o),x=m?this.openPositionFromLiquidityInstruction22(y,n.wallet,f,n.wallet,d,T,S,A,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(t.mintA.address),new Q(t.mintB.address),i,o,b,g,s,a,c,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Xe(y,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(y,n.wallet,f,n.wallet,d,T,I,S,A,k,h,n.tokenAccountA,n.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(t.mintA.address),new Q(t.mintB.address),i,o,b,g,s,a,c,u,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Xe(y,f).publicKey:void 0);return{address:{nftMint:d,tickArrayLower:A,tickArrayUpper:k,positionNftAccount:T,metadataAccount:I,personalPosition:h,protocolPosition:S},instructions:[x],signers:p,instructionTypes:[X.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,o,s){let a=E([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:s?We:xe,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...vt.closePosition,...u]);return new ct({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i,nft2022:o}){let s=new Q(e.programId),a=o?J(n.wallet,i.nftMint,We).publicKey:J(n.wallet,i.nftMint,xe).publicKey,{publicKey:c}=Tt(s,i.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,i.nftMint,a,c,o)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[X.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A){let k=E([te("liquidity"),w("amountMaxA"),w("amountMaxB"),q("optionBaseFlag"),Fe("baseFlag")]),T=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...T],h=Buffer.alloc(k.span);k.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},h);let S=Buffer.from([...vt.increaseLiquidity,...h]);return new ct({keys:I,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:o,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new Q(e.programId),new Q(e.id)],m=$.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=$.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ge(u,l,m),{publicKey:y}=ge(u,l,d),{publicKey:f}=c?J(i.wallet,n.nftMint,We):J(i.wallet,n.nftMint,xe),{publicKey:b}=Tt(u,n.nftMint),{publicKey:g}=tn(u,l,n.tickLower,n.tickUpper),A=this.increasePositionFromLiquidityInstruction(u,i.wallet,f,b,l,g,p,y,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),o,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Xe(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:[A],instructionTypes:[X.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:o,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new Q(e.programId),new Q(e.id)],m=$.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=$.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ge(u,l,m),{publicKey:y}=ge(u,l,d),{publicKey:f}=c?J(i.wallet,n.nftMint,We):J(i.wallet,n.nftMint,xe),{publicKey:b}=Tt(u,n.nftMint),{publicKey:g}=tn(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,f,b,l,g,p,y,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),o,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Xe(u,l).publicKey:void 0)],signers:[],instructionTypes:[X.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A){let k=E([te("liquidity"),w("amountMaxA"),w("amountMaxB"),q("optionBaseFlag"),Fe("baseFlag")]),T=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...T],h=Buffer.alloc(k.span);k.encode({liquidity:new Ba(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},h);let S=Buffer.from([...vt.increaseLiquidity,...h]);return new ct({keys:I,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A,k){let T=E([te("liquidity"),w("amountMinA"),w("amountMinB")]),I=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...f.map(C=>[{pubkey:C.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:C.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:C.rewardMint,isSigner:!1,isWritable:!1}]).flat()],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...I],S=Buffer.alloc(T.span);T.encode({liquidity:b,amountMinA:g,amountMinB:A},S);let x=Buffer.from([...vt.decreaseLiquidity,...S]);return new ct({keys:h,programId:e,data:x})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:o,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],d=$.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=$.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:y}=ge(l,m,d),{publicKey:f}=ge(l,m,p),{publicKey:b}=u?J(i.wallet,n.nftMint,We):J(i.wallet,n.nftMint,c),{publicKey:g}=Tt(l,n.nftMint),{publicKey:A}=tn(l,m,n.tickLower,n.tickUpper),k=[];for(let h=0;h<e.rewardDefaultInfos.length;h++)k.push({poolRewardVault:new Q(t.rewardInfos[h].vault),ownerRewardVault:i.rewardAccounts[h],rewardMint:new Q(e.rewardDefaultInfos[h].mint.address)});let T=[],I=this.decreaseLiquidityInstruction(l,i.wallet,b,g,m,A,y,f,i.tokenAccountA,i.tokenAccountB,new Q(t.vault.A),new Q(t.vault.B),new Q(e.mintA.address),new Q(e.mintB.address),k,o,s,a,Re.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,p])?Xe(l,m).publicKey:void 0);return T.push(I),{address:{tickArrayLower:y,tickArrayUpper:f,positionNftAccount:b,personalPosition:g,protocolPosition:A},signers:[],instructions:T,instructionTypes:[X.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g){let A=E([w("amount"),w("otherAmountThreshold"),te("sqrtPriceLimitX64"),Fe("isBaseInput")]),k=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],I=Buffer.alloc(A.span);A.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},I);let h=Buffer.from([...vt.swap,...I]);return new ct({keys:T,programId:e,data:h})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:o,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],[d,p]=[new Q(t.vault.A),new Q(t.vault.B)],[y,f]=[new Q(e.mintA.address),new Q(e.mintB.address)],b=e.mintA.address===o.toString(),g=[this.swapInstruction(l,i.wallet,m,new Q(e.config.id),b?i.tokenAccountA:i.tokenAccountB,b?i.tokenAccountB:i.tokenAccountA,b?d:p,b?p:d,b?y:f,b?f:y,u,n,s,a,c,!0,Xe(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[X.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:o,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new Q(e.programId),new Q(e.id)],[d,p]=[new Q(t.vault.A),new Q(t.vault.B)],[y,f]=[new Q(e.mintA.address),new Q(e.mintB.address)],b=e.mintA.address===o.toBase58(),g=[this.swapInstruction(l,i.wallet,m,new Q(e.config.id),b?i.tokenAccountB:i.tokenAccountA,b?i.tokenAccountA:i.tokenAccountB,b?p:d,b?d:p,b?f:y,b?y:f,u,n,s,a,c,!1,Xe(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[X.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,o,s,a,c,u,l,m,d){let p=E([w("openTime"),w("endTime"),te("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:ee(l),endTime:ee(m),emissionsPerSecondX64:d},f);let b=Buffer.from([...vt.initReward,...f]);return new ct({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[o,s]=[new Q(e.programId),new Q(e.id)],a=Wc(o,s,i.mint).publicKey,c=yo(o).publicKey,u=[this.initRewardInstruction(o,n.wallet,s,c,new Q(e.config.id),n.tokenAccount,i.programId,i.mint,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[X.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,o,s,a,c,u,l,m,d){let p=E([q("rewardIndex"),te("emissionsPerSecondX64"),w("openTime"),w("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:ee(l),endTime:ee(m)},f);let b=Buffer.from([...vt.setRewardEmissions,...f]);return new ct({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[o,s]=[new Q(e.programId),new Q(e.id)],a,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===i.mint.toString()&&(a=d,c=new Q(t.rewardInfos[d].vault),u=new Q(t.rewardInfos[d].mint.address));(a===void 0||c===void 0)&&Zc.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=yo(o).publicKey,m=[this.setRewardInstruction(o,n.wallet,s,l,new Q(e.config.id),n.tokenAccount,c,u,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[X.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,o,s,a){let c=E([q("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let m=Buffer.from([...vt.collectReward,...l]);return new ct({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[o,s]=[new Q(e.programId),new Q(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(a=l,c=new Q(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&Zc.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(o,n.wallet,s,n.tokenAccount,c,i,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[X.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:o,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new Q((await c(1))[0]);else{let g=Fr.generate();u.push(g),l=g.publicKey}let m=a?J(o,s,We).publicKey:J(o,s,xe).publicKey,{publicKey:d}=Tt(n,s),p=hi(e,l).publicKey,y=J(o,l,xe).publicKey,f=hn(l).publicKey,b=Se.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:o,lockOwner:o,positionNftAccount:m,positionId:d,lockPositionId:p,lockNftMint:l,lockNftAccount:y,metadataAccount:f,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:J(t,s,a?We:xe).publicKey,positionNftProgram:a?We:xe});return{address:{positionId:d,lockPositionId:p,lockNftAccount:y,lockNftMint:l,positionNftAccount:m,metadataAccount:f},instructions:[b],signers:u,instructionTypes:[X.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:o,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:m,lockNftMint:d,lockNftAccount:p,metadataAccount:y,withMetadata:f}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:Ao,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1}],g=E([Fe("withMetadata")]),A=Buffer.alloc(g.span);g.encode({withMetadata:f},A);let k=Buffer.from([...$c,...A]);return new ct({keys:b,programId:e,data:k})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:o}){let{publicKey:s}=J(i,o,xe),{publicKey:a}=Tt(n,o),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:wa(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1}];return new ct({keys:c,programId:e,data:Buffer.from($c)})}static harvestLockPositionInstruction(e){let[t,n]=[new Q(e.poolKeys.programId),new Q(e.poolKeys.id)],i=$.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),o=$.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=ge(t,n,i),{publicKey:a}=ge(t,n,o),{publicKey:c}=J(e.owner,e.ownerPosition.nftMint,xe),{publicKey:u}=Tt(t,e.ownerPosition.nftMint),{publicKey:l}=tn(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)m.push({poolRewardVault:new Q(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new Q(e.poolKeys.rewardInfos[y].mint.address)});let d=[...m.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:wa(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new Q(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new Q(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1},{pubkey:new Q(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new Q(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new ct({keys:p,programId:e.programId,data:Buffer.from(Jc)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:o,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:m,vaultA:d,vaultB:p,tickArrayLower:y,tickArrayUpper:f,userVaultA:b,userVaultB:g,mintA:A,mintB:k,rewardAccounts:T,exTickArrayBitmap:I}){let h=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[],...T.map(x=>[{pubkey:x.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.rewardMint,isSigner:!1,isWritable:!1}]).flat()],S=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:xe,isSigner:!1,isWritable:!1},{pubkey:We,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1},{pubkey:A,isSigner:!1,isWritable:!1},{pubkey:k,isSigner:!1,isWritable:!1},...h];return new ct({keys:S,programId:e,data:Buffer.from(Jc)})}};var el=E([ut("mintAuthorityOption"),N("mintAuthority"),w("supply"),q("decimals"),q("isInitialized"),ut("freezeAuthorityOption"),N("freezeAuthority")]);import{PublicKey as rf}from"@solana/web3.js";import{MintLayout as tl,TOKEN_PROGRAM_ID as sf}from"@solana/spl-token";var aI=async({connection:r,mint:e})=>{let t=await r.getAccountInfo(new rf(e));return!t||t.data.length!==tl.span?void 0:tl.decode(t.data)},uI=({mint:r,decimals:e,programId:t=sf,logoURI:n="",priority:i=3})=>{let o=r.toBase58().substring(0,6);return{address:r.toBase58(),decimals:e,symbol:o,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:o,tags:[],priority:i}},Dr=r=>new Ve({mint:r.address,decimals:r.decimals,symbol:r.symbol,name:r.name}),wo=i=>{var o=i,{amount:r,isRaw:e,name:t}=o,n=De(o,["amount","isRaw","name"]);return new Be(new Ve({mint:mt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),r,e,t)};function cI(r){return r.address===sn.address?nt:r}function lI(r){return r.address===nt.address?sn:r}var yt=i=>{var o=i,{address:r,programId:e,decimals:t}=o,n=De(o,["address","programId","decimals"]);return M({chainId:101,address:mt(r).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},Vn=r=>r?U(M({},r),{transferFeeConfigAuthority:r.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:r.withdrawWithheldAuthority.toBase58(),withheldAmount:r.withheldAmount.toString(),olderTransferFee:U(M({},r.olderTransferFee),{epoch:r.olderTransferFee.epoch.toString(),maximumFee:r.olderTransferFee.maximumFee.toString()}),newerTransferFee:U(M({},r.newerTransferFee),{epoch:r.newerTransferFee.epoch.toString(),maximumFee:r.newerTransferFee.maximumFee.toString()})}):void 0;import nl from"bn.js";var xa=new nl(25),Wr=new nl(1e4),af={4:3,5:3};import{PublicKey as Ce,SystemProgram as ll,SYSVAR_RENT_PUBKEY as kf,TransactionInstruction as Bn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as hf,TOKEN_PROGRAM_ID as xi}from"@solana/spl-token";var Sa=E([q("instruction"),w("amountIn"),w("minAmountOut")]),Ka=E([q("instruction"),w("maxAmountIn"),w("amountOut")]),kI=E([q("instruction"),q("nonce")]),Ca=E([q("instruction"),q("nonce"),w("startTime")]),ei=E([w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalValue"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),te("swapBaseInAmount"),te("swapQuoteOutAmount"),w("swapBase2QuoteFee"),te("swapQuoteInAmount"),te("swapBaseOutAmount"),w("swapQuote2BaseFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("withdrawQueue"),N("lpVault"),N("owner"),w("lpReserve"),H(w(),3,"padding")]),uf=E([w("accountType"),w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalsValue"),w("abortTradeFactor"),w("priceTickMultiplier"),w("priceTick"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),te("swapBaseInAmount"),te("swapQuoteOutAmount"),te("swapQuoteInAmount"),te("swapBaseOutAmount"),w("swapQuote2BaseFee"),w("swapBase2QuoteFee"),N("baseVault"),N("quoteVault"),N("baseMint"),N("quoteMint"),N("lpMint"),N("modelDataAccount"),N("openOrders"),N("marketId"),N("marketProgramId"),N("targetOrders"),N("owner"),H(w(),64,"padding")]),La=E([q("instruction"),w("baseAmountIn"),w("quoteAmountIn"),w("fixedSide"),w("otherAmountMin")]),Ra=E([q("instruction"),w("lpAmount"),w("baseAmountMin"),w("quoteAmountMin")]),hI={4:ei,5:uf},il=E([w("fee")]);import{PublicKey as cf}from"@solana/web3.js";var Bi=new cf("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),ni=5e4,lf=E([w("x"),w("y"),w("price")]),mf=E([w("accountType"),w("status"),w("multiplier"),w("validDataCount"),H(lf,ni,"DataElement")]);function df(r,e){return[0,ni-2]}function pf(r){return[0,ni-2]}function ff(r){return[0,ni-2]}function yf(r,e,t){let[n,i]=df(e,t),o=n,s=i,a=0,c=e*r.multiplier/t;for(;o<=s;){if(a=Math.floor((s+o)/2),a===0||a>=ni-2)return[a,a,!1];let u=r.DataElement[a].x*r.multiplier/r.DataElement[a].y,l=r.DataElement[a-1].x*r.multiplier/r.DataElement[a-1].y,m=r.DataElement[a+1].x*r.multiplier/r.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===m)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<m)return[a,a+1,!0];o=a+1}}return[a,a,!1]}function Na(r,e,t){let[n,i,o]=yf(r,e,t);if(!o)return 0;if(n===i){let s=r.DataElement[n].x;return e*r.multiplier/s}else{let s=r.DataElement[n].x,a=r.DataElement[n].y,c=r.DataElement[i].x,u=r.DataElement[i].y,l=t*(c*a-s*u),m=s*l,d=(c-s)*(e*a-s*t)*u,p=m+d;return e*r.multiplier*l/p}}function ti(r,e,t){return e*r.multiplier/t}function ol(r,e,t){return e*t/r.multiplier}function bf(r,e){let[t,n]=pf(e),i=t,o=n,s=0,a=e;for(;i<o;){if(s=Math.floor((o+i)/2),s<=0||s>ni-2)return[s,s,!1];let c=r.DataElement[s].x,u=r.DataElement[s-1].x,l=r.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)o=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];i=s+1}}return[s,s,!1]}function gf(r,e){let[t,n]=ff(e),i=t,o=n,s=0,a=e;for(;i<=o;){if(s=Math.floor((o+i)/2),s<=0||s>=ni-2)return[s,s,!1];let c=r.DataElement[s].y,u=r.DataElement[s-1].y,l=r.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)i=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];o=s-1}}return[s,s,!1]}function rl(r,e,t,n){let i=n?e+t:e-t,[o,s,a]=bf(r,i);if(!a)return[0,0,!1,a];if(o===s)return[r.DataElement[s].price,r.DataElement[s].y,!1,a];{let c=r.DataElement[o].x,u=r.DataElement[s].x,l=r.DataElement[o].price,m=r.DataElement[s].price,d=r.DataElement[o].y,p=r.DataElement[s].y;if(e>=c&&e<=u)return n?[m,p,!0,a]:[l,d,!0,a];{let y,f;return n?(y=l+(m-l)*(e-c)/(u-c),f=d-(i-c)*r.multiplier/m):(y=l+(m-l)*(e-c)/(u-c),f=p+(u-i)*r.multiplier/l),[y,f,!1,a]}}}function Pf(r,e,t,n){let i=n?e-t:e+t,[o,s,a]=gf(r,i);if(!a)return[0,0,!1,a];if(o===s)return[r.DataElement[s].price,r.DataElement[s].x,!1,a];{let c=r.DataElement[o].x,u=r.DataElement[s].x,l=r.DataElement[o].price,m=r.DataElement[s].price,d=r.DataElement[o].y,p=r.DataElement[s].y;if(e>=p&&e<=d)return n?[m,u,!0,a]:[l,c,!0,a];{let y,f;return n?(y=l+(m-l)*(d-e)/(d-p),f=c+m*(d-i)/r.multiplier):(y=l+(m-l)*(d-e)/(d-p),f=u-l*(i-p)/r.multiplier),[y,f,!1,a]}}}function Af(r,e){let t=rl(r,e,0,!1);return t[3]?t[0]:0}function sl(r,e,t,n){let i=Na(r,e,t),o=ti(r,e,i),s=ti(r,t,i),a=ti(r,n,i),c=!0,[u,l,m,d]=rl(r,o,a,c);if(!d)return 0;if(m)return n*r.multiplier/u;{let p=s-l;return ol(r,p,i)}}function al(r,e,t,n){let i=Na(r,e,t),o=ti(r,e,i),s=ti(r,t,i),a=ti(r,n,i),c=!1,[u,l,m,d]=Pf(r,s,a,c);if(!d)return 0;if(m)return n*u/r.multiplier;{let p=o-l;return ol(r,p,i)}}function wf(r){let e=mf.decode(r);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function ul(r,e,t,n){let i=Af(r,ti(r,e,Na(r,e,t)))/r.multiplier;return n?i:1/i}var Ii=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Bi);e&&(this._layoutData=wf(e==null?void 0:e.data))}}};var cl=fe("Raydium_liquidity_instruction");function ml(r){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:o,fixedSide:s,otherAmountMin:a}=r,c=Buffer.alloc(La.span);La.encode({instruction:3,baseAmountIn:ee(i),quoteAmountIn:ee(o),otherAmountMin:ee(a),fixedSide:s==="base"?St:Nu},c);let u=[P({pubkey:xi,isWritable:!1}),P({pubkey:new Ce(e.id)}),P({pubkey:new Ce(t.authority),isWritable:!1}),P({pubkey:new Ce(t.openOrders),isWritable:!1}),P({pubkey:new Ce(t.targetOrders)}),P({pubkey:new Ce(e.lpMint.address)}),P({pubkey:new Ce(t.vault.A)}),P({pubkey:new Ce(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(P({pubkey:Bi})),u.push(P({pubkey:new Ce(e.marketId),isWritable:!1}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:new Ce(t.marketEventQueue),isWritable:!1})),new Bn({programId:new Ce(e.programId),keys:u,data:c})}function Oa(r){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:i,baseAmountMin:o,quoteAmountMin:s}=r,a=Oe(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(Ra.span);Ra.encode({instruction:4,lpAmount:ee(i),baseAmountMin:ee(o),quoteAmountMin:ee(s)},u);let l=[P({pubkey:xi,isWritable:!1}),P({pubkey:a.id}),P({pubkey:a.authority,isWritable:!1}),P({pubkey:a.openOrders}),P({pubkey:a.targetOrders}),P({pubkey:a.mintLp.address}),P({pubkey:a.vault.A}),P({pubkey:a.vault.B})];return c===5?l.push(P({pubkey:Bi})):(l.push(P({pubkey:a.id})),l.push(P({pubkey:a.id}))),l.push(P({pubkey:a.marketProgramId,isWritable:!1}),P({pubkey:a.marketId}),P({pubkey:a.marketBaseVault}),P({pubkey:a.marketQuoteVault}),P({pubkey:a.marketAuthority,isWritable:!1}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:a.marketEventQueue}),P({pubkey:a.marketBids}),P({pubkey:a.marketAsks})),new Bn({programId:a.programId,keys:l,data:u})}return new Bn({programId:a.programId,keys:[]})}function Ma({programId:r,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:o,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:A,openTime:k,coinAmount:T,pcAmount:I,ammConfigId:h,feeDestinationId:S}){let x=E([q("instruction"),q("nonce"),w("openTime"),w("pcAmount"),w("coinAmount")]),C=[{pubkey:xi,isSigner:!1,isWritable:!1},{pubkey:hf,isSigner:!1,isWritable:!1},{pubkey:ll.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:h,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],B=Buffer.alloc(x.span);return x.encode({instruction:1,nonce:A,openTime:k,coinAmount:T,pcAmount:I},B),{instruction:new Bn({keys:C,programId:r,data:B}),instructionType:X.AmmV4CreatePool}}function VI(r){let e=E([q("instruction"),q("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new Ce(r.id),isWritable:!1}),P({pubkey:new Ce(r.authority),isWritable:!1}),P({pubkey:new Ce(r.openOrders),isWritable:!1}),P({pubkey:new Ce(r.vault.A),isWritable:!1}),P({pubkey:new Ce(r.vault.B),isWritable:!1}),P({pubkey:new Ce(r.mintLp.address),isWritable:!1}),P({pubkey:new Ce(r.marketId),isWritable:!1}),P({pubkey:new Ce(r.marketEventQueue),isWritable:!1})];return new Bn({programId:new Ce(r.programId),keys:n,data:t})}function Tf({poolKeys:r,userKeys:e,amountIn:t,minAmountOut:n},i){let o=Oe(r),s=Buffer.alloc(Sa.span);Sa.encode({instruction:9,amountIn:ee(t),minAmountOut:ee(n)},s);let a=[P({pubkey:xi,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.openOrders})];return i===4&&a.push(P({pubkey:o.targetOrders})),a.push(P({pubkey:o.vault.A}),P({pubkey:o.vault.B})),i===5&&a.push(P({pubkey:Bi})),a.push(P({pubkey:o.marketProgramId,isWritable:!1}),P({pubkey:o.marketId}),P({pubkey:o.marketBids}),P({pubkey:o.marketAsks}),P({pubkey:o.marketEventQueue}),P({pubkey:o.marketBaseVault}),P({pubkey:o.marketQuoteVault}),P({pubkey:o.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Bn({programId:o.programId,keys:a,data:s})}function If({poolKeys:r,userKeys:e,maxAmountIn:t,amountOut:n},i){let o=Oe(r),s=Buffer.alloc(Ka.span);Ka.encode({instruction:11,maxAmountIn:ee(t),amountOut:ee(n)},s);let a=[P({pubkey:xi,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.openOrders}),P({pubkey:o.targetOrders}),P({pubkey:o.vault.A}),P({pubkey:o.vault.B})];return i===5&&a.push(P({pubkey:Bi})),a.push(P({pubkey:o.marketProgramId,isWritable:!1}),P({pubkey:o.marketId}),P({pubkey:o.marketBids}),P({pubkey:o.marketAsks}),P({pubkey:o.marketEventQueue}),P({pubkey:o.marketBaseVault}),P({pubkey:o.marketQuoteVault}),P({pubkey:o.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Bn({programId:o.programId,keys:a,data:s})}function qr(r){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:o,fixedSide:s}=r;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return Tf(U(M({},a),{amountIn:i,minAmountOut:o}),t);if(s==="out")return If(U(M({},a),{maxAmountIn:i,amountOut:o}),t);cl.logWithError("invalid params","params",r)}throw cl.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function FI({poolKeys:r,userKeys:e,startTime:t}){let n=Buffer.alloc(Ca.span);Ca.encode({instruction:0,nonce:5,startTime:ee(t)},n);let i=Oe(r),o=[P({pubkey:xi,isWritable:!1}),P({pubkey:ll.programId,isWritable:!1}),P({pubkey:kf,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.openOrders}),P({pubkey:i.mintLp.address}),P({pubkey:i.mintA.address,isWritable:!1}),P({pubkey:i.mintB.address,isWritable:!1}),P({pubkey:i.vault.A,isWritable:!1}),P({pubkey:i.vault.B,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.targetOrders}),P({pubkey:e.lpTokenAccount}),P({pubkey:i.id,isWritable:!1}),P({pubkey:i.marketProgramId,isWritable:!1}),P({pubkey:i.marketId,isWritable:!1}),P({pubkey:e.payer,isSigner:!0})];return new Bn({programId:i.programId,keys:o,data:n})}function dl({poolKeys:r}){let e=E([q("instruction"),q("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new Ce(r.id),isWritable:!1}),P({pubkey:new Ce(r.authority),isWritable:!1}),P({pubkey:new Ce(r.openOrders),isWritable:!1}),P({pubkey:new Ce(r.vault.A),isWritable:!1}),P({pubkey:new Ce(r.vault.B),isWritable:!1}),P({pubkey:new Ce(r.mintLp.address),isWritable:!1}),P({pubkey:new Ce(r.marketId),isWritable:!1}),P({pubkey:new Ce(r.marketEventQueue),isWritable:!1})];return{instruction:new Bn({programId:new Ce(r.programId),keys:n,data:t})}}import{PublicKey as ho}from"@solana/web3.js";import ko from"bn.js";import{TOKEN_PROGRAM_ID as Sf}from"@solana/spl-token";import{PublicKey as Bf}from"@solana/web3.js";var xf=fe("Raydium_liquidity_serum");function pl({programId:r,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let o=t.concat(Buffer.from([n]),Buffer.alloc(7));i=Bf.createProgramAddressSync(o,r)}catch(o){if(o instanceof TypeError)throw o;n++;continue}return{publicKey:i,nonce:n}}throw xf.logWithError("unable to find a viable program address nonce","params",{programId:r,marketId:e}),new Error("unable to find a viable program address nonce")}function Ur({programId:r}){let{publicKey:e}=ie([Buffer.from("amm_config_account_seed","utf-8")],r);return e}function ii({name:r,programId:e,marketId:t}){let{publicKey:n}=ie([e.toBuffer(),t.toBuffer(),Buffer.from(r,"utf-8")],e);return n}function Kf({programId:r,marketId:e}){let{publicKey:t}=ie([r.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],r);return t}function _a({programId:r}){return ie([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],r)}function Va({version:r,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:o,quoteDecimals:s,programId:a,marketProgramId:c}){let u=ii({name:"amm_associated_seed",programId:a,marketId:t}),l=ii({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=_a({programId:a}),p=ii({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=ii({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=ii({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Kf({programId:a,marketId:t}),g=ii({name:"target_associated_seed",programId:a,marketId:t}),A=ii({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:k}=pl({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:o,quoteDecimals:s,lpDecimals:o,version:r,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:A,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:k,lookupTableAccount:ho.default,configId:Ur({programId:a})}}var va;async function cB({connection:r,poolKeysList:e,config:t}){return e.find(i=>i.modelDataAccount)&&(va||(va=new Ii({connection:r}),await va.initStableModelLayout())),await Promise.all(e.map(async i=>{if(i.modelDataAccount){let o=dl({poolKeys:i});return(await Wu(r,[o.instruction],"GetPoolData")).map(c=>{let u=qu(c,"GetPoolData"),l=new ko(Pn(u,"status")),m=Number(Pn(u,"coin_decimals")),d=Number(Pn(u,"pc_decimals")),p=Number(Pn(u,"lp_decimals")),y=new ko(Pn(u,"pool_coin_amount")),f=new ko(Pn(u,"pool_pc_amount")),b=new ko(Pn(u,"pool_lp_supply")),g="0";try{g=Pn(u,"pool_open_time")}catch{}return{status:l,baseDecimals:m,quoteDecimals:d,lpDecimals:p,baseReserve:y,quoteReserve:f,lpSupply:b,startTime:new ko(g)}})[0]}else{let[o,s,a,c]=await r.getMultipleAccountsInfo([new ho(i.id),new ho(i.vault.A),new ho(i.vault.B),new ho(i.mintLp.address)]);if(o===null)throw Error("fetch pool error");if(s===null)throw Error("fetch vaultAccA error");if(a===null)throw Error("fetch vaultAccB error");if(c===null)throw Error("fetch mintAccLp error");let u=ei.decode(o.data),l=en.decode(s.data),m=en.decode(a.data),d=el.decode(c.data);return{status:u.status,baseDecimals:u.baseDecimal.toNumber(),quoteDecimals:u.quoteDecimal.toNumber(),lpDecimals:d.decimals,baseReserve:l.amount.sub(u.baseNeedTakePnl),quoteReserve:m.amount.sub(u.quoteNeedTakePnl),lpSupply:u.lpReserve,startTime:u.poolOpenTime}}}))}var Ea={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Gr=r=>{let e={},t=Sf.toBase58();return Object.keys(r).map(n=>{let i=r[n],[o,s]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:yt({address:o,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:yt({address:s,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new O(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new O(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new O(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:Ea,week:Ea,month:Ea,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:Ur({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:new O(i.lpReserve.toString()).div(10**Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())).toNumber(),lpMint:yt({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};import qe from"bn.js";import{PublicKey as To}from"@solana/web3.js";import Io from"bn.js";import{TOKEN_PROGRAM_ID as gl}from"@solana/spl-token";import{SystemProgram as oi,SYSVAR_RENT_PUBKEY as Lf,Transaction as fl,TransactionInstruction as Rf}from"@solana/web3.js";import{createInitializeAccountInstruction as yl,TOKEN_PROGRAM_ID as bl}from"@solana/spl-token";function Cf(r="accountFlags"){let e=new Lr(r);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Fa=E([Te(5),Cf("accountFlags"),N("ownAddress"),w("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),N("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),Te(7)]);function Nf({programId:r,marketInfo:e}){let t=E([q("version"),ut("instruction"),w("baseLotSize"),w("quoteLotSize"),$t("feeRateBps"),w("vaultSignerNonce"),w("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Lf,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new Rf({keys:n,programId:r,data:i})}async function Xr({connection:r,wallet:e,marketInfo:t}){var s,a,c,u,l,m,d,p;let n=new fl,i=await r.getMinimumBalanceForRentExemption(165);n.add(oi.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:bl}),oi.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:bl}),yl(t.baseVault.publicKey,t.baseMint,t.vaultOwner),yl(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),oi.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await r.getMinimumBalanceForRentExemption(Fa.span),space:Fa.span,programId:t.programId}));let o=new fl;return o.add(oi.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await r.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:t.lowestFeeMarket?764:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),oi.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await r.getMinimumBalanceForRentExemption((c=t.eventQueueSpace)!=null?c:262144+12),space:t.lowestFeeMarket?11308:(u=t.eventQueueSpace)!=null?u:262144+12,programId:t.programId}),oi.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:t.lowestFeeMarket?14524:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),oi.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:t.lowestFeeMarket?14524:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),Nf({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[X.CreateAccount,X.CreateAccount,X.InitAccount,X.InitAccount]},{transaction:o,signer:[],instructionTypes:[X.CreateAccount,X.CreateAccount,X.CreateAccount,X.CreateAccount,X.CreateAccount,X.InitMarket]}]}var Si=class extends Me{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:i,dexProgramId:o,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:y}){let f=this.scope.ownerPubKey,b=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=Ge({fromPublicKey:f,programId:o,assignSeed:b&&`${b}-market`}),A=Ge({fromPublicKey:f,programId:o,assignSeed:b&&`${b}-request`}),k=Ge({fromPublicKey:f,programId:o,assignSeed:b&&`${b}-event`}),T=Ge({fromPublicKey:f,programId:o,assignSeed:b&&`${b}-bids`}),I=Ge({fromPublicKey:f,programId:o,assignSeed:b&&`${b}-asks`}),h=Ge({fromPublicKey:f,programId:gl,assignSeed:b&&`${b}-baseVault`}),S=Ge({fromPublicKey:f,programId:gl,assignSeed:b&&`${b}-quoteVault`}),x=0,C=new Io(100);function B(){let Y=new Io(0);for(;;)try{return{vaultOwner:To.createProgramAddressSync([g.publicKey.toBuffer(),Y.toArrayLike(Buffer,"le",8)],o),vaultSignerNonce:Y}}catch{if(Y.iaddn(1),Y.gt(new Io(25555)))throw Error("find vault owner error")}}let{vaultOwner:K,vaultSignerNonce:L}=B(),R=new Io(Math.round(10**e.decimals*n)),V=new Io(Math.round(n*10**t.decimals*i));if(R.eq(St))throw Error("lot size is too small");if(V.eq(St))throw Error("tick size or lot size is too small");let _=await Xr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:o,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:h,quoteVault:S,vaultOwner:K,requestQueue:A,eventQueue:k,bids:T,asks:I,feeRateBps:x,quoteDustThreshold:C,vaultSignerNonce:L,baseLotSize:R,quoteLotSize:V,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),W=this.createTxBuilder(y);W.addInstruction({instructions:_[0].transaction.instructions,signers:_[0].signer});for await(let Y of _.slice(1,_.length))W.addInstruction({instructions:Y.transaction.instructions,signers:Y.signer,instructionTypes:Y.instructionTypes});return m===0?W.sizeCheckBuildV0({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:A.publicKey,eventQueue:k.publicKey,bids:T.publicKey,asks:I.publicKey,baseVault:h.publicKey,quoteVault:S.publicKey,baseMint:new To(e.mint),quoteMint:new To(t.mint)}}):W.sizeCheckBuild({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:A.publicKey,eventQueue:k.publicKey,bids:T.publicKey,asks:I.publicKey,baseVault:h.publicKey,quoteVault:S.publicKey,baseMint:new To(e.mint),quoteMint:new To(t.mint)}})}};var Bo=class extends Me{constructor(t){super(t);this.stableLayout=new Ii({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:i,baseIn:o}){let s=new qe(new O(n).mul(10**t[o?"mintA":"mintB"].decimals).toFixed(0)),a=Dr(t[o?"mintB":"mintA"]),[c,u]=[new qe(new O(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new qe(new O(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new qe(new O(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",c.toString(),"quoteReserve:",u.toString()),this.logDebug("tokenIn:",o?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",o?t.mintB.symbol:t.mintA.symbol,"slippage:",`${i.toSignificant()}%`,"baseReserve",c.toString(),"quoteReserve",u.toString());let m=o?"base":"quote";this.logDebug("input side:",m);let d=St;s.isZero()||(d=m==="base"?ur(s.mul(u),c):ur(s.mul(c),u)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=ur(s.mul(l),m==="base"?c:u);this.logDebug("liquidity:",p.toString());let y=new ot(new qe(1)).add(i),f=new ot(new qe(1)).sub(i),b=y.mul(d).quotient,g=f.mul(d).quotient,A=new Be(a,d),k=new Be(a,b),T=new Be(a,g);return this.logDebug("anotherAmount:",A.toFixed(),"maxAnotherAmount:",k.toFixed()),{anotherAmount:A,maxAnotherAmount:k,minAnotherAmount:T,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:i,amountInA:o,amountInB:s,otherAmountMin:a,fixedSide:c,config:u,txVersion:l,computeBudgetConfig:m,txTipConfig:d,feePayer:p}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",o,"amountInB:",s),(o.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:o.toFixed(),amountInB:s.toFixed()});let{account:y}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:b}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),[g,A]=[o.token,s.token],k=await y.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1}),T=await y.getCreatedTokenAccount({mint:A.mint,associatedOnly:!1});!k&&!T&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",y.tokenAccounts);let I=await y.getCreatedTokenAccount({mint:new He(n.lpMint.address)}),h=[g,A],S=[k,T],x=[o.raw,s.raw],C=o.token.mint.toBase58()===n.mintA.address?"base":"quote",B="base";["quote","base"].includes(C)||this.logAndCreateError("invalid fixedSide","fixedSide",c),C==="quote"?(h.reverse(),S.reverse(),x.reverse(),B=c==="a"?"quote":"base"):C==="base"&&(B=c==="a"?"base":"quote");let[K,L]=h,[R,V]=S,[_,W]=x,Y=i!=null?i:await this.getAmmPoolKeys(n.id),se=this.createTxBuilder(p),Pt=await y.handleTokenAccount({side:"in",amount:_,mint:K.mint,tokenAccount:R,bypassAssociatedCheck:f,checkCreateATAOwner:b}),{tokenAccount:Ae}=Pt,ce=De(Pt,["tokenAccount"]);se.addInstruction(ce);let Ue=await y.handleTokenAccount({side:"in",amount:W,mint:L.mint,tokenAccount:V,bypassAssociatedCheck:f,checkCreateATAOwner:b}),{tokenAccount:de}=Ue,Ke=De(Ue,["tokenAccount"]);se.addInstruction(Ke);let lt=await y.handleTokenAccount({side:"out",amount:0,mint:new He(n.lpMint.address),tokenAccount:I,bypassAssociatedCheck:f,checkCreateATAOwner:b}),{tokenAccount:Ze}=lt,qt=De(lt,["tokenAccount"]);return se.addInstruction(qt),se.addInstruction({instructions:[ml({poolInfo:n,poolKeys:Y,userKeys:{baseTokenAccount:Ae,quoteTokenAccount:de,lpTokenAccount:Ze,owner:this.scope.ownerPubKey},baseAmountIn:_,quoteAmountIn:W,otherAmountMin:a.raw,fixedSide:B})],instructionTypes:[n.pooltype.includes("StablePool")?X.AmmV5AddLiquidity:X.AmmV4AddLiquidity],lookupTableAddress:Y.lookupTableAccount?[Y.lookupTableAccount]:[]}),se.addCustomComputeBudget(m),se.addTipInstruction(d),l===0?await se.buildV0():se.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:i,lpAmount:o,baseAmountMin:s,quoteAmountMin:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=t,p=i!=null?i:await this.getAmmPoolKeys(n.id),[y,f,b]=[new He(n.mintA.address),new He(n.mintB.address),new He(n.lpMint.address)];this.logDebug("lpAmount:",o),this.logDebug("baseAmountMin:",s),this.logDebug("quoteAmountMin:",a),o.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",o.toString());let{account:g}=this.scope,A=await g.getCreatedTokenAccount({mint:b,associatedOnly:!1});A||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",g.tokenAccounts);let k=await g.getCreatedTokenAccount({mint:y}),T=await g.getCreatedTokenAccount({mint:f}),I=this.createTxBuilder(d),{bypassAssociatedCheck:h,checkCreateATAOwner:S}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),L=await g.handleTokenAccount({side:"out",amount:0,mint:y,tokenAccount:k,bypassAssociatedCheck:h,checkCreateATAOwner:S}),{tokenAccount:x}=L,C=De(L,["tokenAccount"]);I.addInstruction(C);let R=await g.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:T,bypassAssociatedCheck:h,checkCreateATAOwner:S}),{tokenAccount:B}=R,K=De(R,["tokenAccount"]);return I.addInstruction(K),I.addInstruction({instructions:[Oa({poolInfo:n,poolKeys:p,userKeys:{lpTokenAccount:A,baseTokenAccount:x,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:o,baseAmountMin:s,quoteAmountMin:a})],lookupTableAddress:p.lookupTableAccount?[p.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?X.AmmV5RemoveLiquidity:X.AmmV4RemoveLiquidity]}),I.addCustomComputeBudget(l),I.addTipInstruction(m),u===0?await I.buildV0():I.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:i,createPositionInfo:o,farmInfo:s,userFarmLpAmount:a,base:c,computeBudgetConfig:u,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=Fn,checkCreateATAOwner:p=!0,getEphemeralSigners:y,txVersion:f,feePayer:b}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let g=this.createTxBuilder(b),A={};for(let Y of this.scope.account.tokenAccountRawInfos)(A[Y.accountInfo.mint.toString()]===void 0||J(this.scope.ownerPubKey,Y.accountInfo.mint,Fn).publicKey.equals(Y.pubkey))&&(A[Y.accountInfo.mint.toString()]=Y.pubkey);let k=A[t.lpMint.address];if(k===void 0)throw Error("find lp account error in trade accounts");let T=i.add(a!=null?a:new qe(0)),I=t.mintA.address===Ve.WSOL.mint.toString(),h=t.mintB.address===Ve.WSOL.mint.toString(),{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Fn,mint:new He(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(x||{}),S===void 0)throw new Error("base token account not found");let{account:C,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Fn,mint:new He(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:p});if(g.addInstruction(B||{}),C===void 0)throw new Error("quote token account not found");if(A[t.mintA.address]=S,A[t.mintB.address]=C,s!==void 0&&!(a!=null&&a.isZero())){let Y=_t[s.programId],se=pt({programId:new He(s.programId),poolId:new He(s.id),owner:this.scope.ownerPubKey,version:Y}),Ae,ce=await this.scope.connection.getAccountInfo(se);if(ce&&(Ae=wi(Y).decode(ce.data)),Y!==6&&!Ae){let{instruction:lt,instructionType:nn}=so({id:new He(s.id),programId:new He(s.programId),version:Y,ledger:se,owner:this.scope.ownerPubKey});g.addInstruction({instructions:[lt],instructionTypes:[nn]})}let de=[];for(let lt of s.rewardInfos){let nn=lt.mint.address===Ve.WSOL.mint.toString();if(A[lt.mint.address])de.push(A[lt.mint.address]);else{let{account:yn,instructionParams:Ut}=await this.scope.account.getOrCreateTokenAccount({mint:new He(lt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!nn,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});yn||this.logAndCreateError("farm reward account not found:",lt.mint.address),Ut&&g.addInstruction(Ut),de.push(yn)}}let Ke=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],Ze={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:Ke,lpAccount:k,rewardAccounts:de},qt=_t[s.programId],Pt=qt===6?ao(Ze):qt===5?uo(Ze):co(Ze),Ue={3:X.FarmV3Withdraw,5:X.FarmV5Withdraw,6:X.FarmV6Withdraw};g.addInstruction({instructions:[Pt],instructionTypes:[Ue[qt]]})}let K=await this.getAmmPoolKeys(t.id),L=Oa({poolInfo:t,poolKeys:K,userKeys:{lpTokenAccount:k,baseTokenAccount:S,quoteTokenAccount:C,owner:this.scope.ownerPubKey},lpAmount:T,baseAmountMin:0,quoteAmountMin:0});g.addInstruction({instructions:[L],instructionTypes:[t.pooltype.includes("StablePool")?X.AmmV5RemoveLiquidity:X.AmmV4RemoveLiquidity],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]});let[R,V]=t.mintA.address===n.mintA.address?[S,C]:[C,S],_=await this.scope.clmm.getClmmPoolKeys(n.id),W=await Se.openPositionFromBaseInstructions(U(M({poolInfo:n,poolKeys:_,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:R,tokenAccountB:V},withMetadata:"create"},o),{base:c,getEphemeralSigners:y}));return g.addInstruction({instructions:[...W.instructions],signers:W.signers,instructionTypes:[...W.instructionTypes],lookupTableAddress:_.lookupTableAccount?[_.lookupTableAccount]:[]}),f===0?g.sizeCheckBuildV0({computeBudgetConfig:u}):g.sizeCheckBuild({computeBudgetConfig:u})}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:i,quoteMintInfo:o,baseAmount:s,quoteAmount:a,startTime:c,ownerInfo:u,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:y,computeBudgetConfig:f,txTipConfig:b,feePayer:g}){var V;let A=u.feePayer||((V=this.scope.owner)==null?void 0:V.publicKey),k=u.useSOLBalance&&i.mint.equals(Qr),T=u.useSOLBalance&&o.mint.equals(Qr),I=this.createTxBuilder(g),{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:k?{payer:A,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:l,checkCreateATAOwner:m});I.addInstruction(S||{});let{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:T?{payer:A,amount:a}:void 0,notUseTokenAccount:T,skipCloseAccount:!T,associatedOnly:T?!1:l,checkCreateATAOwner:m});if(I.addInstruction(C||{}),h===void 0||x===void 0)throw Error("you don't has some token account");let B=Va({version:4,marketVersion:3,marketId:n.marketId,baseMint:i.mint,quoteMint:o.mint,baseDecimals:i.decimals,quoteDecimals:o.decimals,programId:t,marketProgramId:n.programId}),K={programId:t,ammId:B.id,ammAuthority:B.authority,ammOpenOrders:B.openOrders,lpMint:B.lpMint,coinMint:B.baseMint,pcMint:B.quoteMint,coinVault:B.baseVault,pcVault:B.quoteVault,withdrawQueue:B.withdrawQueue,ammTargetOrders:B.targetOrders,poolTempLp:B.lpVault,marketProgramId:B.marketProgramId,marketId:B.marketId,ammConfigId:B.configId,feeDestinationId:y},{instruction:L,instructionType:R}=Ma(U(M({},K),{userWallet:this.scope.ownerPubKey,userCoinVault:h,userPcVault:x,userLpVault:J(this.scope.ownerPubKey,B.lpMint,d).publicKey,nonce:B.nonce,openTime:c,coinAmount:s,pcAmount:a}));return I.addInstruction({instructions:[L],instructionTypes:[R]}),I.addCustomComputeBudget(f),I.addTipInstruction(b),I.versionBuild({txVersion:p,extInfo:{address:K}})}async createMarketAndPoolV4({programId:t=Gi,marketProgram:n=_s,feeDestinationId:i=Vs,tokenProgram:o,baseMintInfo:s,quoteMintInfo:a,baseAmount:c,quoteAmount:u,startTime:l,ownerInfo:m,lowestFeeMarket:d,assignSeed:p,associatedOnly:y=!1,checkCreateATAOwner:f=!1,lotSize:b=1,tickSize:g=.01,txVersion:A,computeBudgetConfig:k,txTipConfig:T,feePayer:I}){var Ei,Rt,Qo;let h=this.scope.ownerPubKey,S=m.feePayer||((Ei=this.scope.owner)==null?void 0:Ei.publicKey),x=m.useSOLBalance&&s.mint.equals(Qr),C=m.useSOLBalance&&a.mint.equals(Qr),B=p?`${s.mint.toBase58().slice(0,7)}-${a.mint.toBase58().slice(0,7)}-${p}`:void 0,K=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-market`}),L=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-request`}),R=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-event`}),V=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-bids`}),_=Ge({fromPublicKey:h,programId:n,assignSeed:B&&`${B}-asks`}),W=Ge({fromPublicKey:h,programId:Fn,assignSeed:B&&`${B}-baseVault`}),Y=Ge({fromPublicKey:h,programId:Fn,assignSeed:B&&`${B}-quoteVault`}),se=0,Ae=new qe(100);function ce(){let on=new qe(0);for(;;)try{return{vaultOwner:He.createProgramAddressSync([K.publicKey.toBuffer(),on.toArrayLike(Buffer,"le",8)],n),vaultSignerNonce:on}}catch{if(on.iaddn(1),on.gt(new qe(25555)))throw Error("find vault owner error")}}let{vaultOwner:de,vaultSignerNonce:Ke}=ce(),Ze=new qe(Math.round(10**s.decimals*b)),qt=new qe(Math.round(b*10**a.decimals*g));if(Ze.eq(St))throw Error("lot size is too small");if(qt.eq(St))throw Error("tick size or lot size is too small");let Pt=await Xr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:n,vaultOwner:de,baseMint:s.mint,quoteMint:a.mint,id:K,baseVault:W,quoteVault:Y,requestQueue:L,eventQueue:R,bids:V,asks:_,feeRateBps:se,quoteDustThreshold:Ae,vaultSignerNonce:Ke,baseLotSize:Ze,quoteLotSize:qt,lowestFeeMarket:d}}),Ue=this.createTxBuilder(I);Ue.addInstruction({instructions:Pt[0].transaction.instructions,signers:Pt[0].signer});for await(let on of Pt.slice(1,Pt.length))Ue.addInstruction({instructions:on.transaction.instructions,signers:on.signer,instructionTypes:on.instructionTypes});let{account:lt,instructionParams:nn}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:x?{payer:S,amount:c}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:y,checkCreateATAOwner:f,assignSeed:x&&B?`${B}-wsol`:void 0});Ue.addInstruction(nn||{});let{account:yn,instructionParams:Ut}=await this.scope.account.getOrCreateTokenAccount({mint:a.mint,owner:this.scope.ownerPubKey,createInfo:C?{payer:S,amount:u}:void 0,notUseTokenAccount:C,skipCloseAccount:!C,associatedOnly:C?!1:y,checkCreateATAOwner:f,assignSeed:C&&B?`${B}-wsol`:void 0});if(Ue.addInstruction(Ut||{}),lt===void 0)throw Error("you don't has base token account");if(yn===void 0)throw Error("you don't has quote token account");let $e=Va({version:4,marketVersion:3,marketId:K.publicKey,baseMint:s.mint,quoteMint:a.mint,baseDecimals:s.decimals,quoteDecimals:a.decimals,programId:t,marketProgramId:n}),ci={programId:t,ammId:$e.id,ammAuthority:$e.authority,ammOpenOrders:$e.openOrders,lpMint:$e.lpMint,coinMint:$e.baseMint,pcMint:$e.quoteMint,coinVault:$e.baseVault,pcVault:$e.quoteVault,withdrawQueue:$e.withdrawQueue,ammTargetOrders:$e.targetOrders,poolTempLp:$e.lpVault,marketProgramId:$e.marketProgramId,marketId:$e.marketId,ammConfigId:$e.configId,feeDestinationId:i},{instruction:Go,instructionType:Xo}=Ma(U(M({},ci),{userWallet:this.scope.ownerPubKey,userCoinVault:lt,userPcVault:yn,userLpVault:J(this.scope.ownerPubKey,$e.lpMint,o).publicKey,nonce:$e.nonce,openTime:l,coinAmount:c,pcAmount:u}));Ue.addInstruction({instructions:[Go],instructionTypes:[Xo]});let vi=x||C?[((Rt=nn==null?void 0:nn.instructions)==null?void 0:Rt[0])||((Qo=Ut==null?void 0:Ut.instructions)==null?void 0:Qo[0])].filter(on=>!!on):void 0;return A===0?Ue.sizeCheckBuildV0({computeBudgetConfig:k,splitIns:vi,address:M({requestQueue:L.publicKey,eventQueue:R.publicKey,bids:V.publicKey,asks:_.publicKey,baseVault:W.publicKey,quoteVault:Y.publicKey,baseMint:new He(s.mint),quoteMint:new He(a.mint)},ci)}):Ue.sizeCheckBuild({computeBudgetConfig:k,splitIns:vi,address:M({requestQueue:L.publicKey,eventQueue:R.publicKey,bids:V.publicKey,asks:_.publicKey,baseVault:W.publicKey,quoteVault:Y.publicKey,baseMint:new He(s.mint),quoteMint:new He(a.mint)},ci)})}async getCreatePoolFee({programId:t}){let n=Ur({programId:t}),i=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(i===null)throw Error("get config account error");return il.decode(i.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:i,mintOut:o,slippage:s}){let[a,c]=[i.toString(),o.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(c!==t.mintA.address&&c!==t.mintB.address)throw new Error("toke not match");let{baseReserve:u,quoteReserve:l}=t,m=[u,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[y,f]=m,[b,g]=d,A=t.version===4,k;if(A)k=new O(f.toString()).div(10**g).div(new O(y.toString()).div(10**b));else{let R=ul(this.stableLayout.stableModelData,u.toNumber(),l.toNumber(),!1);p==="quote"?k=new O(1e6).div(R*1e6):k=new O(R*1e6).div(1e6)}let T=n,I=new qe(0),h=new qe(0);if(!T.isZero())if(A){h=Nn(T.mul(xa),Wr);let R=T.sub(h),V=y.add(R);I=f.mul(R).div(V)}else{h=T.mul(new qe(2)).div(new qe(1e4));let R=T.sub(h);p==="quote"?I=new qe(sl(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),R.toNumber())):I=new qe(al(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),R.toNumber()))}let S=new qe(new O(I.toString()).mul(1-s).toFixed(0)),x=I,C=S,B=new O(I.toString()).div(new O(T.sub(h).toString()).toFixed(0));!T.isZero()&&!I.isZero()&&(B=new O(I.toString()).div(10**g).div(new O(T.sub(h).toString()).div(10**b)));let K=k.sub(B).div(k).mul(100);return{amountOut:x,minAmountOut:C,currentPrice:k,executionPrice:B,priceImpact:K,fee:h}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:i,mintOut:o,slippage:s}){let{baseReserve:a,quoteReserve:c}=t;i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),o.toString()!==t.mintA.address&&o.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",c.toString());let u=i.toString()===t.mintA.address,[l,m]=u?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new O(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,c],p=u?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[y,f]=d,b=new O(f.toString()).div(10**t[u?"mintB":"mintA"].decimals).div(new O(y.toString()).div(10**t[u?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${b.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(b).toString()} ${l.symbol||l.address}`);let g=new qe(0),A=n;if(!A.isZero()){A.gt(f)&&(A=f.sub(new qe(1)));let C=f.sub(A);g=y.mul(A).div(C).mul(Wr).div(Wr.sub(xa))}let k=new qe(new O(g.toString()).mul(1+s).toFixed(0)),T=g,I=k;this.logDebug("amountIn:",new O(T.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new O(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let h=null;!g.isZero()&&!A.isZero()&&(h=new O(A.toString()).div(10**m.decimals).div(new O(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${h.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(h).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let S=b.mul(T.toString()),x=S.sub(n.toString()).abs().div(S);return this.logDebug("priceImpact:",`${x.toString()}%`),{amountIn:T,maxAmountIn:I,currentPrice:b,executionPrice:h,priceImpact:x}}async swap({poolInfo:t,poolKeys:n,amountIn:i,amountOut:o,inputMint:s,fixedSide:a,txVersion:c,config:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}){let p=this.createTxBuilder(d),{associatedOnly:y=!0,inputUseSolBalance:f=!0,outputUseSolBalance:b=!0}=u||{},[g,A]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],k=f&&g.address===Z.toBase58(),T=b&&A.address===Z.toBase58(),{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Fn,mint:new He(g.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:y});p.addInstruction(h||{}),I||this.logAndCreateError("input token account not found",{token:g.symbol||g.address,tokenAccountIn:I,inputTokenUseSolBalance:k,associatedOnly:y});let{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Fn,mint:new He(A.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:y});p.addInstruction(x||{}),S===void 0&&this.logAndCreateError("output token account not found",{token:A.symbol||A.address,tokenAccountOut:S,outputTokenUseSolBalance:T,associatedOnly:y});let C=n||await this.getAmmPoolKeys(t.id),B=4;return t.pooltype.includes("StablePool")&&(B=5),p.addInstruction({instructions:[qr({version:B,poolKeys:C,userKeys:{tokenAccountIn:I,tokenAccountOut:S,owner:this.scope.ownerPubKey},amountIn:i,amountOut:o,fixedSide:a})],instructionTypes:[B===4?X.AmmV4SwapBaseIn:X.AmmV5SwapBaseIn]}),p.addCustomComputeBudget(l),p.addTipInstruction(m),p.versionBuild({txVersion:c})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let i=await Ne(this.scope.connection,t.map(l=>({pubkey:new He(l)})),n),o={},s=[];for(let l=0;l<t.length;l++){let m=i[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=ei.decode(m.accountInfo.data);o[String(t[l])]=U(M({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},c=await Ne(this.scope.connection,s.map(l=>({pubkey:new He(l)})),n);for(let l=0;l<s.length;l++){let m=c[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new qe(Of.decode(m.data).amount.toString())}let u={};for(let[l,m]of Object.entries(o)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);u[l]=U(M({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new O(p.toString()).div(new O(10).pow(m.quoteDecimal.toString())).div(new O(d.toString()).div(new O(10).pow(m.baseDecimal.toString())))})}return u}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),i=Gr({[t]:n}),o=i[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[i[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:o,poolKeys:s[0]}}};import{PublicKey as j}from"@solana/web3.js";import It from"bn.js";import{AccountLayout as Pl,createAssociatedTokenAccountIdempotentInstruction as Al,TOKEN_2022_PROGRAM_ID as Dn,TOKEN_PROGRAM_ID as xo}from"@solana/spl-token";var So=class extends Me{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var S;let{programId:t,owner:n=((S=this.scope.owner)==null?void 0:S.publicKey)||j.default,mint1:i,mint2:o,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:m,txTipConfig:d,feePayer:p}=e,y=this.createTxBuilder(p),[f,b,g]=new It(new j(i.address).toBuffer()).gt(new It(new j(o.address).toBuffer()))?[o,i,new O(1).div(a)]:[i,o,a],A=oe.priceToSqrtPriceX64(g,f.decimals,b.decimals),k=[],T=[];f.programId===Dn.toBase58()&&T.push(ka(t,new j(f.address)).publicKey),b.programId===Dn.toBase58()&&T.push(ka(t,new j(b.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(T)).forEach((x,C)=>{x&&k.push(T[C])});let h=await Se.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:f,mintB:b,ammConfigId:s.id,initialPriceX64:A,forerunCreate:!l&&u,extendMintAccount:k});return y.addInstruction(h),y.addCustomComputeBudget(c),y.addTipInstruction(d),y.versionBuild({txVersion:m,extInfo:{address:U(M({},h.address),{observationId:h.address.observationId.toBase58(),exBitmapAccount:h.address.exBitmapAccount.toBase58(),programId:t.toString(),id:h.address.poolId.toString(),mintA:f,mintB:b,openTime:"0",vault:{A:h.address.mintAVault.toString(),B:h.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:M({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:h.address.poolId.toString(),mintA:f,mintB:b,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},Ec),forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,withMetadata:d="create",getEphemeralSigners:p,computeBudgetConfig:y,txTipConfig:f,txVersion:b,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let A=this.createTxBuilder(g),k=null,T=null,I=n.useSOLBalance&&e.mintA.address===Z.toString(),h=n.useSOLBalance&&e.mintB.address===Z.toString(),[S,x]=s==="MintA"?[a,c]:[c,a],{account:C,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new j(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:l,checkCreateATAOwner:m});C&&(k=C),A.addInstruction(B||{});let{account:K,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new j(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||x.isZero()?{payer:this.scope.ownerPubKey,amount:x}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:l,checkCreateATAOwner:m});K&&(T=K),A.addInstruction(L||{}),(!k||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:k==null?void 0:k.toBase58(),ownerTokenAccountB:T==null?void 0:T.toBase58()});let R=t||await this.getClmmPoolKeys(e.id),V=await Se.openPositionFromBaseInstructions({poolInfo:e,poolKeys:R,ownerInfo:U(M({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:T}),tickLower:i,tickUpper:o,base:s,baseAmount:a,otherAmountMax:c,withMetadata:d,getEphemeralSigners:p,nft2022:u});return A.addInstruction(V),A.addCustomComputeBudget(y),A.addTipInstruction(f),A.versionBuild({txVersion:b,extInfo:M({},V.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:i,amountMaxB:o,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,txTipConfig:y,getEphemeralSigners:f,nft2022:b,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let A=this.createTxBuilder(g),k=null,T=null,I=n.useSOLBalance&&e.mintA.address===Z.toBase58(),h=n.useSOLBalance&&e.mintB.address===Z.toBase58(),{account:S,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new j(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:u,checkCreateATAOwner:l});S&&(k=S),A.addInstruction(x||{});let{account:C,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new j(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:u,checkCreateATAOwner:l});C&&(T=C),A.addInstruction(B||{}),(k===void 0||T===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let K=t||await this.getClmmPoolKeys(e.id),L=await Se.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:K,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:T},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:i,amountMaxB:o,withMetadata:m,getEphemeralSigners:f,nft2022:b});return A.addInstruction(L),A.addCustomComputeBudget(p),A.addTipInstruction(y),A.versionBuild({txVersion:d,extInfo:{address:L.address}})}async increasePositionFromLiquidity(e){var B;let{poolInfo:t,poolKeys:n,ownerPosition:i,amountMaxA:o,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:y}=e,f=this.createTxBuilder(y),b,g,A=c.useSOLBalance&&t.mintA.address===Z.toString(),k=c.useSOLBalance&&t.mintB.address===Z.toString(),{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:A||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!A,associatedOnly:A?!1:u,checkCreateATAOwner:l});T&&(b=T),f.addInstruction(I||{});let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});h&&(g=h),f.addInstruction(S||{}),!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let x=n!=null?n:await this.getClmmPoolKeys(t.id),C=Se.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:x,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},liquidity:a,amountMaxA:o,amountMaxB:s,nft2022:(B=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:B.owner.equals(Dn)});return f.addInstruction(C),f.addCustomComputeBudget(m),f.addTipInstruction(d),f.versionBuild({txVersion:p,extInfo:{address:C.address}})}async increasePositionFromBase(e){var C;let{poolInfo:t,ownerPosition:n,base:i,baseAmount:o,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,y=this.createTxBuilder(p),f,b,g=a.useSOLBalance&&t.mintA.address===Z.toString(),A=a.useSOLBalance&&t.mintB.address===Z.toString(),{account:k,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(i==="MintA"?o:s).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?o:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});k&&(f=k),y.addInstruction(T||{});let{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:A||(i==="MintA"?s:o).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?s:o}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:c,checkCreateATAOwner:u});I&&(b=I),y.addInstruction(h||{}),!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=await this.getClmmPoolKeys(t.id),x=Se.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:S,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},base:i,baseAmount:o,otherAmountMax:s,nft2022:(C=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:C.owner.equals(Dn)});return y.addInstruction(x),y.addCustomComputeBudget(l),y.addTipInstruction(m),y.versionBuild({txVersion:d,extInfo:{address:x.address}})}async decreaseLiquidity(e){var R;let{poolInfo:t,poolKeys:n,ownerPosition:i,ownerInfo:o,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:y}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let f=this.createTxBuilder(y),b=o.useSOLBalance&&t.mintA.address===Z.toString(),g=o.useSOLBalance&&t.mintB.address===Z.toString(),A,k,{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new j(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});A=T,I&&f.addInstruction(I);let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new j(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});k=h,S&&f.addInstruction(S);let x=[];for(let V of t.rewardDefaultInfos){let _=o.useSOLBalance&&V.mint.address===Z.toString(),W;if(V.mint.address===t.mintA.address)W=A;else if(V.mint.address===t.mintB.address)W=k;else{let{account:Y,instructionParams:se}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(V.mint.programId),mint:new j(V.mint.address),notUseTokenAccount:_,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!_,associatedOnly:_?!1:u,checkCreateATAOwner:l});W=Y,se&&f.addInstruction(se)}x.push(W)}!A&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let C=n!=null?n:await this.getClmmPoolKeys(t.id),B=(R=await this.scope.connection.getAccountInfo(i.nftMint))==null?void 0:R.owner.equals(Dn),K=await Se.decreaseLiquidityInstructions({poolInfo:t,poolKeys:C,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:k,rewardAccounts:x},liquidity:c,amountMinA:s,amountMinB:a,nft2022:B});f.addInstruction({instructions:K.instructions,instructionTypes:[X.ClmmDecreasePosition]});let L=M({},K.address);if(o.closePosition){let V=await Se.closePositionInstructions({poolInfo:t,poolKeys:C,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:i,nft2022:B});f.addInstruction({endInstructions:V.instructions,endInstructionTypes:V.instructionTypes}),L=M(M({},L),V.address)}return f.addCustomComputeBudget(m),f.addTipInstruction(d),f.versionBuild({txVersion:p,extInfo:{address:L}})}async lockPosition(e){var y;let{programId:t=Qn,authProgramId:n=Xi,poolProgramId:i=An,ownerPosition:o,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:m}=e,d=this.createTxBuilder(m),p=await Se.makeLockPositions({programId:t,authProgramId:n,poolProgramId:i,wallet:this.scope.ownerPubKey,payer:s!=null?s:this.scope.ownerPubKey,nftMint:o.nftMint,getEphemeralSigners:l,nft2022:(y=await this.scope.connection.getAccountInfo(o.nftMint))==null?void 0:y.owner.equals(Dn)});return d.addInstruction(p),d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=Qn,authProgramId:n=Xi,clmmProgram:i=An,poolKeys:o,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,y=o||await this.getClmmPoolKeys(s.poolId.toString()),f=this.createTxBuilder(p),b=await this.scope.connection.getAccountInfo(s.positionId);b||this.logger.logWithError("position not found",s.positionId);let g=Ti.decode(b.data),A=a.useSOLBalance&&y.mintA.address===Z.toString(),k=a.useSOLBalance&&y.mintB.address===Z.toString(),T,I,{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintA.programId,mint:new j(y.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,associatedOnly:A?!1:c,checkCreateATAOwner:u});T=h,S&&f.addInstruction(S);let{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintB.programId,mint:new j(y.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:k?!1:c,checkCreateATAOwner:u});I=x,C&&f.addInstruction(C);let B={},K=[];for(let de of y.rewardInfos){let Ke=a.useSOLBalance&&de.mint.address===Z.toString(),Ze=B[de.mint.address];if(!Ze){let{account:qt,instructionParams:Pt}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(de.mint.programId),mint:new j(de.mint.address),notUseTokenAccount:Ke,owner:this.scope.ownerPubKey,skipCloseAccount:!Ke,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:Ke?!1:c});Ze=qt,Pt&&f.addInstruction(Pt)}B[de.mint.address]=Ze,K.push(Ze)}let L=hi(t,s.lockNftMint).publicKey,R=J(this.scope.ownerPubKey,s.lockNftMint,xo).publicKey,V=$.getTickArrayStartIndexByTick(g.tickLower,y.config.tickSpacing),_=$.getTickArrayStartIndexByTick(g.tickUpper,y.config.tickSpacing),{publicKey:W}=ge(new j(y.programId),s.poolId,V),{publicKey:Y}=ge(new j(y.programId),s.poolId,_),{publicKey:se}=tn(new j(y.programId),s.poolId,g.tickLower,g.tickUpper),Ae=[];for(let de=0;de<y.rewardInfos.length;de++)Ae.push({poolRewardVault:new j(y.rewardInfos[de].vault),ownerRewardVault:K[de],rewardMint:new j(y.rewardInfos[de].mint.address)});let ce=await Se.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:L,clmmProgram:i,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:R,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:se,vaultA:new j(y.vault.A),vaultB:new j(y.vault.B),tickArrayLower:W,tickArrayUpper:Y,userVaultA:T,userVaultB:I,mintA:new j(y.mintA.address),mintB:new j(y.mintB.address),rewardAccounts:Ae,exTickArrayBitmap:Xe(i,s.poolId).publicKey});return f.addInstruction({instructions:[ce],instructionTypes:[X.ClmmHarvestLockPosition]}),f.addCustomComputeBudget(l),f.addTipInstruction(m),f.versionBuild({txVersion:d})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:i,computeBudgetConfig:o,txTipConfig:s,feePayer:a}){var m;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t!=null?t:await this.getClmmPoolKeys(e.id),l=Se.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(m=await this.scope.connection.getAccountInfo(n.nftMint))==null?void 0:m.owner.equals(Dn)});return c.addCustomComputeBudget(o),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:i,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===Z.toString(),m=n.perSecond.mul(n.endTime-n.openTime),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(n.mint.address),mint:new j(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new It(new O(m.toFixed(0)).gte(m)?m.toFixed(0):m.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:i,checkCreateATAOwner:o});p&&u.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=Se.initRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{programId:new j(n.mint.programId),mint:new j(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ue.decimalToX64(n.perSecond)}});return u.addInstruction(f),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:f.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of i)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let m=this.createTxBuilder(l),d={};for(let p of i){let y=n.useSOLBalance&&p.mint.address===Z.toString(),f=p.perSecond.mul(p.endTime-p.openTime),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(p.mint.programId),mint:new j(p.mint.address),notUseTokenAccount:!!y,skipCloseAccount:!y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new It(new O(f.toFixed(0)).gte(f)?f.toFixed(0):f.add(1).toFixed(0))}:void 0,associatedOnly:y?!1:o,checkCreateATAOwner:s});g&&m.addInstruction(g),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let A=t!=null?t:await this.getClmmPoolKeys(e.id),k=Se.initRewardInstructions({poolInfo:e,poolKeys:A,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{programId:new j(p.mint.programId),mint:new j(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ue.decimalToX64(p.perSecond)}});d=M(M({},d),k.address),m.addInstruction(k)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),m=t.useSOLBalance&&n.mint.equals(Z),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new It(new O(n.perSecond.mul(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.mul(n.endTime-n.openTime))?n.perSecond.mul(n.endTime-n.openTime).toFixed(0):n.perSecond.mul(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:i,checkCreateATAOwner:o});p&&l.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=Se.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ue.decimalToX64(n.perSecond)}});return l.addInstruction(f),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:f.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let m=this.createTxBuilder(l),d={};for(let p of i){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let y=n.useSOLBalance&&p.mint.address===Z.toString(),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(p.mint.programId),mint:new j(p.mint.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new It(new O(p.perSecond.mul(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.mul(p.endTime-p.openTime))?p.perSecond.mul(p.endTime-p.openTime).toFixed(0):p.perSecond.mul(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:y?!1:o,checkCreateATAOwner:s});b&&m.addInstruction(b),f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t!=null?t:await this.getClmmPoolKeys(e.id),A=Se.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardInfo:{mint:new j(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ue.decimalToX64(p.perSecond)}});m.addInstruction(A),d=M(M({},d),A.address)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let m=this.createTxBuilder(u),d=t.useSOLBalance&&n.equals(Z),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(l.mint.programId),mint:n,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:i,checkCreateATAOwner:o});y&&m.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=Se.collectRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return m.addInstruction(b),m.addCustomComputeBudget(s),m.addTipInstruction(a),m.versionBuild({txVersion:c,extInfo:{address:b.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:i=!0,checkCreateATAOwner:o=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let m of n){let d=e.rewardDefaultInfos.find(A=>A.mint.address===m.toString());if(!d){this.logAndCreateError("reward mint error","not found reward mint",m);continue}let p=t.useSOLBalance&&m.equals(Z),{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(d.mint.programId),mint:m,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:i,checkCreateATAOwner:o});y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),f&&u.addInstruction(f);let b=await this.getClmmPoolKeys(e.id),g=Se.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardMint:m});u.addInstruction(g),l=M(M({},l),g.address)}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:i,amountOutMin:o,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintA.address,A=c.useSOLBalance&&e.mintA.address===Z.toBase58(),k=c.useSOLBalance&&e.mintB.address===Z.toBase58(),T;!s||s.equals(new O(0))?T=g?Ft.add(new It(1)):Dt.sub(new It(1)):T=oe.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let I;if(!I){let{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new j(e.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:A||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?i:0}:void 0,associatedOnly:A?!1:l,checkCreateATAOwner:m});I=x,C&&b.addInstruction(C)}let h;if(!h){let{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new j(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:i}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:m});h=x,C&&b.addInstruction(C)}(!I||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:I,ownerTokenAccountB:h,mintAUseSOLBalance:A,mintBUseSOLBalance:k,associatedOnly:l});let S=t!=null?t:await this.getClmmPoolKeys(e.id);return b.addInstruction(Se.makeSwapBaseInInstructions({poolInfo:e,poolKeys:S,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:I,tokenAccountB:h},inputMint:new j(n),amountIn:i,amountOutMin:o,sqrtPriceLimitX64:T,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:i,amountInMax:o,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintB.address,A=c.useSOLBalance&&e.mintA.address===Z.toBase58(),k=c.useSOLBalance&&e.mintB.address===Z.toBase58(),T;!s||s.equals(new O(0))?T=n.toString()===e.mintB.address?Ft.add(new It(1)):Dt.sub(new It(1)):T=oe.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let I;if(!I){let{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new j(e.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,skipCloseAccount:!A,createInfo:A||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?o:0}:void 0,associatedOnly:A?!1:l,checkCreateATAOwner:m});I=x,C&&b.addInstruction(C)}let h;if(!h){let{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new j(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:o}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:m});h=x,C&&b.addInstruction(C)}(!I||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:I,ownerTokenAccountB:h,mintAUseSOLBalance:A,mintBUseSOLBalance:k,associatedOnly:l});let S=t!=null?t:await this.getClmmPoolKeys(e.id);return b.addInstruction(Se.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:S,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:I,tokenAccountB:h},outputMint:new j(n),amountOut:i,amountInMax:o,sqrtPriceLimitX64:T,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:i,associatedOnly:o=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){var b,g;let m={};for(let A of this.scope.account.tokenAccountRawInfos)o?J(this.scope.ownerPubKey,A.accountInfo.mint,a).publicKey.equals(A.pubkey)&&(m[A.accountInfo.mint.toString()]=A.pubkey):m[A.accountInfo.mint.toString()]=A.pubkey;let d=Object.values(t).flat().map(A=>A.nftMint),p=await Ne(this.scope.connection,d.map(A=>({pubkey:A}))),y={};p.forEach(A=>{var k,T;y[A.pubkey.toBase58()]=(T=(k=A==null?void 0:A.accountInfo)==null?void 0:k.owner)!=null?T:null});let f=this.createTxBuilder(l);for(let A of Object.values(e)){if(t[A.id]===void 0||!t[A.id].find(K=>!K.liquidity.isZero()||K.rewardInfos.find(L=>!L.rewardAmountOwed.isZero())))continue;let k=A,T=i.useSOLBalance&&k.mintA.address===Z.toString(),I=i.useSOLBalance&&k.mintB.address===Z.toString(),h=m[k.mintA.address];if(!h)if(T){let{account:K,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:k.mintA.programId,mint:new j(k.mintA.address),notUseTokenAccount:T,owner:this.scope.ownerPubKey,skipCloseAccount:!T,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:T?!1:o,checkCreateATAOwner:s});h=K,L&&f.addInstruction(L)}else{let K=new j(k.mintA.address);h=this.scope.account.getAssociatedTokenAccount(K,new j(k.mintA.programId)),f.addInstruction({instructions:[Al(this.scope.ownerPubKey,h,this.scope.ownerPubKey,K)]})}let S=m[k.mintB.address];if(!S)if(I){let{account:K,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:k.mintB.programId,mint:new j(k.mintB.address),notUseTokenAccount:I,owner:this.scope.ownerPubKey,skipCloseAccount:!I,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:I?!1:o,checkCreateATAOwner:s});S=K,L&&f.addInstruction(L)}else{let K=new j(k.mintB.address);S=this.scope.account.getAssociatedTokenAccount(K,new j(k.mintB.programId)),f.addInstruction({instructions:[Al(this.scope.ownerPubKey,S,this.scope.ownerPubKey,K)]})}m[k.mintA.address]=h,m[k.mintB.address]=S;let x=[];for(let K of k.rewardDefaultInfos){let L=i.useSOLBalance&&K.mint.address===Z.toString(),R=m[K.mint.address];if(!R){let{account:V,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new j(K.mint.programId),mint:new j(K.mint.address),notUseTokenAccount:L,owner:this.scope.ownerPubKey,skipCloseAccount:!L,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:L?!1:o});R=V,_&&f.addInstruction(_)}m[K.mint.address]=R,x.push(R)}let C=await this.getClmmPoolKeys(k.id),B=[];for(let K=0;K<C.rewardInfos.length;K++)B.push({poolRewardVault:new j(C.rewardInfos[K].vault),ownerRewardVault:x[K],rewardMint:new j(C.rewardInfos[K].mint.address)});for(let K of t[A.id]){let L=(b=n==null?void 0:n[A.id])==null?void 0:b[K.nftMint.toBase58()];if(L){let R=J(this.scope.ownerPubKey,L.lockNftMint,xo).publicKey,V=$.getTickArrayStartIndexByTick(K.tickLower,C.config.tickSpacing),_=$.getTickArrayStartIndexByTick(K.tickUpper,C.config.tickSpacing),{publicKey:W}=ge(new j(C.programId),L.poolId,V),{publicKey:Y}=ge(new j(C.programId),L.poolId,_),{publicKey:se}=tn(new j(C.programId),L.poolId,K.tickLower,K.tickUpper),Ae=hi(Qn,L.lockNftMint).publicKey,ce=Se.harvestLockPositionInstructionV2({programId:Qn,auth:Xi,lockPositionId:Ae,clmmProgram:An,lockOwner:this.scope.ownerPubKey,lockNftMint:L.lockNftMint,lockNftAccount:R,positionNftAccount:L.nftAccount,positionId:L.positionId,poolId:L.poolId,protocolPosition:se,vaultA:new j(C.vault.A),vaultB:new j(C.vault.B),tickArrayLower:W,tickArrayUpper:Y,userVaultA:h,userVaultB:S,mintA:new j(C.mintA.address),mintB:new j(C.mintB.address),rewardAccounts:B,exTickArrayBitmap:Xe(An,L.poolId).publicKey});f.addInstruction({instructions:[ce],instructionTypes:[X.ClmmHarvestLockPosition],lookupTableAddress:C.lookupTableAccount?[C.lookupTableAccount]:[]})}else{let R=Se.decreaseLiquidityInstructions({poolInfo:k,poolKeys:C,ownerPosition:K,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:S,rewardAccounts:x},liquidity:new It(0),amountMinA:new It(0),amountMinB:new It(0),nft2022:(g=y[K.nftMint.toBase58()])==null?void 0:g.equals(Dn)});f.addInstruction(R)}}}return c===0?f.sizeCheckBuildV0({computeBudgetConfig:u}):f.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(yo(e).publicKey);return t?jc.decode(t.data).whitelistMints.filter(i=>!i.equals(j.default)):[]}async getOwnerPositionInfo({programId:e=An}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new It(1))).map(s=>Tt(new j(e),s.accountInfo.mint).publicKey),i=await this.scope.connection.getMultipleAccountsInfo(n),o=[];return i.forEach(s=>{if(!s)return;let a=Ti.decode(s.data);o.push(a)}),o}async getOwnerLockedPositionInfo({programId:e=Qn}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(c=>c.accountInfo.amount.eq(new It(1))).map(c=>hi(new j(e),c.accountInfo.mint).publicKey),i=await this.scope.connection.getMultipleAccountsInfo(n),o=[];i.forEach(c=>{if(!c)return;let u=Yc.decode(c.data);o.push(u)});let s=await this.scope.connection.getMultipleAccountsInfo(o.map(c=>c.positionId)),a=[];return s.forEach(c=>{if(!c)return;let u=Ti.decode(c.data);a.push(u)}),o.map((c,u)=>({position:a[u],lockInfo:c}))}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Ne(this.scope.connection,e.map(o=>({pubkey:new j(o)})),t),i={};for(let o=0;o<e.length;o++){let s=n[o];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[o]));let a=$n.decode(s.accountInfo.data),c=oe.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();i[String(e[o])]=U(M({},a),{currentPrice:c,programId:s.accountInfo.owner})}return i}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),i=await Ne(this.scope.connection,Array.from(n).map(c=>({pubkey:new j(c)}))),o={};i.forEach(c=>{!c.accountInfo||(o[c.pubkey.toBase58()]=zc.decode(c.accountInfo.data))});let s=await Re.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{var m,d,p,y;let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:yt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||xo.toBase58(),extensions:{feeConfig:(m=t[u])!=null&&m.feeConfig?Vn((d=t[u])==null?void 0:d.feeConfig):void 0}}),mintB:yt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||xo.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?Vn((y=t[l])==null?void 0:y.feeConfig):void 0}}),price:e[c].currentPrice,config:U(M({},o[e[c].ammConfig.toBase58()]),{id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await Re.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),i=await li({connection:this.scope.connection,mints:Array.from(n).map(m=>new j(m))}),{computeClmmPoolInfo:o,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:i}),a=await Ne(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=Xc(o[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(Pl.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(Pl.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let u=U(M({},o[e]),{exBitmapAccount:o[e].exBitmapAccount.toBase58(),observationId:o[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:o[e].rewardInfos.filter(m=>!m.tokenVault.equals(j.default)).map(m=>({mint:yt({address:m.tokenMint.toBase58(),programId:xo.toBase58(),decimals:10}),vault:m.tokenVault.toBase58()}))});return{poolInfo:c,poolKeys:u,computePoolInfo:o[e],tickData:s}}};import{PublicKey as z}from"@solana/web3.js";import{AccountLayout as Hf,NATIVE_MINT as es,TOKEN_PROGRAM_ID as Et,createAssociatedTokenAccountIdempotentInstruction as Ll}from"@solana/spl-token";import Da from"bn.js";import Yr from"decimal.js-light";import Ko from"bn.js";function zr(r,e){if(e.isZero())throw Error("divisor is zero");return r.mod(e)}function Mf(r,e){if(e.isZero())throw Error("rhs is zero");let t=r.div(e);if(t.isZero())throw Error("quotient is zero");let n=zr(r,e);return n.gt(Ki)&&(t=t.add(new Ko(1)),e=r.div(t),n=zr(r,t),n.gt(Ki)&&(e=e.add(new Ko(1)))),[t,e]}var Ki=new Ko(0),Hr=class{static swapWithoutFees(e,t,n){let i=t.mul(n),o=t.add(e),[s]=Mf(i,o),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,i,o){let s=e.mul(n).div(t),a=e.mul(i).div(t);if(o===0)return{tokenAmount0:s,tokenAmount1:a};if(o===1)return zr(e.mul(n),t).gt(Ki)&&s.gt(Ki)&&(s=s.add(new Ko(1))),zr(e.mul(i),t).gt(Ki)&&a.gt(Ki)&&(a=a.add(new Ko(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var jr=class{static tradingFee(e,t){return cr(e,t,Yt)}static protocolFee(e,t){return Ms(e,t,Yt)}static fundFee(e,t){return Ms(e,t,Yt)}};var wl=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(wl||{}),Zr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,i){let o=jr.tradingFee(e,i),s=e.sub(o),{destinationAmountSwapped:a}=Hr.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:o}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:i,quoteReserve:o,outputMint:s,outputAmount:a}){let[c,u,l,m,d]=t.address===s.toString()?[i,o,e.decimals,t.decimals,e.address]:[o,i,t.decimals,e.decimals,t.address],p=new Yr(u.toString()).div(10**m).div(new Yr(c.toString()).div(10**l)),y=a.gte(u)?u.sub(new Da(1)):a,f=u.sub(y),b=Nn(c.mul(y),f),g=Nn(b.mul(new Da(1e6)),new Da(1e6).sub(n)),A=g.sub(b),k=new Yr(y.toString()).div(10**m).div(new Yr(g.toString()).div(10**l)),T=p.isZero()?0:k.sub(p).div(p).abs().toNumber();return{amountRealOut:y,amountIn:g,amountInWithoutFee:b,tradeFee:A,priceImpact:T}}};import Qe from"bn.js";import{PublicKey as Ro,TransactionInstruction as ri,Keypair as Gf,SystemProgram as Xf}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Tl,TOKEN_2022_PROGRAM_ID as qa,TOKEN_PROGRAM_ID as Wn}from"@solana/spl-token";var vf=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),Ef=Buffer.from("amm_config","utf8"),_f=Buffer.from("pool","utf8"),Vf=Buffer.from("pool_lp_mint","utf8"),Ff=Buffer.from("pool_vault","utf8"),Df=Buffer.from("observation","utf8");function Ci(r){return ie([vf],r)}function uS(r,e){return ie([Ef,qf(e)],r)}function Wa(r,e,t,n){return ie([_f,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Wf(r,e){return ie([Vf,e.toBuffer()],r)}function kl(r,e,t){return ie([Ff,e.toBuffer(),t.toBuffer()],r)}function Co(r,e){return ie([Df,e.toBuffer()],r)}function qf(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function hl({poolId:r,programId:e,configId:t,mintA:n,mintB:i}){let o=Ci(e).publicKey,s=r||Wa(e,t,n,i).publicKey,a=Wf(e,s).publicKey,c=kl(e,s,n).publicKey,u=kl(e,s,i).publicKey,l=Co(e,s).publicKey;return{poolId:s,configId:t,authority:o,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Uf=Buffer.from("locked_liquidity","utf8");function Lo(r,e){return ie([Uf,e.toBuffer()],r)}var Qf=fe("Raydium_cpmm"),si={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function Il(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A,k){let T=E([w("amountMaxA"),w("amountMaxB"),w("openTime")]),I=Wa(r,t,o,s).publicKey,h=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!i.equals(I),isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:Tl,isSigner:!1,isWritable:!1},{pubkey:sr,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],S=Buffer.alloc(T.span);return T.encode({amountMaxA:g,amountMaxB:A,openTime:k},S),new ri({keys:h,programId:r,data:Buffer.from([...si.initialize,...S])})}function Bl(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y){let f=E([w("lpAmount"),w("amountMaxA"),w("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:qa,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return Qf.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:d,amountMaxA:p,amountMaxB:y},g),new ri({keys:b,programId:r,data:Buffer.from([...si.deposit,...g])})}function xl(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y){let f=E([w("lpAmount"),w("amountMinA"),w("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:qa,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:an,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:d,amountMinA:p,amountMinB:y},g),new ri({keys:b,programId:r,data:Buffer.from([...si.withdraw,...g])})}function $r(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y,f){let b=E([w("amountIn"),w("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},A),new ri({keys:g,programId:r,data:Buffer.from([...si.swapBaseInput,...A])})}function Sl(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y,f){let b=E([w("amountInMax"),w("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},A),new ri({keys:g,programId:r,data:Buffer.from([...si.swapBaseOutput,...A])})}async function Kl(r){var b;let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:i,getEphemeralSigners:o}=r,s=[],[a,c]=[new Ro(t.id),new Ro(t.lpMint.address)],u;if(o)u=new Ro((await o(1))[0]);else{let g=Gf.generate();s.push(g),u=g.publicKey}let{publicKey:l}=J(i,u,Wn),{publicKey:m}=hn(u),{publicKey:d}=Lo(r.lockProgram,u),{publicKey:p}=J(e.wallet,c,Wn),{publicKey:y}=J(r.lockAuthProgram,c,Wn),f=zf({programId:r.lockProgram,auth:r.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:i,nftMint:u,nftAccount:l,poolId:a,lockPda:d,mintLp:c,userLpVault:p,lockLpVault:y,poolVaultA:new Ro(n.vault.A),poolVaultB:new Ro(n.vault.B),metadataAccount:m,lpAmount:r.lpAmount,withMetadata:(b=r.withMetadata)!=null?b:!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:m,lockPda:d,userLpVault:p,lockLpVault:y},instructions:[f],signers:s,instructionTypes:[X.CpmmLockLp],lookupTableAddress:[]}}function zf({programId:r,auth:e,payer:t,liquidityOwner:n,nftOwner:i,nftMint:o,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:m,poolVaultA:d,poolVaultB:p,metadataAccount:y,lpAmount:f,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Xf.programId,isSigner:!1,isWritable:!1},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:Tl,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1}],A=E([w("lpAmount"),Fe("withMetadata")]),k=Buffer.alloc(A.span);A.encode({lpAmount:f,withMetadata:b},k);let T=Buffer.from([...si.lockCpLiquidity,...k]);return new ri({keys:g,programId:r,data:T})}function Ua({programId:r,nftOwner:e,auth:t,nftAccount:n,lockPda:i,poolId:o,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:m,mintB:d,lockLpVault:p,lpFeeAmount:y,cpmmProgram:f,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:f!=null?f:Qi,isSigner:!1,isWritable:!1},{pubkey:b!=null?b:Fs,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Wn,isSigner:!1,isWritable:!1},{pubkey:qa,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1}],A=E([w("lpFeeAmount")]),k=Buffer.alloc(A.span);A.encode({lpFeeAmount:y},k);let T=Buffer.from([...si.collectCpFee,...k]);return new ri({keys:g,programId:r,data:T})}var Cl=E([Te(8),q("bump"),Fe("disableCreatePool"),$t("index"),w("tradeFeeRate"),w("protocolFeeRate"),w("fundFeeRate"),w("createPoolFee"),N("protocolOwner"),N("fundOwner"),H(w(),16)]),Jr=E([Te(8),N("configId"),N("poolCreator"),N("vaultA"),N("vaultB"),N("mintLp"),N("mintA"),N("mintB"),N("mintProgramA"),N("mintProgramB"),N("observationId"),q("bump"),q("status"),q("lpDecimals"),q("mintDecimalA"),q("mintDecimalB"),w("lpAmount"),w("protocolFeesMintA"),w("protocolFeesMintB"),w("fundFeesMintA"),w("fundFeesMintB"),w("openTime"),H(w(),32)]);var No=class extends Me{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await Ne(this.scope.connection,e.map(m=>({pubkey:new z(m)}))),i={},o=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=Jr.decode(d.accountInfo.data);i[String(e[m])]=U(M({},p),{programId:d.accountInfo.owner}),o.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...o],d=await Ne(this.scope.connection,m.map(p=>({pubkey:new z(p)})));for(let p=0;p<m.length;p++){let y=d[p].accountInfo;if(y===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=Cl.decode(y.data)}}let c={},u=await Ne(this.scope.connection,s.map(m=>({pubkey:new z(m)})));for(let m=0;m<s.length;m++){let d=u[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);c[String(s[m])]=new Qe(Hf.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(i)){let p=c[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),y=c[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=U(M({},d),{baseReserve:p,quoteReserve:y,vaultAAmount:c[d.vaultA.toString()],vaultBAmount:c[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new O(y.toString()).div(new O(10).pow(d.mintDecimalB)).div(new O(p.toString()).div(new O(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,i)=>{var c,u,l,m;let o=e[i],[s,a]=[o.mintA.toBase58(),o.mintB.toBase58()];return U(M({},n),{[i]:U(M({},o),{id:new z(i),configInfo:o.configInfo,version:7,authority:Ci(o.programId).publicKey,mintA:yt({address:s,decimals:o.mintDecimalA,programId:o.mintProgramA.toBase58(),extensions:{feeConfig:(c=t[s])!=null&&c.feeConfig?Vn((u=t[s])==null?void 0:u.feeConfig):void 0}}),mintB:yt({address:a,decimals:o.mintDecimalB,programId:o.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?Vn((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await li({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),i=yt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?Vn(n[t.mintA.toBase58()].feeConfig):void 0}}),o=yt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?Vn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=yt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Et.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:i,mintB:o,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new O(t.vaultAAmount.toString()).div(10**i.decimals).toNumber(),mintAmountB:new O(t.vaultBAmount.toString()).div(10**o.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:i,mintB:o,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Ci(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:Co(t.programId,new z(e)).publicKey.toBase58()},rpcData:t}}async createPool(y){var f=y,{poolId:e,programId:t,poolFeeAccount:n,startTime:i,ownerInfo:o,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=f,p=De(f,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig","txTipConfig","feePayer"]);var W,Y,se;let b=o.feePayer||((W=this.scope.owner)==null?void 0:W.publicKey),g=new Qe(new z(p.mintA.address).toBuffer()).lte(new Qe(new z(p.mintB.address).toBuffer())),[A,k]=g?[p.mintA,p.mintB]:[p.mintB,p.mintA],[T,I]=g?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],h=o.useSOLBalance&&A.address===es.toBase58(),S=o.useSOLBalance&&k.address===es.toBase58(),[x,C]=[new z(A.address),new z(k.address)],B=this.createTxBuilder(d),{account:K,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:A.programId,owner:this.scope.ownerPubKey,createInfo:h?{payer:b,amount:T}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:s,checkCreateATAOwner:a});B.addInstruction(L||{});let{account:R,instructionParams:V}=await this.scope.account.getOrCreateTokenAccount({mint:new z(k.address),tokenProgram:k.programId,owner:this.scope.ownerPubKey,createInfo:S?{payer:b,amount:I}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:s,checkCreateATAOwner:a});if(B.addInstruction(V||{}),K===void 0||R===void 0)throw Error("you don't has some token account");let _=hl({poolId:e,programId:t,configId:new z(u.id),mintA:x,mintB:C});return B.addInstruction({instructions:[Il(t,this.scope.ownerPubKey,new z(u.id),_.authority,_.poolId,x,C,_.lpMint,K,R,J(this.scope.ownerPubKey,_.lpMint).publicKey,_.vaultA,_.vaultB,n,new z((Y=A.programId)!=null?Y:Et),new z((se=k.programId)!=null?se:Et),_.observationId,T,I,i)],instructionTypes:[X.CpmmCreatePool]}),B.addCustomComputeBudget(l),B.addTipInstruction(m),B.versionBuild({txVersion:c,extInfo:{address:U(M({},_),{mintA:A,mintB:k,programId:t,poolFeeAccount:n,feeConfig:u})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:i,baseIn:o,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:m,feePayer:d}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),i.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:i.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},l),b=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:A,anotherAmount:k}=a||this.computePairAmount({poolInfo:U(M({},t),{lpAmount:new O(b.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:b.baseReserve,quoteReserve:b.quoteReserve,slippage:new ot(0),baseIn:o,epochInfo:await this.scope.fetchEpochInfo(),amount:new O(i.toString()).div(10**(o?t.mintA.decimals:t.mintB.decimals))}),T=k.amount,I=t.mintA.address===es.toString(),h=t.mintB.address===es.toString(),S=this.createTxBuilder(d),[x,C]=[new z(t.mintA.address),new z(t.mintB.address)],{account:B,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:I||(o?i:T).isZero()?{payer:this.scope.ownerPubKey,amount:o?i:T}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!1,checkCreateATAOwner:f});S.addInstruction(K||{});let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||(o?T:i).isZero()?{payer:this.scope.ownerPubKey,amount:o?T:i}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!1,checkCreateATAOwner:f});S.addInstruction(R||{}),!B&&!L&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let V=await p.getCreatedTokenAccount({mint:new z(t.lpMint.address)}),Ae=await p.handleTokenAccount({side:"out",amount:0,mint:new z(t.lpMint.address),tokenAccount:V,bypassAssociatedCheck:y,checkCreateATAOwner:f}),{tokenAccount:_}=Ae,W=De(Ae,["tokenAccount"]);S.addInstruction(W);let Y=n!=null?n:await this.getCpmmPoolKeys(t.id),se=new ot(new Qe(1)).sub(s);return S.addInstruction({instructions:[Bl(new z(t.programId),this.scope.ownerPubKey,new z(Y.authority),new z(t.id),_,B,L,new z(Y.vault.A),new z(Y.vault.B),x,C,new z(t.lpMint.address),a?a==null?void 0:a.liquidity:se.mul(g).quotient,o?A.amount:T,o?T:A.amount)],instructionTypes:[X.CpmmAddLiquidity],lookupTableAddress:Y.lookupTableAccount?[Y.lookupTableAccount]:[]}),S.addCustomComputeBudget(c),S.addTipInstruction(u),S.versionBuild({txVersion:m})}async withdrawLiquidity(e){var W,Y;let{poolInfo:t,poolKeys:n,lpAmount:i,slippage:o,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let m=new ot(new Qe(1)).sub(o),d=await this.getRpcPoolInfo(t.id),[p,y]=[m.mul(i.mul(d.baseReserve).div(d.lpAmount)).quotient,m.mul(i.mul(d.quoteReserve).div(d.lpAmount)).quotient],f=await this.scope.fetchEpochInfo(),[b,g]=[he(p,t.mintA.extensions.feeConfig,f,!1),he(y,t.mintB.extensions.feeConfig,f,!1)],{account:A}=this.scope,k=this.createTxBuilder(u),[T,I]=[new z(t.mintA.address),new z(t.mintB.address)],h=T.equals(Z),S=I.equals(Z),x,C,{account:B,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(h&&l),associatedOnly:!h,checkCreateATAOwner:!1});x=B,K&&k.addInstruction(K);let{account:L,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:S,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(S&&l),associatedOnly:!S,checkCreateATAOwner:!1});C=L,R&&k.addInstruction(R),(!x||!C)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",A.tokenAccounts);let V=await A.getCreatedTokenAccount({mint:new z(t.lpMint.address)});V||this.logAndCreateError("cannot found lp token account","tokenAccounts",A.tokenAccounts);let _=n!=null?n:await this.getCpmmPoolKeys(t.id);return k.addInstruction({instructions:[xl(new z(t.programId),this.scope.ownerPubKey,new z(_.authority),new z(t.id),V,x,C,new z(_.vault.A),new z(_.vault.B),T,I,new z(t.lpMint.address),i,p.sub((W=b.fee)!=null?W:new Qe(0)),y.sub((Y=g.fee)!=null?Y:new Qe(0)))],instructionTypes:[X.CpmmWithdrawLiquidity],lookupTableAddress:_.lookupTableAccount?[_.lookupTableAccount]:[]}),k.addCustomComputeBudget(s),k.addTipInstruction(a),k.versionBuild({txVersion:c})}async swap(e){var K,L,R,V,_,W;let{poolInfo:t,poolKeys:n,baseIn:i,fixedOut:o,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,{bypassAssociatedCheck:y,checkCreateATAOwner:f,associatedOnly:b}=M({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},u),g=this.createTxBuilder(p),[A,k]=[new z(t.mintA.address),new z(t.mintB.address)];o?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Qe((1+c)*1e4)).div(new Qe(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Qe((1-c)*1e4)).div(new Qe(1e4));let T=t.mintA.address===Z.toBase58(),I=t.mintB.address===Z.toBase58(),{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:A,tokenProgram:new z((K=t.mintA.programId)!=null?K:Et),owner:this.scope.ownerPubKey,createInfo:T||!i?{payer:this.scope.ownerPubKey,amount:i?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:T,skipCloseAccount:!T,associatedOnly:T?!1:b,checkCreateATAOwner:f});S&&g.addInstruction(S);let{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:k,tokenProgram:new z((L=t.mintB.programId)!=null?L:Et),owner:this.scope.ownerPubKey,createInfo:I||i?{payer:this.scope.ownerPubKey,amount:i?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:b,checkCreateATAOwner:f});C&&g.addInstruction(C),(!h||!x)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:h,mintBTokenAcc:x,mintAUseSOLBalance:T,mintBUseSOLBalance:I,associatedOnly:b});let B=n!=null?n:await this.getCpmmPoolKeys(t.id);return g.addInstruction({instructions:[o?Sl(new z(t.programId),this.scope.ownerPubKey,new z(B.authority),new z(B.config.id),new z(t.id),i?h:x,i?x:h,new z(B.vault[i?"A":"B"]),new z(B.vault[i?"B":"A"]),new z((_=t[i?"mintA":"mintB"].programId)!=null?_:Et),new z((W=t[i?"mintB":"mintA"].programId)!=null?W:Et),i?A:k,i?k:A,Co(new z(t.programId),new z(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):$r(new z(t.programId),this.scope.ownerPubKey,new z(B.authority),new z(B.config.id),new z(t.id),i?h:x,i?x:h,new z(B.vault[i?"A":"B"]),new z(B.vault[i?"B":"A"]),new z((R=t[i?"mintA":"mintB"].programId)!=null?R:Et),new z((V=t[i?"mintB":"mintA"].programId)!=null?V:Et),i?A:k,i?k:A,Co(new z(t.programId),new z(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[o?X.CpmmSwapBaseOut:X.ClmmSwapBaseIn]}),g.addCustomComputeBudget(l),g.addTipInstruction(m),g.versionBuild({txVersion:d})}async lockLp(e){var d,p,y,f,b;let{poolInfo:t,lpAmount:n,computeBudgetConfig:i,txTipConfig:o,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=(d=e.poolKeys)!=null?d:await this.getCpmmPoolKeys(t.id),m=await Kl({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:(p=e.feePayer)!=null?p:this.scope.ownerPubKey},feeNftOwner:c!=null?c:this.scope.ownerPubKey,lockProgram:(y=e.programId)!=null?y:zi,lockAuthProgram:(f=e.authProgram)!=null?f:Hi,lpAmount:n,withMetadata:(b=e.withMetadata)!=null?b:!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(m),u.addCustomComputeBudget(i),u.addTipInstruction(o),u.versionBuild({txVersion:s,extInfo:m.address})}async harvestLockLp(e){var L;let{poolInfo:t,lpFeeAmount:n,nftMint:i,programId:o=zi,authProgram:s=Hi,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:m=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let d=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(d),[y,f]=[new z(t.mintA.address),new z(t.mintB.address)],b=y.equals(Z),g=f.equals(Z),A,k,{account:T,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(b&&m),associatedOnly:!b,checkCreateATAOwner:!1});A=T,I&&p.addInstruction(I);let{account:h,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&m),associatedOnly:!g,checkCreateATAOwner:!1});k=h,S&&p.addInstruction(S),(!A||!k)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:A,tokenAccountB:k});let x=(L=e.poolKeys)!=null?L:await this.getCpmmPoolKeys(t.id),{publicKey:C}=J(d,i,Et),{publicKey:B}=Lo(o,i),{publicKey:K}=J(s,new z(t.lpMint.address),Et);return p.addInstruction({instructions:[Ua({programId:o,nftOwner:this.scope.ownerPubKey,auth:s,nftMint:i,nftAccount:C,lockPda:B,poolId:new z(t.id),mintLp:new z(x.mintLp.address),userVaultA:A,userVaultB:k,poolVaultA:new z(x.vault.A),poolVaultB:new z(x.vault.B),mintA:y,mintB:f,lockLpVault:K,lpFeeAmount:n,cpmmProgram:a==null?void 0:a.programId,cpmmAuthProgram:a==null?void 0:a.authProgram})],instructionTypes:[X.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}async harvestMultiLockLp(e){let{lockInfo:t,programId:n=zi,authProgram:i=Hi,cpmmProgram:o,computeBudgetConfig:s,txVersion:a,closeWsol:c=!0}=e,u=e.feePayer||this.scope.ownerPubKey,l=this.createTxBuilder(u);return t.forEach(async m=>{var C;let{poolInfo:d,lpFeeAmount:p,nftMint:y}=m;if(p.isZero())return;let[f,b]=[new z(d.mintA.address),new z(d.mintB.address)],g=f.equals(Z),A=b.equals(Z),k,T;if(g){let{account:B,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintA.programId,mint:new z(d.mintA.address),notUseTokenAccount:!0,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!c,associatedOnly:!1,checkCreateATAOwner:!1});k=B,K&&l.addInstruction(K)}else{let B=new z(d.mintA.address);k=this.scope.account.getAssociatedTokenAccount(B,new z(d.mintA.programId)),l.addInstruction({instructions:[Ll(this.scope.ownerPubKey,k,this.scope.ownerPubKey,B)]})}if(A){let{account:B,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:d.mintB.programId,mint:new z(d.mintB.address),notUseTokenAccount:!0,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!c,associatedOnly:!1,checkCreateATAOwner:!1});T=B,K&&l.addInstruction(K)}else{let B=new z(d.mintB.address);T=this.scope.account.getAssociatedTokenAccount(B,new z(d.mintB.programId)),l.addInstruction({instructions:[Ll(this.scope.ownerPubKey,T,this.scope.ownerPubKey,B)]})}(!k||!T)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:k,tokenAccountB:T});let I=(C=m.poolKeys)!=null?C:await this.getCpmmPoolKeys(d.id),{publicKey:h}=J(u,y,Et),{publicKey:S}=Lo(n,y),{publicKey:x}=J(i,new z(d.lpMint.address),Et);l.addInstruction({instructions:[Ua({programId:n,nftOwner:this.scope.ownerPubKey,auth:i,nftMint:y,nftAccount:h,lockPda:S,poolId:new z(d.id),mintLp:new z(I.mintLp.address),userVaultA:k,userVaultB:T,poolVaultA:new z(I.vault.A),poolVaultB:new z(I.vault.B),mintA:f,mintB:b,lockLpVault:x,lpFeeAmount:p,cpmmProgram:o==null?void 0:o.programId,cpmmAuthProgram:o==null?void 0:o.authProgram})],instructionTypes:[X.CpmmCollectLockFee]})}),a===0?l.sizeCheckBuildV0({computeBudgetConfig:s}):l.sizeCheckBuild({computeBudgetConfig:s})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:i}){let o=n.toString()===e.mintB.address,s=Zr.swap(t,o?e.baseReserve:e.quoteReserve,o?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new O(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new Qe((1-i)*1e4)).div(new Qe(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:i,slippage:o,epochInfo:s,baseIn:a}){var T,I,h,S,x,C,B,K,L;let c=1-Number(o.toSignificant())/100,u=new Qe(new O(i).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=he(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=u.sub((T=l.fee)!=null?T:new Qe(0)),d=new Qe(new O(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",(h=(I=l.fee)==null?void 0:I.toString())!=null?h:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${o.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let y=m.mul(d).div(p==="base"?t:n),f={amount:St,fee:void 0,expirationTime:void 0};if(!m.isZero()){let R=jf(y,t,n,d);this.logDebug("lpAmountData:",{amountA:R.amountA.toString(),amountB:R.amountB.toString()}),f=he(R[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new ot(new Qe(1)).add(o),g=new ot(new Qe(1)).sub(o),A=he(b.mul(f.amount.sub((S=f.fee)!=null?S:new Qe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),k=he(g.mul(f.amount.sub((x=f.fee)!=null?x:new Qe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",(B=(C=f.fee)==null?void 0:C.toString())!=null?B:0,"maxAnotherAmount:",A.amount.toString(),"maxAnotherAmountFee:",(L=(K=A.fee)==null?void 0:K.toString())!=null?L:0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:A,minAnotherAmount:k,liquidity:y}}};function jf(r,e,t,n){let i=r.mul(e).div(n);!i.isZero()&&!r.mul(e).mod(n).isZero()&&(i=i.add(new Qe(1)));let o=r.mul(t).div(n);return!o.isZero()&&!r.mul(t).mod(n).isZero()&&(o=o.add(new Qe(1))),{amountA:i,amountB:o}}import{PublicKey as ai}from"@solana/web3.js";import{createTransferInstruction as El,TOKEN_PROGRAM_ID as ze,TOKEN_2022_PROGRAM_ID as is}from"@solana/spl-token";import os from"bn.js";var Rl={[fr.toBase58()]:3},Nl={3:fr};var Ga=E([Te(5),Te(8),N("ownAddress"),w("vaultSignerNonce"),N("baseMint"),N("quoteMint"),N("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),N("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),N("requestQueue"),N("eventQueue"),N("bids"),N("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),Te(7)]),Ol={3:Ga};import{PublicKey as Ml}from"@solana/web3.js";var ts=fe("Serum"),ns=class{static getProgramId(e){let t=Nl[e];return t||ts.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Rl[t];return n||ts.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Ol[e];return t||ts.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,o;for(;i<100;){try{let s=n.concat(Buffer.from([i]),Buffer.alloc(7));o=Ml.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;i++;continue}return{publicKey:o,nonce:i}}return ts.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Ml.default,nonce:i}}};import{PublicKey as v,SystemProgram as Oo,TransactionInstruction as Mo}from"@solana/web3.js";import ln from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Xa,TOKEN_2022_PROGRAM_ID as Qa,TOKEN_PROGRAM_ID as qn}from"@solana/spl-token";function KK(r,e,t,n,i,o,s,a,c,u,l,m){let d=E([q("instruction"),w("amountIn"),w("amountOut")]),p=[{pubkey:Oo.programId,isSigner:!1,isWritable:!1},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:new v(t.programId),isSigner:!1,isWritable:!1},{pubkey:new v(t.id),isSigner:!1,isWritable:!0},{pubkey:new v(n.id),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Oe(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...m.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Oe(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new v("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Oe(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(d.span);return d.encode({instruction:4,amountIn:u,amountOut:l},y),new Mo({keys:p,programId:r,data:y})}function CK(r,e,t,n,i,o,s,a,c,u){let l=E([q("instruction")]),m=[{pubkey:Oo.programId,isSigner:!1,isWritable:!1},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:new v(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new v(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new v(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Oe(n);m.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...u.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Oe(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new v("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Oe(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let d=Buffer.alloc(l.span);return l.encode({instruction:5},d),new Mo({keys:m,programId:r,data:d})}function Yf(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y){var h;let f=[],b=[P({pubkey:qn,isWritable:!1}),P({pubkey:Qa,isWritable:!1}),P({pubkey:Xa,isWritable:!1}),P({pubkey:Oo.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})];b.push(P({pubkey:t})),b.push(P({pubkey:i}));let g=[c,u],A=[l,m],k=[o,s,a];for(let S=0;S<g.length;S++){let x=g[S],C=k[S]===x.mintA.address;if(b.push(P({pubkey:new v(x.programId),isWritable:!1})),S===g.length-1?b.push(P({pubkey:i})):b.push(P({pubkey:n})),b.push(P({pubkey:new v(k[S])})),b.push(P({pubkey:new v(k[S+1])})),x.version===6){let B=A[S];b.push(P({pubkey:new v(B.config.id)})),b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(C?B.vault.A:B.vault.B)})),b.push(P({pubkey:new v(C?B.vault.B:B.vault.A)})),b.push(P({pubkey:new v(x.observationId)})),b.push(P({pubkey:an})),b.push(P({pubkey:Xe(new v(x.programId),new v(x.id)).publicKey})),f.push(za(x.sqrtPriceX64.toString(),C));for(let K of(h=y[S])!=null?h:[])b.push(P({pubkey:new v(K)}))}else if(x.version===5){let B=A[S];b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(B.authority),isWritable:!1})),b.push(P({pubkey:new v(B.marketProgramId)})),b.push(P({pubkey:new v(B.marketAuthority)})),b.push(P({pubkey:yr,isWritable:!1})),b.push(P({pubkey:new v(B.openOrders)})),b.push(P({pubkey:new v(B.vault.A)})),b.push(P({pubkey:new v(B.vault.B)})),b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(B.marketId)})),b.push(P({pubkey:new v(B.marketBids)})),b.push(P({pubkey:new v(B.marketAsks)})),b.push(P({pubkey:new v(B.marketEventQueue)})),b.push(P({pubkey:new v(B.marketBaseVault)})),b.push(P({pubkey:new v(B.marketQuoteVault)}))}else if(x.version===4){let B=A[S],K=x.status!==1;b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(B.authority),isWritable:!1})),b.push(P({pubkey:new v(K?B.id:B.marketProgramId)})),b.push(P({pubkey:new v(K?B.id:B.marketAuthority)})),b.push(P({pubkey:new v(K?B.id:B.openOrders)})),b.push(P({pubkey:new v(B.vault.A)})),b.push(P({pubkey:new v(B.vault.B)})),b.push(P({pubkey:new v(K?B.id:B.marketId)})),b.push(P({pubkey:new v(K?B.id:B.marketBids)})),b.push(P({pubkey:new v(K?B.id:B.marketAsks)})),b.push(P({pubkey:new v(K?B.id:B.marketEventQueue)})),b.push(P({pubkey:new v(K?B.id:B.marketBaseVault)})),b.push(P({pubkey:new v(K?B.id:B.marketQuoteVault)}))}else if(x.version===7){let B=A[S];b.push(P({pubkey:new v(B.authority)})),b.push(P({pubkey:new v(B.config.id)})),b.push(P({pubkey:new v(B.id)})),b.push(P({pubkey:new v(C?B.vault.A:B.vault.B)})),b.push(P({pubkey:new v(C?B.vault.B:B.vault.A)})),b.push(P({pubkey:new v(x.observationId)}))}else throw Error("pool type error")}let T=E([q("insId"),w("amountIn"),w("amountOut"),H(te(),f.length,"clmmPriceLimit")]),I=Buffer.alloc(T.span);return T.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:f},I),new Mo({keys:b,programId:r,data:I})}function za(r,e){if(r)if(e){let t=new ln(r).div(new ln(25));return t.gt(Mr)?t:Mr}else{let t=new ln(r).mul(new ln(25));return t.lt(vr)?t:vr}else return e?Mr:vr}function vl({routeProgram:r,ownerInfo:e,inputMint:t,swapInfo:n}){var i,o,s,a,c,u,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=Oe(m),p=t.equals(d.mintA.address)?Ft.add(Ot):Dt.sub(Ot);return Se.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((o=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?o:new ln(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[$r(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new v(m[d?"mintA":"mintB"].address),new v(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?X.CpmmSwapBaseIn:X.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[qr({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((c=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?c:new ln(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?X.AmmV5SwapBaseIn:X.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],y=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Yf(r,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,y,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?l:new ln(0)),n.remainingAccounts)],instructionTypes:[X.RouteSwap],lookupTableAddress:[p.lookupTableAccount,y.lookupTableAccount].filter(f=>f!==void 0),address:{}}}else throw Error("route type error")}function LK({programId:r,wallet:e,amount:t,inputAccount:n,outputAccount:i,routeInfo:o,poolKeys:s}){var d;if(o.success===!1)throw Error("route info error");let a=[],c=[P({pubkey:qn,isWritable:!1}),P({pubkey:Qa,isWritable:!1}),P({pubkey:Xa,isWritable:!1}),P({pubkey:Oo.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})],u={[o.data.inputMint]:n,[o.data.outputMint]:i};c.push(P({pubkey:u[o.data.inputMint]})),c.push(P({pubkey:u[o.data.outputMint]}));for(let p=0;p<s.length;p++){let y=o.data.routePlan[p],f=s[p],b=y.inputMint===f.mintA.address;if(c.push(P({pubkey:new v(f.programId),isWritable:!1})),p===s.length-1)c.push(P({pubkey:u[y.outputMint]}));else{let g=y.outputMint;if(u[g]===void 0){let A=J(e,new v(g),f.programId===At.CLMM_PROGRAM_ID.toBase58()||f.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new v(b?f.mintB.programId:f.mintA.programId):qn).publicKey;u[g]=A}c.push(P({pubkey:u[g]}))}if(c.push(P({pubkey:new v(y.inputMint)})),c.push(P({pubkey:new v(y.outputMint)})),f.programId===At.CLMM_PROGRAM_ID.toBase58()){let g=f;c.push(P({pubkey:new v(g.config.id)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(b?g.vault.A:g.vault.B)})),c.push(P({pubkey:new v(b?g.vault.B:g.vault.A)})),c.push(P({pubkey:new v(g.observationId)})),c.push(P({pubkey:an,isWritable:!1})),c.push(P({pubkey:new v(g.exBitmapAccount)})),a.push(za(y.lastPoolPriceX64,b));for(let A of(d=y.remainingAccounts)!=null?d:[])c.push(P({pubkey:new v(A)}))}else if(f.programId===At.AMM_STABLE.toBase58()){let g=f;c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.authority),isWritable:!1})),c.push(P({pubkey:new v(g.marketProgramId),isWritable:!1})),c.push(P({pubkey:new v(g.marketAuthority),isWritable:!1})),c.push(P({pubkey:yr,isWritable:!1})),c.push(P({pubkey:new v(g.openOrders)})),c.push(P({pubkey:new v(g.vault.A)})),c.push(P({pubkey:new v(g.vault.B)})),c.push(P({pubkey:new v(g.marketId)})),c.push(P({pubkey:new v(g.marketBids)})),c.push(P({pubkey:new v(g.marketAsks)})),c.push(P({pubkey:new v(g.marketEventQueue)})),c.push(P({pubkey:new v(g.marketBaseVault)})),c.push(P({pubkey:new v(g.marketQuoteVault)}))}else if(f.programId===At.AMM_V4.toBase58()){let g=f;c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.authority),isWritable:!1})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.vault.A)})),c.push(P({pubkey:new v(g.vault.B)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(g.id)}))}else if(f.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()){let g=f;c.push(P({pubkey:new v(g.authority)})),c.push(P({pubkey:new v(g.config.id)})),c.push(P({pubkey:new v(g.id)})),c.push(P({pubkey:new v(b?g.vault.A:g.vault.B)})),c.push(P({pubkey:new v(b?g.vault.B:g.vault.A)})),c.push(P({pubkey:new v(g.observationId)}))}else throw Error("pool type error")}let l=E([q("insId"),w("amountIn"),w("amountOut"),H(te(),a.length,"clmmPriceLimit")]),m=Buffer.alloc(l.span);return l.encode({insId:0,amountIn:t,amountOut:new ln(o.data.otherAmountThreshold),clmmPriceLimit:a},m),new Mo({keys:c,programId:r,data:m})}function RK({programId:r,wallet:e,inputAccount:t,outputAccount:n,routeInfo:i,poolKeys:o}){var m;if(i.success===!1)throw Error("route info error");let s=[],a=[P({pubkey:qn,isWritable:!1}),P({pubkey:Qa,isWritable:!1}),P({pubkey:Xa,isWritable:!1}),P({pubkey:Oo.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})],c={[i.data.inputMint]:t,[i.data.outputMint]:n};for(let d=o.length-1;d>=0;d--){let p=i.data.routePlan[d],y=o[d],f=p.inputMint===y.mintA.address;if(a.push(P({pubkey:new v(y.programId)})),d===0)a.push(P({pubkey:c[p.inputMint]}));else{let b=p.inputMint;if(c[b]===void 0){let g=J(e,new v(b),y.programId===At.CLMM_PROGRAM_ID.toBase58()||y.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new v(f?y.mintA.programId:y.mintB.programId):qn).publicKey;c[b]=g}a.push(P({pubkey:c[b]}))}if(d===o.length-1)a.push(P({pubkey:c[p.outputMint]}));else{let b=p.outputMint;if(c[b]===void 0){let g=J(e,new v(b),y.programId===At.CLMM_PROGRAM_ID.toBase58()||y.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new v(f?y.mintB.programId:y.mintA.programId):qn).publicKey;c[b]=g}a.push(P({pubkey:c[b]}))}if(a.push(P({pubkey:new v(p.inputMint)})),a.push(P({pubkey:new v(p.outputMint)})),y.programId===At.CLMM_PROGRAM_ID.toBase58()){let b=y;a.push(P({pubkey:new v(b.config.id)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(f?b.vault.A:b.vault.B)})),a.push(P({pubkey:new v(f?b.vault.B:b.vault.A)})),a.push(P({pubkey:new v(b.observationId)})),a.push(P({pubkey:an,isWritable:!1})),a.push(P({pubkey:new v(b.exBitmapAccount)})),s.push(za(p.lastPoolPriceX64,f));for(let g of(m=p.remainingAccounts)!=null?m:[])a.push(P({pubkey:new v(g)}))}else if(y.programId===At.AMM_STABLE.toBase58()){let b=y;a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.authority),isWritable:!1})),a.push(P({pubkey:new v(b.marketProgramId),isWritable:!1})),a.push(P({pubkey:new v(b.marketAuthority),isWritable:!1})),a.push(P({pubkey:yr,isWritable:!1})),a.push(P({pubkey:new v(b.openOrders)})),a.push(P({pubkey:new v(b.vault.A)})),a.push(P({pubkey:new v(b.vault.B)})),a.push(P({pubkey:new v(b.marketId)})),a.push(P({pubkey:new v(b.marketBids)})),a.push(P({pubkey:new v(b.marketAsks)})),a.push(P({pubkey:new v(b.marketEventQueue)})),a.push(P({pubkey:new v(b.marketBaseVault)})),a.push(P({pubkey:new v(b.marketQuoteVault)}))}else if(y.programId===At.AMM_V4.toBase58()){let b=y;a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.authority),isWritable:!1})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.vault.A)})),a.push(P({pubkey:new v(b.vault.B)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(b.id)}))}else if(y.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()){let b=y;a.push(P({pubkey:new v(b.authority)})),a.push(P({pubkey:new v(b.config.id)})),a.push(P({pubkey:new v(b.id)})),a.push(P({pubkey:new v(f?b.vault.A:b.vault.B)})),a.push(P({pubkey:new v(f?b.vault.B:b.vault.A)})),a.push(P({pubkey:new v(b.observationId)}))}else throw Error("pool type error")}let u=E([q("insId"),w("amountIn"),w("amountOut"),H(te(),s.length,"clmmPriceLimit")]),l=Buffer.alloc(u.span);return u.encode({insId:1,amountIn:new ln(i.data.otherAmountThreshold),amountOut:new ln(i.data.outputAmount),clmmPriceLimit:s},l),new Mo({keys:a,programId:r,data:l})}var xn=new os(0),vo=class extends Me{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(Z));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1,feePayer:o}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(o);a.addCustomComputeBudget(e.computeBudgetConfig);let c=ee(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[wn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[wn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:i})}async wrapWSol(e,t,n,i){let o=this.createTxBuilder(i),s=await vn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return o.addInstruction(s),o.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:o,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,m=u.amount.token.mint.equals(Z),d=l.amount.token.mint.equals(Z),p=u.amount.token.mint,y=l.amount.token.mint,{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?is:ze,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:m?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&c.addInstruction(b),f===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!d)g=this.scope.account.getAssociatedTokenAccount(y,l.amount.token.isToken2022?is:ze);else{let{account:I,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?is:ze,mint:y,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=I,h&&c.addInstruction(h)}d&&c.addInstruction({endInstructions:[wn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:ze})],endInstructionTypes:[X.CloseAccount]});let A;if(e.routeType==="route"){let I=e.middleToken;A=this.scope.account.getAssociatedTokenAccount(I.mint,I.isToken2022?is:ze)}let k=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),T=vl({routeProgram:o,inputMint:p,swapInfo:U(M({},e),{poolInfo:[...e.poolInfoList],poolKey:k,outputMint:y}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:A,destinationToken:g}});if(e.feeConfig!==void 0){let I=this.createTxBuilder();I.addInstruction({instructions:[El(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[X.TransferAmount]}),I.addInstruction(T);let{transactions:h}=s===0?await I.sizeCheckBuildV0():await I.sizeCheckBuild();h.length<2&&c.addInstruction({instructions:[El(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[X.TransferAmount]})}return c.addInstruction(T),s===0?c.sizeCheckBuildV0({computeBudgetConfig:i,address:T.address}):c.sizeCheckBuild({computeBudgetConfig:i,address:T.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Gi,clmm:n=An,cpmm:i=Qi}=e||{},o=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:ei.offsetOf("baseMint"),length:64}}),s=E([N("baseMint"),N("quoteMint")]),a=o.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=E([N("mintA"),N("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:$n.span}],dataSlice:{offset:$n.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),d=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:Jr.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:o}){e=e.toString()===ai.default.toString()?Z:e,t=t.toString()===ai.default.toString()?Z:t;let s={},a={},c={},u=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of o)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),c[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:ze,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let y of p.in)for(let f of p.out)y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:u,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let o=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=Gr(o),a={};Object.values(s).forEach(f=>{i.delete(f.mintA.address),a[f.mintA.address]={address:new ai(f.mintA.address),programId:ze,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(f.mintB.address),a[f.mintB.address]={address:new ai(f.mintB.address),programId:ze,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(c).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(ze)?(i.delete(b),a[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(b),f.mintProgramB.equals(ze)?(i.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let u=await li({connection:this.scope.connection,mints:Array.from(i).map(f=>new ai(f))});a=M(M({},a),u);let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),y=Object.keys(e.routePathDict).reduce((f,b)=>U(M({},f),{[b]:U(M({},e.routePathDict[b]),{mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:o,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:o,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){var g,A,k,T,I,h,S,x,C;let m=l===void 0?new os(0):e.raw.mul(new os(l.feeBps.toNumber())).div(new os(1e4)),d=e.raw.sub(m),p=new Be(e.token,d),y=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},f=U(M({},t),{address:mt(t.address).toString()}),b=[];for(let B of n)try{b.push(U(M({},this.computeAmountOut({itemPool:B,tickCache:s,simulateCache:o,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:p})),{feeConfig:y}))}catch(K){this.logDebug("direct error",B.version,B.id.toString(),K.message)}this.logDebug("direct done");for(let[B,K]of Object.entries(i)){let L={chainId:101,address:B,programId:K.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:K.mDecimals,tags:[],extensions:{}},R=K.in.map(_=>{try{return{pool:_,data:this.computeAmountOut({itemPool:_,tickCache:s,simulateCache:o,chainTime:c,epochInfo:u,slippage:a,outputToken:L,amountIn:p})}}catch(W){this.logDebug("route in error",_.version,_.id.toString(),W.message);return}}).sort((_,W)=>{var Ae,ce,de,Ke;let Y=_===void 0?xn:_.data.amountOut.amount.raw.sub((ce=(Ae=_.data.amountOut.fee)==null?void 0:Ae.raw)!=null?ce:xn),se=W===void 0?xn:W.data.amountOut.amount.raw.sub((Ke=(de=W.data.amountOut.fee)==null?void 0:de.raw)!=null?Ke:xn);return Y.lt(se)?1:-1})[0];if(R===void 0)continue;let V=new Be(Dr(L),R.data.amountOut.amount.raw.sub((A=(g=R.data.amountOut.fee)==null?void 0:g.raw)!=null?A:xn));for(let _ of K.out)try{let W=this.computeAmountOut({itemPool:_,tickCache:s,simulateCache:o,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:V});b.push(U(M({},W),{allTrade:!!(R.data.allTrade&&W.allTrade),amountIn:R.data.amountIn,amountOut:W.amountOut,minAmountOut:W.minAmountOut,currentPrice:void 0,executionPrice:new O(new xt({baseToken:R.data.amountIn.amount.token,denominator:R.data.amountIn.amount.raw,quoteToken:W.amountOut.amount.token,numerator:W.amountOut.amount.raw.sub((T=(k=W.amountOut.fee)==null?void 0:k.raw)!=null?T:xn)}).toFixed()),priceImpact:new O(R.data.priceImpact.add(W.priceImpact).toFixed()),fee:[R.data.fee[0],W.fee[0]],routeType:"route",poolInfoList:[R.pool,_],remainingAccounts:[R.data.remainingAccounts[0],W.remainingAccounts[0]],minMiddleAmountFee:(I=W.amountOut.fee)!=null&&I.raw?new Be(R.data.amountOut.amount.token,((S=(h=R.data.amountOut.fee)==null?void 0:h.raw)!=null?S:xn).add((C=(x=W.amountOut.fee)==null?void 0:x.raw)!=null?C:xn)):void 0,middleToken:R.data.amountOut.amount.token,poolReady:R.data.poolReady&&W.poolReady,poolType:[R.data.poolType,W.poolType],feeConfig:y,expirationTime:jt(R.data.expirationTime,W.expirationTime)}))}catch(W){this.logDebug("route out error",_.version,_.id.toString(),W.message)}}return b.filter(B=>(B.allTrade||this.logDebug(`pool ${B.poolInfoList.map(K=>K.id.toString()).join(",")} filter out since not all trade`),B.allTrade)).sort((B,K)=>B.amountOut.amount.raw.sub(K.amountOut.amount.raw).gt(xn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:o,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:A,executionPriceX64:k}=Re.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:o,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new O(y.toFixed()),executionPrice:new O(f.toFixed()),priceImpact:new O(b.toFixed()),fee:[g],remainingAccounts:[A],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:s,clmmExPriceX64:[k],expirationTime:jt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:wo(U(M({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:wo(U(M({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new Be(c.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:wo(U(M({},a),{amount:u})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:wo(U(M({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new Be(c.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(i.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let o=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(o));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Ne(this.scope.connection,Array.from(s).map(l=>({pubkey:new ai(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=Ga.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:ns.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],m={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:U(M({},u.ammConfig),{id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(m)}else if(u.version===4){let l=n[u.id.toString()],m=M({programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:_a({programId:new ai(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint},a[u.marketId]);c.push(m)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Ci(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:yt({address:u.mintLp.toBase58(),programId:ze.toBase58(),decimals:u.lpDecimals}),config:U(M({id:u.configId.toBase58()},u.configInfo),{protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()})})}),c}};import{PublicKey as Zf,Transaction as Ha,TransactionInstruction as $f}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Jf}from"@solana/spl-token";import _l from"bn.js";var bt=class extends Me{static getPdaPoolId(e,t){return ie([bt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,i){return ie([bt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new _l(i).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:i,chainTime:o}){if(n.length===0)return[];let s=n.map(l=>bt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<bt.VERSION_PROJECT.length;l++)a.push(...s.map(m=>bt.getPdaOwnerId(t,m,i,l).publicKey));let c=await Gt(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],y=a[l],f=c[d],b=c[n.length+l];if(!(f&&b)||f.data.length!==bt.POOL_LAYOUT.span||b.data.length!==bt.OWNER_LAYOUT.span)continue;let g=bt.POOL_LAYOUT.decode(f.data),A=bt.OWNER_LAYOUT.decode(b.data),k=g.openTime.toNumber(),T=g.endTime.toNumber(),I=A.tokenInfo.map(x=>x.debtAmount.gt(new _l(0))).filter(x=>!x).length!==3,h=o>k&&o<T&&g.status===1,S=I&&h;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:A.lpAmount,project:bt.VERSION_PROJECT[m],openTime:k,endTime:T,canClaim:S,canClaimErrorType:I?h?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((x,C)=>({mintAddress:x.mintAddress,mintVault:x.mintVault,mintDecimals:x.mintDecimals,perLpLoss:x.perLpLoss,debtAmount:A.tokenInfo[C].debtAmount.add(A.tokenInfo[C].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let i=this.createTxBuilder(n),o=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Ve.WSOL.mint),createInfo:{payer:o,amount:0},skipCloseAccount:!u.mintAddress.equals(Ve.WSOL.mint),associatedOnly:u.mintAddress.equals(Ve.WSOL.mint)?!1:t.associatedOnly});m&&i.addInstruction(m),s.push(l)}i.addInstruction({instructions:[bt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:o,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=i.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let i=this.createTxBuilder(n),o=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let m=[];for(let d of l.tokenInfo){let{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({mint:d.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:d.mintAddress.equals(Ve.WSOL.mint),createInfo:{payer:o,amount:0},skipCloseAccount:!d.mintAddress.equals(Ve.WSOL.mint),associatedOnly:d.mintAddress.equals(Ve.WSOL.mint)?!1:t.associatedOnly});y&&i.addInstruction(y),p&&(s[d.mintAddress.toString()]=p,m.push(p))}i.addInstruction({instructions:[bt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:o,ownerPda:l.ownerAccountId,claimAddress:m}})]})}let{transaction:a,signers:c}=i.build(),u=i.allInstructions;return pr(u,[o,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new Ha().add(...u.slice(0,i.AllTxData.instructions.length-1)),signer:c},{transaction:new Ha().add(...u.slice(i.AllTxData.instructions.length-1)),signer:[]},{transaction:new Ha().add(...i.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let i=E([]),o=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:Jf,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new $f({keys:o,programId:e,data:a})}},Wt=bt;Wt.CLAIMED_NUM=3,Wt.POOL_LAYOUT=E([Te(8),q("bump"),q("status"),w("openTime"),w("endTime"),N("ammId"),H(E([q("mintDecimals"),N("mintAddress"),N("mintVault"),w("perLpLoss"),w("totalClaimedAmount")]),bt.CLAIMED_NUM,"tokenInfo"),H(w(),10,"padding")]),Wt.OWNER_LAYOUT=E([Te(8),q("bump"),q("version"),N("poolId"),N("owner"),w("lpAmount"),H(E([N("mintAddress"),w("debtAmount"),w("claimedAmount")]),bt.CLAIMED_NUM,"tokenInfo"),H(w(),4,"padding")]),Wt.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Zf(e)),Wt.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},Wt.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as _o}from"@solana/web3.js";import Vl from"bn.js";import{SYSVAR_CLOCK_PUBKEY as ey,TransactionInstruction as Ya}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Za}from"@solana/spl-token";var ja=E([q("instruction"),tc("amount")]),Eo=E([q("instruction")]);function IC({programId:r,amount:e,instructionKeys:t}){let n=[{pubkey:sr,isSigner:!1,isWritable:!1},{pubkey:Za,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Cs,isSigner:!1,isWritable:!1},...Object.entries(t).map(([o,s])=>({pubkey:s,isSigner:o==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(o)}))],i=Buffer.alloc(ja.span);return ja.encode({instruction:1,amount:Number(e)},i),new Ya({keys:n,programId:r,data:i})}function rs({programId:r},e){let t=[{pubkey:Za,isSigner:!1,isWritable:!1},{pubkey:Cs,isSigner:!1,isWritable:!1},...Object.entries(e).map(([i,o])=>({pubkey:o,isSigner:i==="userOwner",isWritable:!["authority","userOwner"].includes(i)}))],n=Buffer.alloc(Eo.span);return Eo.encode({instruction:2},n),new Ya({keys:t,programId:r,data:n})}function $a(r){let{poolConfig:e,userKeys:t,side:n}=r,i=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,o=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Eo.span);Eo.encode({instruction:2},s);let a=[{pubkey:Za,isWritable:!1,isSigner:!1},{pubkey:ey,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new Ya({programId:e.programId,keys:a,data:s})}var ty={[ji.IDO_PROGRAM_ID_V1.toString()]:1,[ji.IDO_PROGRAM_ID_V2.toString()]:2,[ji.IDO_PROGRAM_ID_V3.toString()]:3,[ji.IDO_PROGRAM_ID_V4.toString()]:4},Li=class extends Me{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:i=!1,txVersion:o,feePayer:s}){let a=this.createTxBuilder(s),c=ty[t.programId];c||this.logAndCreateError("invalid version",c);let u=Oe(t),[l,m]=[!new Vl(e.coin).isZero(),!new Vl(e.pc).isZero()],d=u.projectInfo.mint.address.equals(Z),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,notUseTokenAccount:d,associatedOnly:d?!1:n,checkCreateATAOwner:i});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&y&&a.addInstruction(y);let f=u.buyInfo.mint.address.equals(Z),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:n,checkCreateATAOwner:i});if(!p&&m&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),m&&g&&a.addInstruction(g),(!p||!b)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[rs({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new _o(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...m?[rs({programId:new _o(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:b,userIdoInfo:new _o(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:o});if(c<3)return!l&&!m&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[rs({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:b,userBaseTokenAccount:p,userIdoInfo:new _o(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:o});let A={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:b,ledgerAccount:new _o(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[$a(U(M({},A),{side:"base"}))]:[],...m?[$a(U(M({},A),{side:"quote"}))]:[]]}).versionBuild({txVersion:o})}};var ny=Buffer.from("vault_auth_seed","utf8"),iy=Buffer.from("global_config","utf8"),oy=Buffer.from("pool","utf8"),ry=Buffer.from("pool_vault","utf8"),sy=Buffer.from("pool_vesting","utf8"),ay=Buffer.from("platform_config","utf8");function Un(r){return ie([ny],r)}function UC(r,e,t,n){return ie([iy,e.toBuffer(),uy(t),_r(n)],r)}function ss(r,e,t){return ie([oy,e.toBuffer(),t.toBuffer()],r)}function Ja(r,e,t){return ie([ry,e.toBuffer(),t.toBuffer()],r)}function uy(r){let e=new ArrayBuffer(1);return new DataView(e).setUint8(0,r),new Uint8Array(e)}function Ri(r){return ie([Buffer.from("__event_authority","utf8")],r)}function eu(r,e){return ie([ay,e.toBuffer()],r)}function Vo(r,e,t){return ie([sy,e.toBuffer(),t.toBuffer()],r)}import{SystemProgram as Fo,TransactionInstruction as mn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Fl}from"@solana/spl-token";import as from"bn.js";var dn={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function Dl(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g,A,k,T,I){let h=E([q("decimals"),Jt("name"),Jt("symbol"),Jt("uri")]),S=E([w("totalLockedAmount"),w("cliffPeriod"),w("unlockPeriod")]),x=E([q("index"),w("supply"),w("totalFundRaisingB"),q("migrateType")]),C=E([q("index"),w("supply"),w("totalSellA"),w("totalFundRaisingB"),q("migrateType")]),B=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:zt,isSigner:!1,isWritable:!1},{pubkey:Fo.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Ri(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}],K=Buffer.alloc(Buffer.from(f,"utf-8").length+Buffer.from(b,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),L=Buffer.alloc(S.span),R=Buffer.alloc(A.type==="ConstantCurve"?C.span:x.span);return h.encode({decimals:y,name:f,symbol:b,uri:g},K),A.type==="ConstantCurve"?C.encode(U(M({index:0},A),{migrateType:A.migrateType==="amm"?0:1}),R):A.type==="FixedCurve"?x.encode(U(M({index:1},A),{migrateType:A.migrateType==="amm"?0:1}),R):A.type==="LinearCurve"&&x.encode(U(M({index:2},A),{migrateType:A.migrateType==="amm"?0:1}),R),S.encode({totalLockedAmount:k,cliffPeriod:T,unlockPeriod:I},L),new mn({keys:B,programId:r,data:Buffer.from([...dn.initialize,...K,...R,...L])})}function Wl(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g){let A=E([w("amountB"),w("minAmountA"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ri(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:y.toString(),minAmountA:f.toString()});let T=Buffer.alloc(A.span);return A.encode({amountB:y,minAmountA:f,shareFeeRate:b!=null?b:new as(0)},T),new mn({keys:k,programId:r,data:Buffer.from([...dn.buyExactIn,...T])})}function JC(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g){let A=E([w("amountA"),w("maxAmountB"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ri(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(A.span);return A.encode({amountA:y,maxAmountB:f,shareFeeRate:b!=null?b:new as(0)},T),new mn({keys:k,programId:r,data:Buffer.from([...dn.buyExactOut,...T])})}function ql(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g){let A=E([w("amountA"),w("minAmountB"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ri(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(A.span);return A.encode({amountA:y,minAmountB:f,shareFeeRate:b!=null?b:new as(0)},T),new mn({keys:k,programId:r,data:Buffer.from([...dn.sellExactIn,...T])})}function e0(r,e,t,n,i,o,s,a,c,u,l,m,d,p,y,f,b,g){let A=E([w("amountB"),w("maxAmountA"),w("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ri(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let T=Buffer.alloc(A.span);return A.encode({amountB:y,maxAmountA:f,shareFeeRate:b!=null?b:new as(0)},T),new mn({keys:k,programId:r,data:Buffer.from([...dn.sellExactOut,...T])})}function tu(r,e,t,n,i,o,s,a,c){let u=E([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:Fo.programId,isSigner:!1,isWritable:!1},{pubkey:Fl,isSigner:!1,isWritable:!1}],m=Buffer.alloc(u.span);return u.encode({},m),new mn({keys:l,programId:r,data:Buffer.from([...dn.claimVestedToken,...m])})}function nu(r,e,t,n,i,o){let s=E([w("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Fo.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:o},c),new mn({keys:a,programId:r,data:Buffer.from([...dn.createVestingAccount,...c])})}function iu(r,e,t,n,i,o,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Fo.programId,isSigner:!1,isWritable:!0},{pubkey:Fl,isSigner:!1,isWritable:!0}];return new mn({keys:u,programId:r,data:dn.claimPlatformFee})}function Ul(r,e,t,n,i,o,s,a,c,u,l){let m=E([w("platformScale"),w("creatorScale"),w("burnScale"),w("feeRate"),Jt("name"),Jt("web"),Jt("img")]),d=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Fo.programId,isSigner:!1,isWritable:!1}],p=Buffer.alloc(8*4+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+Buffer.from(l,"utf-8").length+4*3);return m.encode({platformScale:s.platformScale,creatorScale:s.creatorScale,burnScale:s.burnScale,feeRate:a,name:c,web:u,img:l},p),new mn({keys:d,programId:r,data:Buffer.from([...dn.createPlatformConfig,...p])})}function Gl(r,e,t,n){let i=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],o;if(n.type==="updateClaimFeeWallet"){let s=E([q("index"),N("value")]);o=Buffer.alloc(s.span),s.encode({index:0,value:n.value},o)}else if(n.type==="updateLockNftWallet"){let s=E([q("index"),N("value")]);o=Buffer.alloc(s.span),s.encode({index:1,value:n.value},o)}else if(n.type==="migrateCpLockNftScale"){let s=E([q("index"),w("platformScale"),w("creatorScale"),w("burnScale")]);o=Buffer.alloc(s.span),s.encode(M({index:2},n.value),o)}else if(n.type==="updateFeeRate"){let s=E([q("index"),w("value")]);o=Buffer.alloc(s.span),s.encode({index:3,value:n.value},o)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=E([q("index"),Jt("value")]);o=Buffer.alloc(Buffer.from(n.value,"utf-8").length+4+1*1),n.type==="updateName"?s.encode({index:4,value:n.value},o):n.type==="updateWeb"?s.encode({index:5,value:n.value},o):n.type==="updateImg"&&s.encode({index:6,value:n.value},o)}else if(n.type==="updateCpConfigId"){i.push({pubkey:n.value,isSigner:!1,isWritable:!1});let s=E([q("index")]);o=Buffer.alloc(s.span),s.encode({index:7},o)}else if(n.type==="updateAll"){console.log("Please note that this update will overwrite all data in the platform account with the new data."),i.push({pubkey:n.value.cpConfigId,isSigner:!1,isWritable:!1});let s=E([q("index"),N("platformClaimFeeWallet"),N("platformLockNftWallet"),w("platformScale"),w("creatorScale"),w("burnScale"),w("feeRate"),Jt("name"),Jt("web"),Jt("img")]);o=Buffer.alloc(1+32+32+8*4+4*3+Buffer.from(n.value.name,"utf-8").length+Buffer.from(n.value.web,"utf-8").length+Buffer.from(n.value.img,"utf-8").length),s.encode({index:8,platformClaimFeeWallet:n.value.platformClaimFeeWallet,platformLockNftWallet:n.value.platformLockNftWallet,platformScale:n.value.migrateCpLockNftScale.platformScale,creatorScale:n.value.migrateCpLockNftScale.creatorScale,burnScale:n.value.migrateCpLockNftScale.burnScale,feeRate:n.value.feeRate,name:n.value.name,web:n.value.web,img:n.value.img},o)}else throw Error("updateInfo params type error");return new mn({keys:i,programId:r,data:Buffer.from([...dn.updatePlaformConfig,...o])})}import{NATIVE_MINT as ds,TOKEN_PROGRAM_ID as gt,createAssociatedTokenAccountIdempotentInstruction as Mi}from"@solana/spl-token";import ye from"bn.js";import{PublicKey as Ql}from"@solana/web3.js";var Ni=E([w(),w("epoch"),q("curveType"),$t("index"),w("migrateFee"),w("tradeFeeRate"),w("maxShareFeeRate"),w("minSupplyA"),w("maxLockRate"),w("minSellRateA"),w("minMigrateRateA"),w("minFundRaisingB"),N("mintB"),N("protocolFeeOwner"),N("migrateFeeOwner"),N("migrateToAmmWallet"),N("migrateToCpmmWallet"),H(w(),16)]),cy=E([w("totalLockedAmount"),w("cliffPeriod"),w("unlockPeriod"),w("startTime"),w("totalAllocatedShare")]),Sn=E([w(),w("epoch"),q("bump"),q("status"),q("mintDecimalsA"),q("mintDecimalsB"),q("migrateType"),w("supply"),w("totalSellA"),w("virtualA"),w("virtualB"),w("realA"),w("realB"),w("totalFundRaisingB"),w("protocolFee"),w("platformFee"),w("migrateFee"),cy.replicate("vestingSchedule"),N("configId"),N("platformId"),N("mintA"),N("mintB"),N("vaultA"),N("vaultB"),N("creator"),H(w(),8)]),i0=E([w(),w("epoch"),N("poolId"),N("beneficiary"),w("claimedAmount"),w("tokenShareAmount"),H(w(),8)]),us=E([w(),w("epoch"),N("platformClaimFeeWallet"),N("platformLockNftWallet"),w("platformScale"),w("creatorScale"),w("burnScale"),w("feeRate"),H(q(),64,"name"),H(q(),256,"web"),H(q(),256,"img"),N("cpConfigId"),H(q(),224)]);import pn from"bn.js";import Do from"bn.js";var Gn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:o,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:o}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var cs=class extends Gn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(t.toString()).div(e.toString()).mul(10**(n-i))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:o,decimalA:s,decimalB:a}){return new O(i.sub(o).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),o=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB.add(o)).toString()).div(e.virtualA.sub(e.realA.add(i)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:o}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(i);if(s.lte(new Do(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(o);if(a.lte(new Do(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new Do(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),m=t.mul(t).div(u);if(l.lt(new Do(0))||m.lt(new Do(0)))throw Error("invalid input 0");return{a:l,b:m,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let i=e.mul(n),o=t.add(e);return i.div(o)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let i=t.mul(e),o=n.sub(e);return br(i,o)}};import Xl from"bn.js";var ls=class extends Gn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(t.toString()).div(e.toString()).mul(10**(n-i))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:o,decimalA:s,decimalB:a}){return new O(i.sub(o).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),o=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB).add(o).toString()).div(e.virtualA.sub(e.realA).add(i).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:o}){let s=e.sub(i);if(s.lte(new Xl(0)))throw Error("invalid input 1");let a=new Xl(2).mul(t).sub(o),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let i=t.mul(e);return br(i,n)}};import Lt from"bn.js";import Oi from"bn.js";var Wo=class{static _multipler(e){return new O(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new O(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let i=e.mul(this._multipler(n)).div(this._multipler(t));return new Oi(i.mul(this._Q64).toFixed(0))}};Wo._Q64=new O(new Oi(1).shln(64).toString());function k0({supply:r,totalFundRaisingB:e,totalLockedAmount:t,totalSellA:n,migrateType:i,decimalsA:o}){let s=r.sub(n).sub(t),a=new Oi(new O(s.mul(e).toString()).sqrt().toFixed(0));if(i==="amm"){if(a.gt(new Oi(10).pow(new Oi(o))))return!0}else if(i==="cpmm"){if(a.gt(new Oi(100)))return!0}else throw Error("migrate type error");return!1}var ms=class extends Gn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new O(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i}){return new O(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new O(e.virtualA.mul(e.realA).toString()).div(Wo._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:i,migrateFee:o,decimalA:s,decimalB:a}){return new O(i.sub(o).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let i=e.totalSellA.sub(e.realA),o=e.totalFundRaisingB.sub(e.realB);return new O(e.virtualB.add(e.realB).add(o).toString()).div(e.virtualA.sub(e.realA).add(i).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,migrateFee:o}){let s=e.sub(i);if(s.lte(new Lt(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new Lt(3)).sub(o),u=t.mul(new Lt(2)).mul(s).div(a),l=u.mul(u),m=t.mul(new Lt(2)).mul(Ye).div(l);if(!m.gt(new Lt(0)))throw Error("a need gt 0");if(!mo.gt(m))throw Error("a need lt u64 max");return{a:m,b:new Lt(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),i=new Lt(2).mul(n).mul(Ye).div(e.virtualA);return new Lt(new O(i.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),i=n.mul(n),{div:o,mod:s}=e.virtualA.mul(i).divmod(new Lt(2).mul(Ye));return(s.isZero()?o:o.add(new Lt(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),i=n.mul(n),{div:o,mod:s}=e.virtualA.mul(i).divmod(new Lt(2).mul(Ye)),a=s.isZero()?o:o.add(new Lt(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),i=new Lt(2).mul(n).mul(Ye).div(e.virtualA),o=new Lt(new O(i.toString()).sqrt().toFixed(0));return e.realA.sub(o)}};var fn=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:i,totalSell:o,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),m=l.getInitParam({supply:n,totalFundRaising:i,totalSell:o,totalLockedAmount:s,migrateFee:a}),d=l.getPoolInitPriceByInit(U(M({},m),{decimalA:c,decimalB:u})),p=i.div(new pn(t-1)),y=new pn(0),f=[{price:d,totalSellSupply:0}],{a:b,b:g}=m,A=y,k=y;for(let T=1;T<t;T++){let I=T!==t-1?p:i.sub(k),h=this.buyExactIn({poolInfo:{virtualA:b,virtualB:g,realA:A,realB:k,totalFundRaisingB:i,totalSellA:o},amountB:I,protocolFeeRate:y,platformFeeRate:y,curveType:e,shareFeeRate:y});A=A.add(h.amountA),k=k.add(h.amountB);let S=this.getPrice({poolInfo:{virtualA:b,virtualB:g,realA:A,realB:k},decimalA:c,decimalB:u,curveType:e});f.push({price:S,totalSellSupply:new O(A.toString()).div(10**c).toNumber()})}return f}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:i}){return this.getCurve(i).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i,curveType:o}){return this.getCurve(o).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:i})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:i})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:i})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:i}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:i})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:i,decimals:o,config:s,migrateType:a}){if(Number(o)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(Yt).lt(i))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new pn(10**o))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(Yt);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(i),m=e.mul(s.minMigrateRateA).div(Yt);if(l.lt(m))throw Error("migrate lt min migrate amount");let d=e.sub(n).sub(i),p=new pn(new O(d.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let y=new pn(10).pow(new pn(o));if(p.lte(y))throw Error("check migrate lp error")}else if(a==="cpmm"){let y=new pn(100);if(p.lte(y))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:i,curveType:o,shareFeeRate:s}){let a=n.add(s).add(i),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(o),m=l.buyExactIn({poolInfo:e,amount:u}),d=e.totalSellA.sub(e.realA),p,y,f;if(m.gt(d)){p=d;let g=l.buyExactOut({poolInfo:e,amount:p});y=this.calculatePreFee({postFeeAmount:g,feeRate:a}),f=y.sub(g)}else p=m,y=t,f=c;let b=this.splitFee({totalFee:f,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:p,amountB:y,splitFee:b}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:i,curveType:o,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(o).buyExactOut({poolInfo:e,amount:t}),m=n.add(s).add(i),d=this.calculatePreFee({postFeeAmount:l,feeRate:m}),p=d.sub(l),y=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:c,amountB:d,splitFee:y}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:i,curveType:o,shareFeeRate:s}){let c=this.getCurve(o).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(i)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:i,curveType:o,shareFeeRate:s}){let a=n.add(s).add(i),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),m=fn.getCurve(o).sellExactOut({poolInfo:e,amount:c});if(m.gt(e.realA))throw Error();let d=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:i,shareFeeRate:s});return{amountA:m,amountB:t,splitFee:d}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:i}){let o=t.add(n).add(i),s=o.isZero()?new pn(0):e.mul(n).div(o),a=o.isZero()?new pn(0):e.mul(i).div(o),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return cr(e,t,Yt)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(Yt),i=Yt.sub(t);return n.add(i).sub(new pn(1)).div(i)}static getCurve(e){switch(e){case 0:return cs;case 1:return ls;case 2:return ms}throw Error("find curve error")}};var ui={initPriceX64:new ye("515752397214619"),supply:new ye(1e15),totalSellA:new ye(7931e11),totalFundRaisingB:new ye(85e9),totalLockedAmount:new ye("0"),cliffPeriod:new ye("0"),unlockPeriod:new ye("0"),decimals:6,virtualA:new ye("1073471847374405"),virtualB:new ye("30050573465"),realA:new ye(0),realB:new ye(0),protocolFee:new ye(0),platformId:new Ql("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new ye(0),cliffPeriod:new ye(0),unlockPeriod:new ye(0),startTime:new ye(0),totalAllocatedShare:new ye(0)}},ps=new ye(1e4),qo=class extends Me{constructor(e){super(e)}async createLaunchpad(C){var B=C,{programId:e=Nt,authProgramId:t,platformId:n=ui.platformId,mintA:i,decimals:o=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:m,configInfo:d,platformFeeRate:p,txVersion:y,computeBudgetConfig:f,txTipConfig:b,feePayer:g,buyAmount:A,minMintAAmount:k,slippage:T,associatedOnly:I=!0,checkCreateATAOwner:h=!1,extraSigners:S}=B,x=De(B,["programId","authProgramId","platformId","mintA","decimals","mintBDecimals","name","symbol","uri","migrateType","configId","configInfo","platformFeeRate","txVersion","computeBudgetConfig","txTipConfig","feePayer","buyAmount","minMintAAmount","slippage","associatedOnly","checkCreateATAOwner","extraSigners"]);var $e,ci,Go,Xo,vi,Ei;let K=this.createTxBuilder(g);t=t!=null?t:Un(e).publicKey;let L=d;if(!L&&m){let Rt=await this.scope.connection.getAccountInfo(m);Rt&&(L=Ni.decode(Rt.data))}L||this.logAndCreateError("config not found");let R=L.mintB,V=L.curveType,{publicKey:_}=ss(e,i,R),{publicKey:W}=Ja(e,_,i),{publicKey:Y}=Ja(e,_,R),{publicKey:se}=hn(i);console.log(`create token: ${i.toBase58()}, mintB: ${R.toBase58()}, decimals A:${o}/B:${s}, config:${m.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),A.lte(new ye(0))&&this.logAndCreateError("buy amount should gt 0:",A.toString());let Ae=($e=x==null?void 0:x.supply)!=null?$e:ui.supply,ce=(ci=x==null?void 0:x.totalSellA)!=null?ci:ui.totalSellA,de=(Go=x==null?void 0:x.totalFundRaisingB)!=null?Go:ui.totalFundRaisingB,Ke=(Xo=x==null?void 0:x.totalLockedAmount)!=null?Xo:new ye(0),Ze=p;if(!p){let Rt=await this.scope.connection.getAccountInfo(n);Rt||this.logAndCreateError("platform id not found:",n.toString()),Ze=us.decode(Rt.data).feeRate}let Pt=fn.getCurve(L.curveType).getInitParam({supply:Ae,totalFundRaising:de,totalSell:ce,totalLockedAmount:Ke,migrateFee:L.migrateFee}),Ue={epoch:new ye(896),bump:254,status:0,mintDecimalsA:o,mintDecimalsB:s,supply:Ae,totalSellA:ce,mintA:new Ql(i),mintB:R,virtualA:Pt.a,virtualB:Pt.b,realA:ui.realA,realB:ui.realB,migrateFee:L.migrateFee,migrateType:l==="amm"?0:1,protocolFee:ui.protocolFee,platformFee:Ze,platformId:n,configId:m,vaultA:W,vaultB:Y,creator:this.scope.ownerPubKey,totalFundRaisingB:de,vestingSchedule:{totalLockedAmount:Ke,cliffPeriod:new ye(0),unlockPeriod:new ye(0),startTime:new ye(0),totalAllocatedShare:new ye(0)}},lt=fn.getCurve(L.curveType),{c:nn}=lt.getInitParam({supply:Ue.supply,totalFundRaising:Ue.totalFundRaisingB,totalLockedAmount:Ke,totalSell:L.curveType===0?Ue.totalSellA:new ye(0),migrateFee:L.migrateFee});try{fn.checkParam({supply:Ue.supply,totalFundRaising:Ue.totalFundRaisingB,totalSell:nn,totalLockedAmount:Ke,decimals:Ue.mintDecimalsA,config:L,migrateType:l}),console.log("check init params success")}catch(Rt){this.logAndCreateError(`check create mint params failed, ${Rt.message}`)}K.addInstruction({instructions:[Dl(e,g!=null?g:this.scope.ownerPubKey,this.scope.ownerPubKey,m,n,t,_,i,R,W,Y,se,gt,gt,o,a,c,u||"https://",{type:V===0?"ConstantCurve":V===1?"FixedCurve":V===2?"LinearCurve":"ConstantCurve",totalSellA:ce,migrateType:l,supply:Ae,totalFundRaisingB:de},Ke,(vi=x==null?void 0:x.cliffPeriod)!=null?vi:new ye(0),(Ei=x==null?void 0:x.unlockPeriod)!=null?Ei:new ye(0))]});let yn=new ye(0),Ut;if(S!=null&&S.length&&K.addInstruction({signers:S}),!x.createOnly){let{builder:Rt,extInfo:Qo}=await this.buyToken({programId:e,authProgramId:t,mintA:i,mintB:R,poolInfo:Ue,buyAmount:A,minMintAAmount:k,shareFeeRate:x.shareFeeRate,shareFeeReceiver:x.shareFeeReceiver,configInfo:L,platformFeeRate:Ze,slippage:T,associatedOnly:I,checkCreateATAOwner:h});K.addInstruction(M({},Rt.AllTxData)),yn=Qo.outAmount,Ut=(this.scope.cluster==="devnet"||y===1)&&x.shareFeeReceiver?[Rt.allInstructions[0]]:void 0}return K.addTipInstruction(b),y===0?K.sizeCheckBuildV0({computeBudgetConfig:f,outAmount:yn,splitIns:Ut,address:U(M({},Ue),{poolId:_})}):K.sizeCheckBuild({computeBudgetConfig:f,outAmount:yn,splitIns:Ut,address:U(M({},Ue),{poolId:_})})}async buyToken({programId:e=Nt,authProgramId:t,mintA:n,mintB:i=ds,poolInfo:o,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,buyAmount:d,minMintAAmount:p,slippage:y,shareFeeRate:f=new ye(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:A=!1}){d.lte(new ye(0))&&this.logAndCreateError("buy amount should gt 0:",d.toString());let k=this.createTxBuilder(m),{publicKey:T}=ss(e,n,i);t=t!=null?t:Un(e).publicKey;let I=null,h=null,S=i.equals(ds),{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:A});x&&(I=x),k.addInstruction(C||{}),I===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:B,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:i,owner:this.scope.ownerPubKey,createInfo:S?{payer:this.scope.ownerPubKey,amount:d}:void 0,skipCloseAccount:!S,notUseTokenAccount:S,associatedOnly:S?!1:g,checkCreateATAOwner:A});B&&(h=B),k.addInstruction(K||{}),h===void 0&&this.logAndCreateError(`cannot found mintB(${i.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let L=o;if(!L){let ce=await this.scope.connection.getAccountInfo(T,{commitment:"processed"});ce||this.logAndCreateError("cannot found pool:",T.toBase58()),L=Sn.decode(ce.data)}let R=s,V=await Ne(this.scope.connection,[R?void 0:L.configId,a?void 0:L.platformId].filter(Boolean).map(ce=>({pubkey:ce})));if(!R){let ce=V.find(de=>de.pubkey.equals(L.configId));(!ce||!ce.accountInfo)&&this.logAndCreateError("config not found: ",L.configId.toBase58()),R=Ni.decode(ce.accountInfo.data)}if(!a){let ce=V.find(de=>de.pubkey.equals(L.platformId));(!ce||!ce.accountInfo)&&this.logAndCreateError("platform info not found: ",L.configId.toBase58()),a=us.decode(ce.accountInfo.data).feeRate}let _=fn.buyExactIn({poolInfo:L,amountB:d,protocolFeeRate:R.tradeFeeRate,platformFeeRate:a,curveType:R.curveType,shareFeeRate:f}),W=new O(_.amountA.toString()),Y=y?new O(ps.sub(y).toNumber()/ps.toNumber()).clampedTo(0,1):new O(1),se=p!=null?p:y?new ye(W.mul(Y).toFixed(0)):_.amountA;_.amountB.lt(d)&&console.log(`maximum ${n.toBase58()} amount can buy is ${_.amountA.toString()}, input ${i.toBase58()} amount: ${_.amountB.toString()}`);let Ae=b?J(b,i,gt).publicKey:void 0;return Ae&&k.addInstruction({instructions:[Mi(this.scope.ownerPubKey,Ae,b,i)]}),k.addInstruction({instructions:[Wl(e,this.scope.ownerPubKey,t,L.configId,L.platformId,T,I,h,L.vaultA,L.vaultB,n,i,gt,gt,_.amountB.lt(d)?_.amountB:d,se,f,Ae)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:se}})}async sellToken({programId:e=Nt,authProgramId:t,mintA:n,mintB:i=ds,poolInfo:o,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,sellAmount:d,minAmountB:p,slippage:y,shareFeeRate:f=new ye(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:A=!1}){t=t!=null?t:Un(e).publicKey;let k=this.createTxBuilder(m);d.lte(new ye(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:T}=ss(e,n,i),I=null,h=null,S=i.equals(ds),{account:x,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:A});x&&(I=x),k.addInstruction(C||{}),I===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:B,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:i,owner:this.scope.ownerPubKey,createInfo:S?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!S,notUseTokenAccount:S,associatedOnly:S?!1:g,checkCreateATAOwner:A});B&&(h=B),k.addInstruction(K||{}),h===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let L=o;if(!L){let ce=await this.scope.connection.getAccountInfo(T,{commitment:"processed"});ce||this.logAndCreateError("cannot found pool",T.toBase58()),L=Sn.decode(ce.data)}let R=s,V=await Ne(this.scope.connection,[R?void 0:L.configId,a?void 0:L.platformId].filter(Boolean).map(ce=>({pubkey:ce})));if(!R){let ce=V.find(de=>de.pubkey.equals(L.configId));(!ce||!ce.accountInfo)&&this.logAndCreateError("config not found: ",L.configId.toBase58()),R=Ni.decode(ce.accountInfo.data)}if(!a){let ce=V.find(de=>de.pubkey.equals(L.platformId));(!ce||!ce.accountInfo)&&this.logAndCreateError("platform info not found: ",L.configId.toBase58()),a=us.decode(ce.accountInfo.data).feeRate}let _=fn.sellExactIn({poolInfo:L,amountA:d,protocolFeeRate:R.tradeFeeRate,platformFeeRate:a,curveType:R.curveType,shareFeeRate:f}),W=new O(_.amountB.toString()),Y=y?new O(ps.sub(y).toNumber()/ps.toNumber()).clampedTo(0,1):new O(1),se=p!=null?p:y?new ye(W.mul(Y).toFixed(0)):_.amountB;se.lte(new ye(0))&&this.logAndCreateError(`out ${i.toBase58()} amount should be gt 0`);let Ae=b?J(b,i,gt).publicKey:void 0;return Ae&&k.addInstruction({instructions:[Mi(this.scope.ownerPubKey,Ae,b,i)]}),k.addInstruction({instructions:[ql(e,this.scope.ownerPubKey,t,L.configId,L.platformId,T,I,h,L.vaultA,L.vaultB,n,i,gt,gt,_.amountA.lt(d)?_.amountA:d,se,f,Ae)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:se}})}async createPlatformConfig({programId:e=Nt,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:i,cpConfigId:o,migrateCpLockNftScale:s,feeRate:a,name:c,web:u,img:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:y}){let f=this.createTxBuilder(y),{publicKey:b}=eu(e,t);return f.addInstruction({instructions:[Ul(e,t,n,i,b,o,s,a,c,u,l)]}),f.addCustomComputeBudget(d),f.addTipInstruction(p),f.versionBuild({txVersion:m,extInfo:{platformId:b}})}async updatePlatformConfig({programId:e=Nt,platformAdmin:t,platformId:n,updateInfo:i,txVersion:o,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n!=null?n:eu(e,t).publicKey;return u.addInstruction({instructions:[Gl(e,t,l,i)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:o})}async claimPlatformFee({programId:e=Nt,authProgramId:t,platformId:n,poolId:i,platformClaimFeeWallet:o,mintB:s,vaultB:a,mintBProgram:c=gt,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}){var g;let p=this.createTxBuilder(d);t=t!=null?t:Un(e).publicKey;let y=s,f=a;if(!y){let A=await this.scope.connection.getAccountInfo(i,{commitment:"processed"});A||this.logAndCreateError("cannot found pool:",i.toBase58());let k=Sn.decode(A.data),T=await this.scope.connection.getAccountInfo(k.configId,{commitment:"processed"});T||this.logAndCreateError("cannot found config:",k.configId.toBase58()),y=Ni.decode(T.data).mintB,f=f!=null?f:k.vaultB}(!y||!f)&&this.logAndCreateError("cannot found mint info, mintB: ",y.toBase58(),", vaultB: ",(g=f==null?void 0:f.toBase58())!=null?g:"");let b=J(this.scope.ownerPubKey,y,gt).publicKey;return p.addInstruction({instructions:[Mi(this.scope.ownerPubKey,b,this.scope.ownerPubKey,y)]}),p.addInstruction({instructions:[iu(e,o,t,i,n,f,b,y,c)]}),p.addCustomComputeBudget(l),p.addTipInstruction(m),p.versionBuild({txVersion:u})}async claimAllPlatformFee({programId:e=Nt,authProgramId:t,platformId:n,platformClaimFeeWallet:i,txVersion:o,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c);return t=t!=null?t:Un(e).publicKey,(await this.scope.connection.getProgramAccounts(e,{filters:[{dataSize:Sn.span},{memcmp:{offset:Sn.offsetOf("platformId"),bytes:n.toString()}}]})).forEach(m=>{let d=Sn.decode(m.account.data);if(d.platformFee.lte(new ye(0)))return;let p=J(this.scope.ownerPubKey,d.mintB,gt).publicKey;u.addInstruction({instructions:[Mi(this.scope.ownerPubKey,p,this.scope.ownerPubKey,d.mintB)]}),u.addInstruction({instructions:[iu(e,i,t,m.pubkey,n,d.vaultB,p,d.mintB,gt)]})}),u.addTipInstruction(a),o===0?u.sizeCheckBuildV0({computeBudgetConfig:s}):u.sizeCheckBuild({computeBudgetConfig:s})}async createVesting({programId:e=Nt,poolId:t,beneficiary:n,shareAmount:i,txVersion:o,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=await this.getRpcPoolInfo({poolId:t});i.add(l.vestingSchedule.totalAllocatedShare).gt(l.vestingSchedule.totalLockedAmount)&&this.logAndCreateError("share amount exceed total locked amount");let m=Vo(e,t,n).publicKey;return u.addInstruction({instructions:[nu(e,this.scope.ownerPubKey,n,t,m,i)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:o})}async createMultipleVesting({programId:e=Nt,poolId:t,beneficiaryList:n,txVersion:i,computeBudgetConfig:o,feePayer:s}){let a=this.createTxBuilder(s);n.length===0&&this.logAndCreateError("beneficiaryList is null");let c=await this.getRpcPoolInfo({poolId:t});return n.reduce((l,m)=>l.add(m.shareAmount),c.vestingSchedule.totalAllocatedShare).gt(c.vestingSchedule.totalLockedAmount)&&this.logAndCreateError("share amount exceed total locked amount"),n.forEach(l=>{let m=Vo(e,t,l.wallet).publicKey;a.addInstruction({instructions:[nu(e,this.scope.ownerPubKey,l.wallet,t,m,l.shareAmount)]})}),i===0?a.sizeCheckBuildV0({computeBudgetConfig:o}):a.sizeCheckBuild({computeBudgetConfig:o})}async claimVesting({programId:e=Nt,poolId:t,poolInfo:n,vestingRecord:i,txVersion:o,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=Un(e).publicKey,m=i||Vo(e,t,this.scope.ownerPubKey).publicKey,d=n;if(!d){let y=await this.scope.connection.getAccountInfo(t);y||this.logAndCreateError("pool not found"),d=Sn.decode(y.data)}let p=J(this.scope.ownerPubKey,d.mintA,gt).publicKey;return u.addInstruction({instructions:[Mi(this.scope.ownerPubKey,p,this.scope.ownerPubKey,d.mintA)]}),u.addInstruction({instructions:[tu(e,this.scope.ownerPubKey,l,t,m,p,d.vaultA,d.mintA,gt)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:o})}async claimMultiVesting({programId:e=Nt,poolIdList:t,poolsInfo:n={},vestingRecords:i={},txVersion:o,computeBudgetConfig:s,feePayer:a}){let c=this.createTxBuilder(a),u=M({},n),l=Un(e).publicKey,m=t.filter(d=>!u[d.toBase58()]);if(m.length){let d=await this.getRpcPoolsInfo({poolIdList:m});u=M(M({},u),d.poolInfoMap)}return t.forEach(d=>{let p=d.toBase58(),y=u[p];y||this.logAndCreateError(`pool info not found: ${p}`);let f=i[p]||Vo(e,d,this.scope.ownerPubKey).publicKey,b=J(this.scope.ownerPubKey,y.mintA,gt).publicKey;c.addInstruction({instructions:[Mi(this.scope.ownerPubKey,b,this.scope.ownerPubKey,y.mintA)]}),c.addInstruction({instructions:[tu(e,this.scope.ownerPubKey,l,d,f,b,y.vaultA,y.mintA,gt)]})}),o===0?c.sizeCheckBuildV0({computeBudgetConfig:s}):c.sizeCheckBuild({computeBudgetConfig:s})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Ne(this.scope.connection,e.map(c=>({pubkey:c})),t),i={},o=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=Sn.decode(u.accountInfo.data);i[e[c].toBase58()]=U(M({},l),{poolId:u.accountInfo.owner}),o.push(l.configId)}let s=await Ne(this.scope.connection,o.map(c=>({pubkey:c})),t),a={};for(let c=0;c<o.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+o[c].toBase58());let l=Ni.decode(u.accountInfo.data);a[o[c].toBase58()]=U(M({},l),{configId:u.accountInfo.owner})}return{poolInfoMap:Object.keys(i).reduce((c,u)=>U(M({},c),{[u]:U(M({},i[u]),{configInfo:a[i[u].configId.toBase58()]})}),{})}}};import{PublicKey as ly}from"@solana/web3.js";import{MintLayout as my,TOKEN_2022_PROGRAM_ID as ou,TOKEN_PROGRAM_ID as ru}from"@solana/spl-token";var Uo=class extends Me{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Set;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:i="strict"}=t||{},{mintList:o,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),c=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(s),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(sn.address,sn),this._mintGroup.official.add(sn.address),o.forEach(u=>{var l;this._blackTokenMap.has(u.address)||(this._tokenMap.set(u.address,U(M({},u),{type:"raydium",priority:2,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?ou.toBase58():ru.toBase58()})),this._mintGroup.official.add(u.address))}),c.forEach(u=>{var l;this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,U(M({},u),{type:"jupiter",priority:1,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?ou.toBase58():ru.toBase58(),tags:u.freezeAuthority?[...u.tags||[],"hasFreeze"]:u.tags})),this._mintGroup.jup.add(u.address))}),this._extraTokenList.forEach(u=>{this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,U(M({},u),{type:"extra",priority:1,programId:u.programId||u.tags.includes("token-2022")?ou.toBase58():ru.toBase58()})),this._mintGroup.extra.add(u.address))}),this._tokenList=Array.from(this._tokenMap).map(u=>u[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),i=this._tokenMap.get(n);if(i)return i;if(n.toLocaleUpperCase()==="SOL")return sn;let o=(await this.scope.api.getTokenInfo([n]))[0];if(o)return this._mintGroup.extra.add(n),this._tokenMap.set(n,U(M({},o),{priority:2})),o;let s=await this.scope.connection.getAccountInfo(new ly(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=my.decode(s.data),c=n.toString().substring(0,6),u={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:c,name:c,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,u),u}};var fs=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:i,api:o,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=i?new Ht(i):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=o,this._apiCacheTime=c||5*60*1e3,this.logger=fe("Raydium"),this.farm=new lo({scope:this,moduleName:"Raydium_Farm"}),this.account=new eo({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new Bo({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Uo({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new vo({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new So({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new No({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Wt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Si({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new Li({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new qo({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let m=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:m,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=dy({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:i,logCount:o,logRequests:s,urlConfigs:a}=t,c=new Tr({cluster:n,timeout:i,urlConfigs:a,logCount:o,logRequests:s}),u=new fs(U(M({},t),{api:c}));return await u.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(Ir);return this._owner.publicKey}setOwner(e){return this._owner=e?new Ht(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(zu);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(Ir),new Error(Ir)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(i=>U(M({},i),{mintAuthority:i.mint_authority||void 0,freezeAuthority:i.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var _1=r=>r;export{qp as AMM_CONFIG_SEED,Nc as BIT_PRECISION,So as Clmm,zc as ClmmConfigLayout,Se as ClmmInstrument,Hr as ConstantProductCurve,Cl as CpmmConfigInfoLayout,jr as CpmmFee,Jr as CpmmPoolInfoLayout,fn as Curve,Gn as CurveBase,Zr as CurveCalculator,lf as DataElement,ha as EXTENSION_TICKARRAY_BITMAP_SIZE,Pc as FARM_LOCK_MINT,Ac as FARM_LOCK_VAULT,_t as FARM_PROGRAM_TO_VERSION,kc as FARM_VERSION_TO_LEDGER_LAYOUT,wc as FARM_VERSION_TO_STATE_LAYOUT,Er as FEE_RATE_DENOMINATOR,Zp as FETCH_TICKARRAY_COUNT,Wp as Fee,ls as FixedPriceCurve,ny as LAUNCHPAD_AUTH_SEED,iy as LAUNCHPAD_CONFIG_SEED,ay as LAUNCHPAD_POOL_PLATFORM_SEED,oy as LAUNCHPAD_POOL_SEED,ry as LAUNCHPAD_POOL_VAULT_SEED,sy as LAUNCHPAD_POOL_VESTING_SEED,Wr as LIQUIDITY_FEES_DENOMINATOR,xa as LIQUIDITY_FEES_NUMERATOR,af as LIQUIDITY_VERSION_TO_SERUM_VERSION,hI as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Uf as LOCK_LIQUIDITY_SEED,Oc as LOG_B_2_X32,Mc as LOG_B_P_ERR_MARGIN_LOWER_X64,vc as LOG_B_P_ERR_MARGIN_UPPER_X64,cs as LaunchPadConstantProductCurve,Ni as LaunchpadConfig,Sn as LaunchpadPool,ui as LaunchpadPoolInitParam,i0 as LaunchpadVesting,cy as LaunchpadVestingSchedule,ms as LinearPriceCurve,Pe as LiquidityMath,Yc as LockClPositionLayoutV2,MT as LockPositionLayout,Fa as MARKET_STATE_LAYOUT_V2,Ga as MARKET_STATE_LAYOUT_V3,Ol as MARKET_VERSION_TO_STATE_LAYOUT,Dt as MAX_SQRT_PRICE_X64,vr as MAX_SQRT_PRICE_X64_SUB_ONE,ht as MAX_TICK,Ft as MIN_SQRT_PRICE_X64,Mr as MIN_SQRT_PRICE_X64_ADD_ONE,ft as MIN_TICK,Bi as MODEL_DATA_PUBKEY,ns as Market,Wo as MathLaunch,ue as MathUtil,mo as MaxU64,Rc as MaxUint128,kn as NEGATIVE_ONE,jp as OBSERVATION_SEED,Ot as ONE,zp as OPERATION_SEED,Hc as ObservationInfoLayout,ef as ObservationLayout,jc as OperationLayout,Uc as POOL_LOCK_ID_SEED,Xp as POOL_REWARD_VAULT_SEED,Up as POOL_SEED,Hp as POOL_TICK_ARRAY_BITMAP_SEED,Gp as POOL_VAULT_SEED,Fc as POSITION_SEED,us as PlatformConfig,$n as PoolInfoLayout,Re as PoolUtils,Ti as PositionInfoLayout,nf as PositionRewardInfoLayout,bo as PositionUtils,OT as ProtocolPositionLayout,Or as Q128,Ye as Q64,fs as Raydium,tf as RewardInfo,wl as RoundDirection,Rl as SERUM_PROGRAMID_TO_VERSION,Nl as SERUM_VERSION_TO_PROGRAMID,sn as SOL_INFO,el as SPL_MINT_LAYOUT,Yp as SUPPORT_MINT_SEED,oe as SqrtPriceMath,Ii as StableLayout,Zn as SwapMath,Yn as TICK_ARRAY_BITMAP_SIZE,Qp as TICK_ARRAY_SEED,tt as TICK_ARRAY_SIZE,yh as TICK_SPACINGS,nt as TOKEN_WSOL,Tn as TickArrayBitmap,Qc as TickArrayBitmapExtensionLayout,Po as TickArrayBitmapExtensionUtils,go as TickArrayLayout,of as TickLayout,Jn as TickMath,we as TickQuery,$ as TickUtils,po as U64Resolution,gh as U64_IGNORE_RANGE,bc as Voter,Sp as VoterDepositEntry,xp as VoterLockup,yc as VoterRegistrar,Bp as VoterVotingMintConfig,be as ZERO,La as addLiquidityLayout,dn as anchorDataBuf,ea as associatedLedgerAccountLayout,Wl as buyExactInInstruction,JC as buyExactOutInstruction,pa as calFarmRewardAmount,k0 as checkPoolToAmm,Eo as claimLayout,iu as claimPlatformFee,tu as claimVestedToken,Xc as clmmComputeInfoToApiInfo,wn as closeAccountInstruction,Ua as collectCpFeeInstruction,zf as cpmmLockPositionInstruction,so as createAssociatedLedgerAccountInstruction,Ul as createPlatformConfig,il as createPoolFeeLayout,Ma as createPoolV4InstructionV2,kI as createPoolV4Layout,nu as createVestingAccount,vn as createWSolAccountInstructions,kt as dwLayout,oa as farmAddRewardLayout,zw as farmLedgerLayoutV3_1,no as farmLedgerLayoutV3_2,Hw as farmLedgerLayoutV5_1,pc as farmLedgerLayoutV5_2,fc as farmLedgerLayoutV6_1,Tc as farmRewardInfoToConfig,na as farmRewardLayout,ia as farmRewardRestartLayout,Ip as farmRewardTimeInfoLayout,mc as farmStateV3Layout,dc as farmStateV5Layout,to as farmStateV6Layout,Ak as fetchMultipleFarmInfoAndUpdate,cB as fetchMultipleInfo,Sa as fixedSwapInLayout,Ka as fixedSwapOutLayout,wf as formatLayout,Ge as generatePubKey,hc as getAssociatedAuthority,Ur as getAssociatedConfigId,pt as getAssociatedLedgerAccount,oo as getAssociatedLedgerPoolAccount,Kf as getAssociatedOpenOrders,Va as getAssociatedPoolKeys,Lo as getCpLockPda,uS as getCpmmPdaAmmConfigId,Wa as getCpmmPdaPoolId,hl as getCreatePoolKeys,fa as getDepositEntryIndex,al as getDxByDyBaseIn,sl as getDyByDxBaseIn,wi as getFarmLedgerLayout,Kp as getFarmStateLayout,_a as getLiquidityAssociatedAuthority,ii as getLiquidityAssociatedId,cT as getLiquidityFromAmounts,Ih as getPdaAmmConfigId,Ri as getPdaCpiEvent,Xe as getPdaExBitmapAccount,Un as getPdaLaunchpadAuth,UC as getPdaLaunchpadConfigId,ss as getPdaLaunchpadPoolId,Ja as getPdaLaunchpadVaultId,hi as getPdaLockClPositionIdV2,wa as getPdaLockPositionId,Wf as getPdaLpMint,hn as getPdaMetadataKey,ka as getPdaMintExAccount,qc as getPdaObservationAccount,Co as getPdaObservationId,yo as getPdaOperationAccount,Tt as getPdaPersonalPositionAddress,eu as getPdaPlatformId,Ci as getPdaPoolAuthority,Dc as getPdaPoolId,Wc as getPdaPoolRewardVaulId,Aa as getPdaPoolVaultId,tn as getPdaProtocolPositionAddress,ge as getPdaTickArrayAddress,kl as getPdaVault,Vo as getPdaVestId,aa as getRegistrarAddress,ul as getStablePrice,da as getTokenOwnerRecordAddress,la as getVoterAddress,ma as getVoterWeightRecordAddress,ca as getVotingMintAuthority,ua as getVotingTokenMint,_p as governanceCreateTokenOwnerRecord,Ah as i16ToBytes,Vr as i32ToBytes,Ca as initPoolLayout,$s as initTokenAccountInstruction,Dl as initialize,Nf as initializeMarket,ra as isValidFarmVersion,fo as isZero,wk as judgeFarmType,ga as leadingZeros,Vc as leastSignificantBit,ei as liquidityStateV4Layout,uf as liquidityStateV5Layout,qr as makeAMMSwapInstruction,ml as makeAddLiquidityInstruction,ba as makeAddNewRewardInstruction,rs as makeClaimInstruction,$a as makeClaimInstructionV4,Kl as makeCpmmLockInstruction,Il as makeCreateCpmmPoolInInstruction,Ic as makeCreateFarmInstruction,Xr as makeCreateMarketInstruction,Bc as makeCreatorWithdrawFarmRewardInstruction,Bl as makeDepositCpmmInInstruction,Sc as makeDepositInstructionV3,Kc as makeDepositInstructionV5,Cc as makeDepositInstructionV6,Ek as makeDepositTokenInstruction,Vk as makeDepositWithdrawInstruction,FI as makeInitPoolInstructionV4,IC as makePurchaseInstruction,ya as makeRestartRewardInstruction,dl as makeSimulatePoolInfoInstruction,$r as makeSwapCpmmBaseInInstruction,Sl as makeSwapCpmmBaseOutInstruction,Tf as makeSwapFixedInInstruction,If as makeSwapFixedOutInstruction,vl as makeSwapInstruction,lc as makeTransferInstruction,xl as makeWithdrawCpmmInInstruction,co as makeWithdrawInstructionV3,xc as makeWithdrawInstructionV4,uo as makeWithdrawInstructionV5,ao as makeWithdrawInstructionV6,_k as makeWithdrawTokenInstruction,bh as mockCreatePoolInfo,Ec as mockV3CreatePoolInfo,mf as modelDataInfoLayout,_c as mostSignificantBit,cc as parseTokenAccountResp,aI as parseTokenInfo,_n as poolTypeV6,ja as purchaseLayout,kp as realFarmStateV3Layout,hp as realFarmStateV5Layout,Tp as realFarmV6Layout,Oa as removeLiquidityInstruction,Ra as removeLiquidityLayout,KK as route1Instruction,CK as route2Instruction,Yf as routeInstruction,ql as sellExactInInstruction,e0 as sellExactOut,VI as simulatePoolInfoInstruction,cI as solToWSolToken,en as splAccountLayout,LK as swapBaseInAutoAccount,RK as swapBaseOutAutoAccount,Gr as toAmmComputePoolInfo,yt as toApiV3Token,Vn as toFeeConfig,Dr as toToken,wo as toTokenAmount,uI as toTokenInfo,Pa as trailingZeros,_r as u16ToBytes,wh as u32ToBytes,uy as u8ToBytes,_1 as unionArr,Cp as updateFarmPoolInfo,Gl as updatePlatformConfig,sa as validateFarmRewards,Fp as voterStakeRegistryCreateDepositEntry,Vp as voterStakeRegistryCreateVoter,Mp as voterStakeRegistryDeposit,vp as voterStakeRegistryUpdateVoterWeightRecord,Ep as voterStakeRegistryWithdraw,lI as wSolToSolToken,ta as withdrawRewardLayout};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map